<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€ƒç ”è¯æ±‡å¤§å¸ˆ - è§†è§‰ä¿®å¤ç‰ˆ</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.staticfile.net/lz-string/1.4.4/lz-string.min.js"></script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        .scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        @media (min-width: 768px) { .card-face { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } }
        .card-face-back { transform: rotateY(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…¨å±€ Markdown æ’ç‰ˆç¾åŒ– */
        .markdown-body { font-size: 0.95rem; line-height: 1.7; word-wrap: break-word; overflow-wrap: break-word; }
        .markdown-body > *:first-child { margin-top: 0; }
        .markdown-body p { margin-bottom: 0.8em; }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 800; margin-top: 1.2em; margin-bottom: 0.6em; line-height: 1.3; }
        .markdown-body h1 { font-size: 1.4em; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.2em; }
        .markdown-body h3 { font-size: 1.1em; }
        
        .markdown-body ul { list-style-type: disc; padding-left: 1.4em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.4em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        
        /* ğŸ”¥ é‡ç‚¹ä¿®å¤ï¼šå…¨å±€é«˜äº®æ ·å¼ (å¡ç‰‡èƒŒé¢/é•¿éš¾å¥) */
        /* æ”¹ä¸ºæ·±è‰²æ–‡å­— + æµ…è‰²èƒŒæ™¯ï¼Œå¯¹æ¯”åº¦æé«˜ */
        .markdown-body strong { 
            font-weight: 900; 
            color: #4338ca; /* æ·±é›è“ï¼Œçœ‹å¾—æ¸… */
            background: rgba(99, 102, 241, 0.1); /* ææ·¡çš„è“åº• */
            padding: 0 4px; 
            border-radius: 4px; 
            border-bottom: 2px solid rgba(99, 102, 241, 0.2);
        }
        
        /* å¼•ç”¨å— */
        .markdown-body blockquote { border-left: 4px solid rgba(0,0,0,0.2); padding-left: 1em; margin: 1em 0; font-style: italic; background: rgba(0,0,0,0.03); padding: 8px 12px; border-radius: 0 8px 8px 0; }
        .markdown-body code { background-color: rgba(0,0,0,0.06); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: #c2410c; }

        /* åŠ¨ç”» */
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">èµ„æºåŠ è½½ä¸­...</p>
        </div>
        <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var root = document.getElementById('root');
            if(root) root.innerHTML = '<div style="padding:20px;text-align:center;color:red;"><h3>å‘ç”Ÿé”™è¯¯</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };

        // ğŸ”¥ è‡ªåŠ¨æ¸…ç†ï¼šå¦‚æœæ£€æµ‹åˆ°ä¹‹å‰å®‰è£…è¿‡å¯¼è‡´æ•…éšœçš„ Service Workerï¼Œå¼ºåˆ¶å¸è½½å®ƒ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    console.log('å¸è½½æ—§ç‰ˆ SW:', registration);
                    registration.unregister();
                }
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const Icons = {
            Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            CloudCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 15l2 2 4-4"/><path d="M19 17a5 5 0 0 0 0-10c-5.523 0-10 4.477-10 10"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Maximize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
            Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            MessageCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Palette: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const Svg = Icons[name] || Icons.Book;
            return <span className={`flex justify-center items-center ${className}`} style={{ width: size, height: size }}><Svg /></span>;
        };

        const API_PRESETS = {
            "deepseek": { name: "DeepSeek (æ·±åº¦æ±‚ç´¢)", type: "openai", url: "https://api.deepseek.com" },
            "siliconflow": { name: "SiliconFlow (ç¡…åŸºæµåŠ¨)", type: "openai", url: "https://api.siliconflow.cn/v1" },
            "openai": { name: "OpenAI (å®˜æ–¹)", type: "openai", url: "https://api.openai.com/v1" },
            "moonshot": { name: "Moonshot (Kimi)", type: "openai", url: "https://api.moonshot.cn/v1" },
            "zhipu": { name: "æ™ºè°±AI (GLM)", type: "openai", url: "https://open.bigmodel.cn/api/paas/v4" },
            "aliyun": { name: "é˜¿é‡Œäº‘ (é€šä¹‰åƒé—®)", type: "openai", url: "https://dashscope.aliyuncs.com/compatible-mode/v1" },
            "yi": { name: "é›¶ä¸€ä¸‡ç‰© (Yi)", type: "openai", url: "https://api.lingyiwanwu.com/v1" },
            "google": { name: "Google (Gemini)", type: "google", url: "" },
            "custom": { name: "è‡ªå®šä¹‰ (OpenAIå…¼å®¹)", type: "openai", url: "" }
        };

       const playAudio = (text) => {
            if (text.includes(' ') || text.length > 20) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    u.rate = 0.9;
                    window.speechSynthesis.speak(u);
                }
            } else {
                const audio = new Audio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`);
                audio.play().catch(e => {
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                });
            }
        };

        const calculateNextReview = (rating, currentInterval, easeFactor, currentReviewCount) => {
            let nextInterval, nextEaseFactor = easeFactor;
            const newReviewCount = (currentReviewCount || 0) + 1;
            if (rating === 1) { 
                return { interval: 0, easeFactor: Math.max(1.3, easeFactor - 0.2), isDueNow: true, reviewCount: newReviewCount };
            } else if (rating === 2) { 
                return { interval: 0.5, easeFactor: Math.max(1.3, easeFactor - 0.15), isDueNow: true, reviewCount: newReviewCount }; 
            } else { 
                if (currentInterval === 0) nextInterval = 1; 
                else if (currentInterval === 1) nextInterval = 3;
                else nextInterval = Math.round(currentInterval * easeFactor);
                return { interval: nextInterval, easeFactor: easeFactor + 0.1, isDueNow: false, reviewCount: newReviewCount };
            }
        };

const WordChat = ({ word, words, setWords, onClose, config }) => {
            // ğŸ”¥ 1. çŠ¶æ€å‡çº§ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½â€œé¢œè‰²å†å²åˆ—è¡¨â€
            const [bgColors, setBgColors] = useState(JSON.parse(localStorage.getItem('kaoyan_hist_bg')) || ["#4f46e5", "#ec4899", "#10b981", "#f97316", "#000000", "#ffffff"]);
            const [textColors, setTextColors] = useState(JSON.parse(localStorage.getItem('kaoyan_hist_text')) || ["#ffffff", "#000000", "#fef3c7", "#dbeafe"]);
            const [hlColors, setHlColors] = useState(JSON.parse(localStorage.getItem('kaoyan_hist_hl')) || ["#fbbf24", "#f87171", "#4ade80", "#60a5fa"]);

            // å½“å‰é€‰ä¸­çš„é¢œè‰²
            const [bubbleColor, setBubbleColor] = useState(localStorage.getItem('kaoyan_chat_bg') || "#4f46e5");
            const [textColor, setTextColor] = useState(localStorage.getItem('kaoyan_chat_text') || "#ffffff");
            const [highlightColor, setHighlightColor] = useState(localStorage.getItem('kaoyan_chat_hl') || "#fbbf24");

            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [showColorPicker, setShowColorPicker] = useState(false);
            const messagesEndRef = useRef(null);
            const [playingIdx, setPlayingIdx] = useState(null);
            const audioRef = useRef(null);

            const magicPrompt = `è¯·ä½ ä½œä¸ºä¸“ä¸šçš„è‹±è¯­è¯æ±‡æ•™å¸ˆï¼Œä¸ºè€ƒç ”å­¦ç”Ÿæä¾›å•è¯ "${word}" çš„æ·±åº¦è§£ææœåŠ¡ã€‚éœ€è¦å°†æ¯ä¸ªå•è¯è¿›è¡Œå…¨æ–¹ä½ã€å¤šç»´åº¦ã€æ·±å±‚æ¬¡çš„å‰–æï¼Œç¡®ä¿å­¦ç”Ÿèƒ½å¤ŸçœŸæ­£ç†è§£ã€å°è±¡æ·±åˆ»å¹¶èƒ½å¤Ÿçµæ´»è¿ç”¨ã€‚

é£æ ¼ä¸è¯­æ°”è¦æ±‚
Â· è¯­è¨€é£æ ¼ï¼šè‡ªç„¶ç”ŸåŠ¨ã€å¯Œæœ‰äº²å’ŒåŠ›ï¼Œåƒä¸€ä½ç»éªŒä¸°å¯Œçš„è€å¸ˆåœ¨é¢å¯¹é¢è®²è§£
Â· è¡¨è¾¾æ–¹å¼ï¼šé¿å…æœºæ¢°æ­»æ¿ï¼Œè¦æœ‰æ´»åŠ›ä½†ä¸å¤¸å¼ ï¼Œä¸ä½¿ç”¨è¿‡å¤šæ„Ÿå¹å·
Â· ä¸“ä¸šä¸äº²åˆ‡å¹³è¡¡ï¼šåœ¨ä¿æŒä¸“ä¸šæ·±åº¦çš„åŒæ—¶ï¼Œè®©è¯­è¨€å…·æœ‰ç”Ÿæ´»æ°”æ¯å’Œå¯è¯»æ€§

å†…å®¹ç»“æ„è§„èŒƒ
æ•´ä½“æ¡†æ¶
# ${word} - æ ¸å¿ƒæ„è±¡çš„ç²¾ç‚¼æè¿°
å¼€ç¯‡æ®µè½ï¼šç”¨ç”Ÿæ´»åŒ–çš„è¯­è¨€å¼•å…¥å•è¯ï¼Œå»ºç«‹æƒ…æ„Ÿè¿æ¥ï¼Œæ¦‚æ‹¬å•è¯çš„æ ¸å¿ƒæ„ä¹‰
---
## å•è¯çš„ä¸åŒé¢å‘
### 1. ç¬¬ä¸€ä¸ªä¸»è¦å«ä¹‰
[ç”¨ç”Ÿæ´»å®ä¾‹è®²è§£è¯¥å«ä¹‰]
- ä¾‹å­ï¼š[å…¸å‹ä¾‹å¥ï¼Œå•è¯ç”¨ç²—ä½“æ ‡å‡º]
- è§‚å¯Ÿï¼š[å¯¹ä¾‹å¥çš„æ·±å…¥è§£è¯»å’Œå»¶ä¼¸ç†è§£]
### 2. ç¬¬äºŒä¸ªä¸»è¦å«ä¹‰
[ç»§ç»­ç”¨ç”Ÿæ´»åŒ–è¯­è¨€è®²è§£]
- ä¾‹å­ï¼š[å…¸å‹ä¾‹å¥ï¼Œå•è¯ç”¨ç²—ä½“æ ‡å‡º]
- è§‚å¯Ÿï¼š[å¯¹ä¾‹å¥çš„æ·±å…¥è§£è¯»å’Œå»¶ä¼¸ç†è§£]
[æ ¹æ®å•è¯å®é™…æƒ…å†µç»§ç»­å…¶ä»–å«ä¹‰...]
## è¯æ€§è½¬æ¢ä¸å»¶ä¼¸
**å½“å•è¯å˜åŒ–å½¢å¼æ—¶**ï¼Œè®²è§£å…¶æ„ä¹‰å»¶ä¼¸ï¼š
- å˜åŒ–å½¢å¼1ï¼š[å…·ä½“è®²è§£]
- å˜åŒ–å½¢å¼2ï¼š[å…·ä½“è®²è§£]
## è®°å¿†çš„é’¥åŒ™
ç”¨æ¯”å–»æˆ–å½¢è±¡åŒ–çš„æ–¹å¼æ€»ç»“è®°å¿†è¦ç‚¹ï¼š
- æ ¸å¿ƒæ¯”å–»ï¼š[å°†å•è¯æ¯”ä½œæŸä¸ªå®¹æ˜“ç†è§£çš„äº‹ç‰©]
- å…·ä½“è¯´æ˜ï¼š[è¯¦ç»†è§£é‡Šè¿™ä¸ªæ¯”å–»å¦‚ä½•å¸®åŠ©è®°å¿†]
## å®ç”¨ç»„åˆ
- æ­é…1ï¼š[å…·ä½“æ­é…åŠå…¶ç”¨æ³•è¯´æ˜]
- æ­é…2ï¼š[å…·ä½“æ­é…åŠå…¶ç”¨æ³•è¯´æ˜]

è¯¦ç»†å†…å®¹è¦æ±‚
å¼€ç¯‡éƒ¨åˆ†ï¼š
Â· ç”¨è®¾é—®ã€ç”Ÿæ´»åœºæ™¯æˆ–æœ‰è¶£æ¯”å–»å¼•å…¥å•è¯
Â· ç»™å‡ºå•è¯çš„æ ¸å¿ƒæ„è±¡ç²¾ç‚¼æè¿°
Â· å»ºç«‹ä¸å­¦ç”Ÿå®é™…ç»éªŒçš„è¿æ¥
å«ä¹‰è®²è§£éƒ¨åˆ†ï¼š
Â· æ¯ä¸ªä¸»è¦å«ä¹‰å•ç‹¬æˆèŠ‚
Â· æ¯ä¸ªå«ä¹‰é…ä¸€ä¸ªå…¸å‹ä¾‹å¥ï¼Œä¾‹å¥ä¸­å•è¯ç”¨ç²—ä½“æ ‡å‡º
Â· æ¯ä¸ªä¾‹å¥é…ä¸­æ–‡ç¿»è¯‘
Â· åœ¨"è§‚å¯Ÿ"éƒ¨åˆ†å¯¹ä¾‹å¥è¿›è¡Œæ·±å…¥è§£è¯»ï¼Œæä¾›å»¶ä¼¸ç†è§£
è¯æ€§è½¬æ¢éƒ¨åˆ†ï¼š
Â· é‡ç‚¹è®²è§£å•è¯ä¸åŒè¯æ€§æ—¶çš„æ„ä¹‰å˜åŒ–
Â· å±•ç¤ºå•è¯ç”¨æ³•çš„ä¸°å¯Œæ€§
è®°å¿†æŠ€å·§éƒ¨åˆ†ï¼š
Â· æä¾›ç”ŸåŠ¨å½¢è±¡çš„è®°å¿†æ–¹æ³•
Â· ä½¿ç”¨æ¯”å–»ã€è”æƒ³ç­‰è®°å¿†æŠ€å·§
Â· é¿å…æ¯ç‡¥çš„è¯æ ¹è¯ç¼€åˆ†æ
å®ç”¨æ­é…éƒ¨åˆ†ï¼š
Â· åˆ—å‡º3-4ä¸ªæœ€å¸¸ç”¨çš„æ­é…
Â· å¯¹æ¯ä¸ªæ­é…è¿›è¡Œç®€è¦çš„ç”¨æ³•è¯´æ˜

ç‰¹åˆ«æ³¨æ„äº‹é¡¹
å†…å®¹æ·±åº¦è¦æ±‚
Â· é‡è¦å•è¯ï¼ˆå¤šä¹‰ã€é«˜é¢‘ã€éš¾è¯ï¼‰å•ç‹¬è¯¦ç»†è®²è§£
Â· ç®€å•å•è¯å¯ä»¥æ‰¹é‡å¤„ç†ï¼Œä½†è¦ä¿è¯è®²è§£è´¨é‡
Â· ç¡®ä¿è¦†ç›–å•è¯çš„æ‰€æœ‰é‡è¦å«ä¹‰å’Œç”¨æ³•
Â· æä¾›è¶³å¤Ÿçš„ä¾‹å¥å’Œå®é™…åº”ç”¨åœºæ™¯
æ ¼å¼è¦æ±‚
Â· ä½¿ç”¨Markdownæ ¼å¼
Â· æ¯ä¸ªå•è¯ç‹¬ç«‹æˆç« 
Â· å±‚æ¬¡æ¸…æ™°ï¼Œä¾¿äºå¯¼å…¥Wordæ–‡æ¡£æ•´ç†
Â· é‡ç‚¹å†…å®¹é€‚å½“ä½¿ç”¨ç²—ä½“å¼ºè°ƒ
è´¨é‡æŠŠæ§
Â· é¿å…é—æ¼ä»»ä½•é‡è¦å«ä¹‰
Â· ä¿æŒè®²è§£çš„ä¸€è‡´æ€§å’Œç³»ç»Ÿæ€§
Â· ç¡®ä¿è¯­è¨€çš„è‡ªç„¶æµç•…ï¼Œé¿å…æœºæ¢°æ„Ÿ
Â· åœ¨ä¸“ä¸šæ€§å’Œå¯è¯»æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹`;

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
            
            useEffect(() => {
                const currentWordObj = words.find(w => w.word === word);
                if (currentWordObj && currentWordObj.chatHistory && currentWordObj.chatHistory.length > 0) {
                    setMessages(currentWordObj.chatHistory);
                } else {
                    const initialMsg = {
                        role: "assistant",
                        content: `Hi! æˆ‘æ˜¯ä½ çš„ä¸“å± AI ç§æ•™ã€‚\næˆ‘ä»¬ä»Šå¤©è¦æ­»ç£•çš„å•è¯æ˜¯ï¼š **${word}**ã€‚\n\nç‚¹å‡»å·¦ä¸‹è§’çš„ **ğŸª„** æŒ‰é’®ï¼Œæˆ‘å°†ä¸ºä½ è¿›è¡Œ**å¤§å¸ˆçº§æ·±åº¦è§£æ**ï¼`
                    };
                    setMessages([initialMsg]);
                    saveChatHistory([initialMsg]);
                }
            }, []);

            useEffect(() => { scrollToBottom(); }, [messages]);
            useEffect(() => { return () => stopAudio(); }, []);

            const saveChatHistory = (newMessages) => {
                const newWords = words.map(w => {
                    if (w.word === word) return { ...w, chatHistory: newMessages };
                    return w;
                });
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
            };

            // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šæ›´æ–°é¢œè‰²å¹¶ä¿å­˜åˆ°å†å²åˆ—è¡¨
            const updateColorState = (type, color) => {
                let newList, key;
                if (type === 'bg') {
                    setBubbleColor(color);
                    localStorage.setItem('kaoyan_chat_bg', color);
                    // æŠŠæ–°é¢œè‰²æ’åˆ°æœ€å‰é¢ï¼Œå¹¶å»é‡ï¼Œåªä¿ç•™æœ€è¿‘ 8 ä¸ª
                    newList = [color, ...bgColors.filter(c => c !== color)].slice(0, 8);
                    setBgColors(newList);
                    key = 'kaoyan_hist_bg';
                } else if (type === 'text') {
                    setTextColor(color);
                    localStorage.setItem('kaoyan_chat_text', color);
                    newList = [color, ...textColors.filter(c => c !== color)].slice(0, 8);
                    setTextColors(newList);
                    key = 'kaoyan_hist_text';
                } else {
                    setHighlightColor(color);
                    localStorage.setItem('kaoyan_chat_hl', color);
                    newList = [color, ...hlColors.filter(c => c !== color)].slice(0, 8);
                    setHlColors(newList);
                    key = 'kaoyan_hist_hl';
                }
                localStorage.setItem(key, JSON.stringify(newList));
            };

            const handleResetChat = () => {
                if(!confirm("ç¡®å®šè¦æ¸…é™¤è®°å¿†å¹¶é‡æ–°å¼€å§‹å—ï¼Ÿ")) return;
                const initialMsg = { role: "assistant", content: `è®°å¿†å·²é‡ç½®ã€‚è¯·ç‚¹å‡» ğŸª„ æŒ‰é’®é‡æ–°ç”Ÿæˆè¯¦è§£ï¼` };
                setMessages([initialMsg]);
                saveChatHistory([initialMsg]);
            };

            const handleMagicSend = async () => {
                if (isLoading) return;
                const uiMsg = { role: "user", content: "ğŸª„ å¯åŠ¨æ·±åº¦è§£ææ¨¡å¼..." };
                const newMessages = [...messages, uiMsg];
                setMessages(newMessages);
                setIsLoading(true);
                
                try {
                    const apiHistory = messages.filter(m => m.role !== 'error').map(m => ({ role: m.role, content: m.content }));
                    const apiMessages = [{ role: "system", content: "You are a helpful English vocabulary tutor." }, ...apiHistory, { role: "user", content: magicPrompt }];
                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);
                    
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";

                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: apiMessages, stream: true })
                    });
                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    setMessages(prev => { const newMsgs = [...prev]; newMsgs.pop(); return [...newMsgs, { role: "assistant", content: "" }]; });
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setMessages(prev => { const newMsgs = [...prev]; newMsgs[newMsgs.length - 1] = { role: "assistant", content: fullText }; return newMsgs; });
                                } catch (e) { }
                            }
                        }
                    }
                    saveChatHistory([...newMessages, { role: "assistant", content: fullText }]);
                } catch (error) { setMessages(prev => [...prev, { role: "error", content: "å‡ºé”™äº†: " + error.message }]); } finally { setIsLoading(false); }
            };

            const stopAudio = () => {
                if (audioRef.current) {
                    if (audioRef.current instanceof Audio) { audioRef.current.pause(); audioRef.current.currentTime = 0; } 
                    else { window.speechSynthesis.cancel(); }
                    audioRef.current = null;
                }
                setPlayingIdx(null);
            };

            const toggleAudio = (text, idx) => {
                if (playingIdx === idx) { stopAudio(); return; }
                stopAudio();
                setPlayingIdx(idx);
                const cleanText = text.replace(/[\*\#\-\>]/g, '');
                if (cleanText.length < 200) {
                    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encodeURIComponent(cleanText)}`);
                    audioRef.current = audio;
                    audio.onended = () => setPlayingIdx(null);
                    audio.onerror = () => playSystemTTS(cleanText, idx);
                    audio.play().catch(e => playSystemTTS(cleanText, idx));
                } else {
                    playSystemTTS(cleanText, idx);
                }
            };

            const playSystemTTS = (text, idx) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; u.rate = 1.0; 
                const voices = window.speechSynthesis.getVoices();
                const bestVoice = voices.find(v => v.name.includes("Google US English")) || voices.find(v => v.name.includes("Microsoft Zira")) || voices.find(v => v.lang === 'en-US');
                if (bestVoice) u.voice = bestVoice;
                u.onend = () => setPlayingIdx(null); u.onerror = () => setPlayingIdx(null);
                audioRef.current = u;
                window.speechSynthesis.speak(u);
            };

            const handleSend = async (e) => {
                if (e) e.preventDefault();
                const content = input.trim();
                if (!content || isLoading) return;
                const newMsgUser = { role: "user", content };
                const updatedMessages = [...messages, newMsgUser];
                setMessages(updatedMessages);
                saveChatHistory(updatedMessages);
                setInput("");
                setIsLoading(true);
                try {
                    const apiHistory = messages.filter(m => m.role !== 'error').map(m => ({ role: m.role, content: m.content }));
                    const apiMessages = [{ role: "system", content: "You are a helpful English vocabulary tutor." }, ...apiHistory, { role: "user", content }];
                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: apiMessages, stream: true })
                    });
                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    setMessages(prev => { const newMsgs = [...prev]; newMsgs.pop(); return [...newMsgs, { role: "assistant", content: "" }]; });
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setMessages(prev => { const newMsgs = [...prev]; newMsgs[newMsgs.length - 1] = { role: "assistant", content: fullText }; return newMsgs; });
                                } catch (e) { }
                            }
                        }
                    }
                    saveChatHistory([...updatedMessages, { role: "assistant", content: fullText }]);
                } catch (error) { setMessages(prev => [...prev, { role: "error", content: "å‡ºé”™äº†: " + error.message }]); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-white md:fixed md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[90vw] md:max-w-4xl md:h-[85vh] md:rounded-2xl md:shadow-2xl md:border md:border-gray-200 overflow-hidden animate-fade-in">
                    <style>{`.chat-content strong { color: ${highlightColor} !important; background: rgba(255,255,255,0.15); padding: 0 3px; border-radius: 3px; }`}</style>

                    <div className="flex justify-between items-center p-4 border-b bg-white z-10 shadow-sm flex-shrink-0">
                        <div className="flex items-center">
                            <h3 className="font-bold text-lg text-gray-800 mr-2">{word}</h3>
                            <span className="text-xs font-bold px-2 py-0.5 rounded-full shadow-sm transition-colors duration-300" style={{backgroundColor: bubbleColor, color: textColor}}>AI ç§æ•™</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={handleResetChat} className="p-2 text-gray-400 hover:text-red-500 transition" title="æ¸…é™¤è®°å¿†/é‡æ–°ç”Ÿæˆ"><Icon name="Trash2" size={18}/></button>
                            <div className="relative">
                                <button onClick={()=>setShowColorPicker(!showColorPicker)} className="p-2 rounded-full hover:bg-gray-100 text-gray-400 transition"><Icon name="Palette" size={20}/></button>
                                {showColorPicker && (
                                    <div className="absolute right-0 top-10 bg-white shadow-xl border rounded-xl p-4 w-72 z-50 animate-fade-in space-y-5 h-96 overflow-y-auto custom-scroll">
                                        {/* èƒŒæ™¯é¢œè‰² */}
                                        <div>
                                            <div className="text-xs text-gray-400 mb-2 font-bold flex justify-between">æ°”æ³¡èƒŒæ™¯ <span>Bubble</span></div>
                                            <div className="grid grid-cols-7 gap-2">
                                                {bgColors.map((c, i) => (
                                                    <div key={i} onClick={()=>updateColorState('bg', c)} className={`w-7 h-7 rounded-full cursor-pointer border shadow-sm hover:scale-110 transition ${bubbleColor === c ? 'ring-2 ring-indigo-500 ring-offset-1' : 'border-gray-200'}`} style={{backgroundColor: c}}></div>
                                                ))}
                                                <label className="w-7 h-7 rounded-full cursor-pointer border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50 hover:bg-gray-100 text-gray-400 text-xs">
                                                    <input type="color" className="opacity-0 w-full h-full absolute cursor-pointer" onChange={(e)=>updateColorState('bg', e.target.value)}/>+
                                                </label>
                                            </div>
                                        </div>
                                        {/* æ–‡å­—é¢œè‰² */}
                                        <div>
                                            <div className="text-xs text-gray-400 mb-2 font-bold flex justify-between">æ–‡å­—é¢œè‰² <span>Text</span></div>
                                            <div className="grid grid-cols-7 gap-2">
                                                {textColors.map((c, i) => (
                                                    <div key={i} onClick={()=>updateColorState('text', c)} className={`w-7 h-7 rounded-full cursor-pointer border shadow-sm hover:scale-110 transition ${textColor === c ? 'ring-2 ring-indigo-500 ring-offset-1' : 'border-gray-200'}`} style={{backgroundColor: c}}></div>
                                                ))}
                                                <label className="w-7 h-7 rounded-full cursor-pointer border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50 hover:bg-gray-100 text-gray-400 text-xs">
                                                    <input type="color" className="opacity-0 w-full h-full absolute cursor-pointer" onChange={(e)=>updateColorState('text', e.target.value)}/>+
                                                </label>
                                            </div>
                                        </div>
                                        {/* é«˜äº®é¢œè‰² */}
                                        <div>
                                            <div className="text-xs text-gray-400 mb-2 font-bold flex justify-between">é‡ç‚¹é«˜äº® <span>Highlight</span></div>
                                            <div className="grid grid-cols-7 gap-2">
                                                {hlColors.map((c, i) => (
                                                    <div key={i} onClick={()=>updateColorState('hl', c)} className={`w-7 h-7 rounded-full cursor-pointer border shadow-sm hover:scale-110 transition ${highlightColor === c ? 'ring-2 ring-indigo-500 ring-offset-1' : 'border-gray-200'}`} style={{backgroundColor: c}}></div>
                                                ))}
                                                <label className="w-7 h-7 rounded-full cursor-pointer border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50 hover:bg-gray-100 text-gray-400 text-xs">
                                                    <input type="color" className="opacity-0 w-full h-full absolute cursor-pointer" onChange={(e)=>updateColorState('hl', e.target.value)}/>+
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 text-gray-400"><Icon name="X" size={24}/></button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 bg-gray-50 custom-scroll" onClick={()=>setShowColorPicker(false)}>
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`flex flex-col max-w-[90%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div 
                                        className={`p-4 rounded-2xl text-sm md:text-base relative group break-words shadow-sm transition-colors duration-300 
                                            ${msg.role === 'user' 
                                                ? 'bg-white text-gray-800 border border-gray-100 rounded-tr-none' 
                                                : 'rounded-tl-none markdown-body border-t border-white/20 chat-content'
                                            } 
                                            ${msg.role === 'error' ? 'bg-red-50 text-red-600 border-red-200' : ''}
                                        `}
                                        style={msg.role === 'assistant' ? {
                                            backgroundColor: bubbleColor,
                                            color: textColor,
                                            boxShadow: 'inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 10px rgba(0,0,0,0.1)' 
                                        } : {}}
                                    >
                                        {msg.role === 'assistant' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}
                                        
                                        {msg.role === 'assistant' && msg.content !== '...' && (
                                            <button onClick={(e) => {e.stopPropagation(); toggleAudio(msg.content, idx);}} className={`absolute -right-8 bottom-0 p-1.5 text-gray-400 hover:text-indigo-600 bg-white/50 rounded-full hover:bg-white transition shadow-sm ${playingIdx === idx ? 'text-indigo-600 bg-white ring-2 ring-indigo-100' : ''}`}>
                                                {playingIdx === idx ? <Icon name="Pause" size={16}/> : <Icon name="Volume2" size={16}/>}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="p-3 bg-white border-t flex items-end gap-2 safe-bottom flex-shrink-0 relative">
                        <button onClick={handleMagicSend} disabled={isLoading} className="absolute left-5 top-5 z-10 text-indigo-500 hover:text-indigo-600 transition bg-indigo-50 p-1.5 rounded-lg border border-indigo-100 animate-pulse" title="ä¸€é”®æ·±åº¦è§£æ">
                            <Icon name="Sparkles" size={18}/>
                        </button>

                        <textarea 
                            value={input} 
                            onChange={e => setInput(e.target.value)} 
                            onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}} 
                            placeholder=" è¾“å…¥é—®é¢˜..." 
                            className="flex-1 max-h-32 p-3 pl-12 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-100 outline-none resize-none text-sm custom-scroll" 
                            rows="1" 
                        ></textarea>
                        <button onClick={(e)=>handleSend(e)} disabled={isLoading || !input.trim()} className="p-3 rounded-xl text-white shadow-md transition-all active:scale-95" style={{backgroundColor: bubbleColor, color: textColor}}>
                            {isLoading ? <div className="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin"></div> : <Icon name="Send" size={20} />}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Components ---

       const Navbar = ({ view, setView }) => {
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            };

            return (
                <nav className="bg-indigo-600 text-white shadow-md sticky top-0 z-50 safe-top transition-all duration-300 flex-shrink-0">
                    <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div className="flex items-center space-x-2" onClick={() => setView('home')}>
                            <div className="font-bold text-lg cursor-pointer flex items-center space-x-2">
                                <Icon name="Book" size={24}/>
                                <span className="tracking-wide hidden sm:inline">è€ƒç ”è¯æ±‡å¤§å¸ˆ</span>
                            </div>
                        </div>
                        <div className="flex space-x-1 items-center">
                            <button onClick={toggleFullscreen} className="p-2 rounded-lg hover:bg-indigo-500 transition" title="å…¨å±/é€€å‡º">
                                <Icon name="Maximize" />
                            </button>
                            <button onClick={() => setView('home')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'home' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Brain" /></button>
                            <button onClick={() => setView('list')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'list' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="List" /></button>
                            <button onClick={() => setView('import')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'import' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Upload" /></button>
                            <button onClick={() => setView('settings')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'settings' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Settings" /></button>
                        </div>
                    </div>
                </nav>
            );
        };

        const WordListMode = ({ words, setWords, setChatSession }) => {
            const [search, setSearch] = useState("");
            const [sortMode, setSortMode] = useState('default');
            const [sortDesc, setSortDesc] = useState(false);
            const [showSortMenu, setShowSortMenu] = useState(false);
            const displayWords = useMemo(() => {
                let list = words.filter(w => w.word.toLowerCase().includes(search.toLowerCase()) || w.meanings.some(m => m.def.includes(search)));
                list.sort((a, b) => {
                    if (sortMode === 'alpha') return a.word.localeCompare(b.word);
                    else if (sortMode === 'reviews') return (a.stats?.reviewCount || 0) - (b.stats?.reviewCount || 0);
                    return 0;
                });
                if (sortDesc) list.reverse();
                return list;
            }, [words, search, sortMode, sortDesc]);
            const toggleSort = (mode) => { if (sortMode === mode) setSortDesc(!sortDesc); else { setSortMode(mode); setSortDesc(mode === 'reviews'); } setShowSortMenu(false); };
            const toggleMastery = (wordId, meaningIndex) => { const newWords = [...words]; const idx = newWords.findIndex(w => w.id === wordId); if (idx !== -1) { newWords[idx].meanings[meaningIndex].isMastered = !newWords[idx].meanings[meaningIndex].isMastered; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            
            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50">
                    <div className="max-w-6xl mx-auto pb-20">
                        <div className="sticky top-0 bg-gray-50 pt-2 pb-4 z-40 space-y-2 md:flex md:space-y-0 md:space-x-4 md:items-center">
                            <div className="relative flex-1">
                                <input type="text" placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰..." className="w-full pl-10 pr-4 py-3 rounded-xl shadow-sm border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition" value={search} onChange={e => setSearch(e.target.value)} />
                                <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="Search" /></div>
                            </div>
                            <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm border border-gray-200 text-sm relative md:w-auto">
                                <span className="text-gray-500 ml-2 whitespace-nowrap font-medium">å…± {displayWords.length} è¯</span>
                                <button onClick={() => setShowSortMenu(!showSortMenu)} className="ml-4 flex items-center space-x-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-medium whitespace-nowrap transition"><Icon name="Sort" size={16} /><span>æ’åº</span></button>
                                {showSortMenu && (<div className="absolute right-0 top-full mt-2 w-40 bg-white rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden ring-1 ring-black/5"><button onClick={() => toggleSort('default')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">é»˜è®¤</button><button onClick={() => toggleSort('alpha')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">å­—æ¯ A-Z</button><button onClick={() => toggleSort('reviews')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">å¤ä¹ æ¬¡æ•°</button></div>)}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {displayWords.map((word) => (
                                <div key={word.id} className="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition duration-200 border border-gray-100 hover:border-indigo-100 flex flex-col h-full relative group">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-baseline space-x-2 overflow-hidden">
                                            <h3 className="text-lg font-bold text-gray-900 truncate">{word.word}</h3>
                                            <span className="text-sm font-mono text-gray-500 truncate">{word.phonetic}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={(e)=>{e.stopPropagation(); setChatSession(word.word);}} className="p-1.5 bg-indigo-50 text-indigo-500 hover:text-white hover:bg-indigo-500 rounded-full transition shadow-sm" title="AI è¯¦è§£"><Icon name="MessageCircle" size={18}/></button>
                                            <div className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap font-medium">å¤ä¹  {word.stats?.reviewCount || 0}</div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {word.meanings.map((m, mIdx) => (
                                            <div key={mIdx} className="flex items-start group cursor-pointer p-1 -ml-1 rounded hover:bg-gray-50 transition" onClick={() => toggleMastery(word.id, mIdx)}>
                                                <div className={`mt-0.5 mr-2 flex-shrink-0 transition-colors ${m.isMastered ? 'text-green-500' : 'text-gray-300 group-hover:text-gray-400'}`}><Icon name="Check" size={16} /></div>
                                                <div className={`text-sm leading-snug break-words ${m.isMastered ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                                    <span className="font-semibold mr-1 text-gray-500 text-xs uppercase">{m.pos}</span>{m.def}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ words, setView, setSessionConfig }) => {
            const stats = useMemo(() => {
                const counts = { high: 0, medium: 0, low: 0, zero: 0, uncategorized: 0, review: 0 };
                const now = Date.now();
                words.forEach(w => {
                    const cat = w.category || 'uncategorized';
                    if (['high', 'medium', 'low', 'zero'].includes(cat)) counts[cat]++; else if (!counts[cat]) counts[cat] = 1; else counts[cat]++;
                    if (w.stats && w.stats.nextReview <= now && w.stats.interval !== 0) counts.review++;
                });
                return counts;
            }, [words]);
            const standardCats = ['high', 'medium', 'low', 'zero'];
            const customCats = Object.keys(stats).filter(k => !standardCats.includes(k) && k !== 'review' && k !== 'uncategorized');
            const openCategory = (category) => { setSessionConfig({ type: 'group_select', category }); setView('group_list'); };
            const startReview = () => { setSessionConfig({ type: 'review' }); setView('study'); };
            
            const Card = ({ title, count, color, onClick, isCustom }) => (
                <div onClick={onClick} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer transform transition hover:scale-[1.02] hover:shadow-md active:scale-95 relative overflow-hidden group h-32 flex flex-col justify-between`}>
                    <div className={`absolute top-0 left-0 w-1.5 h-full ${color} transition-all group-hover:w-2`}></div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-gray-800 text-lg truncate pl-2">{title}</h3>
                        <div className={`text-gray-200 group-hover:text-indigo-100 transition-colors ${isCustom ? 'opacity-70' : ''}`}>{isCustom ? <Icon name="Folder" size={28}/> : <Icon name="Book" size={28}/>}</div>
                    </div>
                    <div className="pl-2">
                        <span className="text-2xl font-bold text-gray-700">{count}</span>
                        <span className="text-xs text-gray-400 ml-1">è¯</span>
                    </div>
                </div>
            );

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 bg-gray-50">
                    <div className="max-w-5xl mx-auto space-y-8 pb-10">
                        <div onClick={startReview} className="w-full bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl text-white shadow-xl shadow-indigo-200 cursor-pointer transform transition hover:-translate-y-1 hover:shadow-2xl active:scale-[0.99] relative overflow-hidden flex flex-col md:flex-row justify-between items-center group">
                            <div className="z-10 relative text-center md:text-left">
                                <h2 className="text-3xl font-bold mb-2 tracking-tight">æ™ºèƒ½å¤ä¹ è®¡åˆ’</h2>
                                <p className="text-indigo-100 text-lg opacity-90">ä»Šæ—¥å¾…å¤ä¹ : <span className="font-bold text-white bg-white/20 px-3 py-0.5 rounded-lg ml-1">{stats.review}</span> ä¸ªå•è¯</p>
                            </div>
                            <div className="mt-4 md:mt-0 bg-white/20 w-20 h-20 rounded-full flex items-center justify-center z-10 relative group-hover:scale-110 transition duration-300 backdrop-blur-sm border border-white/30">
                                <Icon name="Brain" size={40} className="text-white"/>
                            </div>
                            <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                            <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-indigo-900/20 rounded-full blur-2xl"></div>
                            {stats.review > 0 && <div className="absolute top-6 right-6 w-3 h-3 bg-red-400 rounded-full animate-ping"></div>}
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="List" size={20} className="mr-2 text-indigo-600"/>æ ¸å¿ƒè€ƒé¢‘</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                                <Card title="é«˜é¢‘è¯" count={stats.high || 0} color="bg-red-500" onClick={() => openCategory('high')} />
                                <Card title="ä¸­é¢‘è¯" count={stats.medium || 0} color="bg-orange-500" onClick={() => openCategory('medium')} />
                                <Card title="ä½é¢‘è¯" count={stats.low || 0} color="bg-yellow-500" onClick={() => openCategory('low')} />
                                <Card title="é›¶é¢‘è¯" count={stats.zero || 0} color="bg-green-500" onClick={() => openCategory('zero')} />
                                {stats.uncategorized > 0 && <Card title="æœªåˆ†ç±»" count={stats.uncategorized} color="bg-gray-400" onClick={() => openCategory('uncategorized')} />}
                            </div>
                        </div>

                        {customCats.length > 0 && (
                            <div>
                                <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="Folder" size={20} className="mr-2 text-indigo-600"/>æˆ‘çš„åˆ†ç»„</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 lg:gap-6">
                                    {customCats.map(cat => (<Card key={cat} title={cat} count={stats[cat]} color="bg-blue-500" onClick={() => openCategory(cat)} isCustom={true} />))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

                     const GroupList = ({ words, setWords, category, setView, setSessionConfig, config }) => {
            const [moveModal, setMoveModal] = useState({ open: false, targetGroupWords: [] });
            const [editModal, setEditModal] = useState({ open: false, batchId: '', currentName: '', currentDesc: '' });
            const [customTarget, setCustomTarget] = useState('');
            const [groupMeta, setGroupMeta] = useState({});
            
            const [storyModal, setStoryModal] = useState({ open: false, loading: false, content: '', batchName: '' });

            useEffect(() => {
                try {
                    const savedMeta = localStorage.getItem('kaoyan_group_meta');
                    if (savedMeta) setGroupMeta(JSON.parse(savedMeta));
                } catch (e) { console.error("åŠ è½½åˆ†ç»„ä¿¡æ¯å¤±è´¥", e); }
            }, []);

            // ğŸ”¥ æ ¸å¿ƒé€»è¾‘å‡çº§ï¼šåªé’ˆå¯¹â€œéš¾è¯â€ç”Ÿæˆä¸²çƒ§
            const generateStory = async (groupWords, batchName) => {
                if (!config.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®é¡µé…ç½® API Keyï¼");
                
                // ğŸ•µï¸â€â™‚ï¸ æ™ºèƒ½ç­›é€‰ï¼šå‰”é™¤å·²æŒæ¡(ç»¿è‰²)å•è¯ï¼Œåªä¿ç•™ç”Ÿè¯(çº¢)å’Œä¸ç†Ÿ(é»„)
                // åˆ¤å®šæ ‡å‡†ï¼šæ²¡æœ‰å¤ä¹ æ•°æ®ï¼Œæˆ–è€…å¤ä¹ é—´éš” <= 1 å¤©
                const hardWords = groupWords.filter(w => !w.stats || w.stats.interval <= 1);
                
                if (hardWords.length === 0) {
                    return alert("ğŸ‰ å¤ªå¼ºäº†ï¼è¿™ç»„å•è¯ä½ å·²ç»å…¨éƒ¨ã€ç†Ÿç»ƒæŒæ¡ã€‘ï¼Œæ— éœ€ç”Ÿæˆæ•…äº‹ã€‚\n\nè¯·å»æ”»å…‹å…¶ä»–åˆ†ç»„å§ï¼");
                }

                const targetWords = hardWords.map(w => w.word).join(', ');
                // æ ‡é¢˜ä¼šæ˜¾ç¤ºè¿™æ¬¡æ”»å…‹äº†å¤šå°‘ä¸ªè¯
                setStoryModal({ open: true, loading: true, content: '', batchName: `${batchName} Â· æ”»å…‹ ${hardWords.length} éš¾è¯` });

                const prompt = `ä½ æ˜¯ä¸€ä½è€ƒç ”è‹±è¯­å‘½é¢˜ä¸“å®¶ã€‚è¯·ä½¿ç”¨ä»¥ä¸‹ã€ç”Ÿè¯/éš¾è¯åˆ—è¡¨ã€‘ï¼š[${targetWords}]ï¼Œç¼–å†™ä¸€ç¯‡é€»è¾‘è¿è´¯ã€å­¦æœ¯é£æ ¼çš„çŸ­æ–‡ï¼ˆçº¦ 150-200 è¯ï¼‰ã€‚
                
                è¦æ±‚ï¼š
                1. **è¯­å¢ƒèåˆ**ï¼šå¿…é¡»å¼ºåˆ¶åŒ…å«åˆ—è¡¨ä¸­çš„æ‰€æœ‰å•è¯ï¼Œè¿™æ˜¯ä¸ºäº†å¸®åŠ©å­¦ç”Ÿåœ¨è¯­å¢ƒä¸­è®°å¿†è¿™äº›ä»–è¿˜æ²¡æŒæ¡çš„è¯ã€‚æ–‡é£æ¨¡ä»¿ã€Šç»æµå­¦äººã€‹ã€‚
                2. **é«˜äº®æ˜¾ç¤º**ï¼šåœ¨æ–‡ç« ä¸­å‡ºç°è¿™äº›å•è¯æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ Markdown çš„åŠ ç²—æ ¼å¼ï¼ˆä¾‹å¦‚ **word**ï¼‰ã€‚
                3. **ä¸­æ–‡ç¿»è¯‘**ï¼šåœ¨è‹±æ–‡æ–‡ç« ç»“æŸåï¼Œè¯·æä¾›ä¸€æ®µæµç•…çš„ä¸­æ–‡å…¨æ–‡ç¿»è¯‘ã€‚
                4. **æ’ç‰ˆ**ï¼šä½¿ç”¨ Markdown æ ¼å¼ã€‚`;

                try {
                    let fullText = "";
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";

                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ 
                            model: config.model, 
                            messages: [{ role: "user", content: prompt }],
                            stream: true 
                        })
                    });

                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setStoryModal(prev => ({ ...prev, loading: false, content: fullText }));
                                } catch (e) { }
                            }
                        }
                    }
                } catch (e) {
                    setStoryModal(prev => ({ ...prev, loading: false, content: "**ç”Ÿæˆå¤±è´¥**ï¼šè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚\né”™è¯¯ä¿¡æ¯ï¼š" + e.message }));
                }
            };

            const groups = useMemo(() => {
                const catWords = words.filter(w => (w.category || 'uncategorized') === category);
                const groupSize = config.groupSize || 208;
                const batches = {};
                catWords.forEach(w => { const batchId = w.importId || 'default'; if (!batches[batchId]) batches[batchId] = []; batches[batchId].push(w); });
                const result = [];
                const batchKeys = Object.keys(batches).sort((a, b) => { if (a === 'default') return -1; if (b === 'default') return 1; return parseInt(b.split('-')[1] || 0) - parseInt(a.split('-')[1] || 0); });
                let globalIndex = 1;
                
                batchKeys.forEach(batchId => {
                    const batchWords = batches[batchId]; const count = Math.ceil(batchWords.length / groupSize);
                    for(let i=0; i<count; i++) {
                        const start = i * groupSize; const end = Math.min((i+1) * groupSize, batchWords.length);
                        const groupWords = batchWords.slice(start, end);
                        
                        const green = groupWords.filter(w => w.stats && w.stats.interval > 1).length;
                        const yellow = groupWords.filter(w => w.stats && w.stats.interval > 0 && w.stats.interval <= 1).length;
                        const red = groupWords.length - green - yellow;

                        const meta = groupMeta[batchId] || {};
                        let batchName = meta.name;
                        if (!batchName) {
                            if (batchId !== 'default') { 
                                const ts = parseInt(batchId.split('-')[1]); 
                                if (!isNaN(ts)) { const date = new Date(ts); batchName = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} å¯¼å…¥`; } else { batchName = "æ–°æ‰¹æ¬¡"; } 
                            } else { batchName = "é»˜è®¤è¯åº“"; }
                        }
                        result.push({ 
                            index: globalIndex++, 
                            batchId, 
                            batchIndex: i, 
                            batchName, 
                            desc: meta.desc || "", 
                            start: start + 1, 
                            end, 
                            total: groupWords.length, 
                            green, yellow, red,
                            words: groupWords 
                        });
                    }
                });
                return result;
            }, [words, category, config.groupSize, groupMeta]);

            const displayTitle = ({ high: "é«˜é¢‘è¯", medium: "ä¸­é¢‘è¯", low: "ä½é¢‘è¯", zero: "é›¶é¢‘è¯", uncategorized: "æœªåˆ†ç±»" })[category] || category;
            const startGroup = (batchId, batchIndex) => { setSessionConfig({ type: 'group_study', category, batchId, batchIndex }); setView('study'); };
            
            const handleDeleteGroup = (e, groupWords) => {
                e.stopPropagation();
                if(confirm(`ç¡®å®šè¦åˆ é™¤è¯¥ç»„çš„ ${groupWords.length} ä¸ªå•è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                    const idsToDelete = groupWords.map(w => w.id);
                    const newWords = words.filter(w => !idsToDelete.includes(w.id));
                    setWords(newWords);
                    localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                }
            };

            const openMoveModal = (e, groupWords) => { e.stopPropagation(); setMoveModal({ open: true, targetGroupWords: groupWords }); setCustomTarget(''); };
            const performMove = (targetCat) => {
                if(!targetCat) return;
                const idsToMove = moveModal.targetGroupWords.map(w => w.id);
                const newWords = words.map(w => idsToMove.includes(w.id) ? { ...w, category: targetCat } : w);
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                setMoveModal({ open: false, targetGroupWords: [] });
                alert("è½¬ç§»æˆåŠŸï¼");
            };

            const openEditModal = (e, batchId, currentName, currentDesc) => {
                e.stopPropagation();
                const isDefaultName = currentName.includes("å¯¼å…¥") || currentName === "é»˜è®¤è¯åº“" || currentName === "æ–°æ‰¹æ¬¡";
                setEditModal({ open: true, batchId, currentName: isDefaultName ? '' : currentName, currentDesc: currentDesc || '' });
            };

            const saveGroupInfo = () => {
                const newMeta = { ...groupMeta, [editModal.batchId]: { name: editModal.currentName.trim(), desc: editModal.currentDesc.trim() } };
                setGroupMeta(newMeta);
                localStorage.setItem('kaoyan_group_meta', JSON.stringify(newMeta));
                setEditModal({ open: false, batchId: '', currentName: '', currentDesc: '' });
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50 relative">
                    <div className="max-w-5xl mx-auto pb-20">
                        <div className="flex items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800 truncate border-l-4 border-indigo-600 pl-3">{displayTitle}</h2>
                            <span className="ml-3 text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded-md">åˆ†ç»„ç®¡ç†</span>
                        </div>
                        {groups.length === 0 ? 
                            <div className="flex flex-col items-center justify-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100"><div className="text-gray-300 mb-4"><Icon name="Book" size={48}/></div><div className="text-gray-500">è¯¥åˆ†ç±»ä¸‹æš‚æ— å•è¯</div></div> 
                        : 
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {groups.map(g => (
                                <div key={g.index} onClick={() => startGroup(g.batchId, g.batchIndex)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:border-indigo-300 hover:shadow-md transition duration-200 flex flex-col group relative overflow-hidden min-h-[160px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex-1 pr-2">
                                            <h3 className="font-bold text-gray-800 text-lg line-clamp-1" title={g.batchName}>{g.batchName}</h3>
                                            <div className="flex items-center mt-1 space-x-2"><span className="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded border border-gray-200">Group {g.index}</span></div>
                                        </div>
                                        <div className="flex space-x-1">
                                            {/* ğŸ”¥ æ™ºèƒ½æŒ‰é’®ï¼šåªåœ¨æœ‰ç”Ÿè¯æ—¶é«˜äº® */}
                                            <button onClick={(e) => { e.stopPropagation(); generateStory(g.words, g.batchName); }} className={`p-1.5 rounded transition ${g.green === g.total ? 'bg-gray-100 text-gray-400' : 'bg-amber-50 text-amber-600 hover:bg-amber-100 animate-pulse'}`} title={g.green === g.total ? "å·²å…¨éƒ¨æŒæ¡" : "æ”»å…‹ç”Ÿè¯"}><Icon name="Sparkles" size={16}/></button>
                                            <button onClick={(e) => openEditModal(e, g.batchId, g.batchName, g.desc)} className="p-1.5 bg-gray-50 text-gray-600 rounded hover:bg-indigo-50 hover:text-indigo-600 transition" title="ç¼–è¾‘"><Icon name="Edit" size={16}/></button>
                                            <button onClick={(e) => openMoveModal(e, g.words)} className="p-1.5 bg-blue-50 text-blue-500 rounded hover:bg-blue-100 transition" title="è½¬ç§»"><Icon name="Move" size={16}/></button>
                                            <button onClick={(e) => handleDeleteGroup(e, g.words)} className="p-1.5 bg-red-50 text-red-500 rounded hover:bg-red-100 transition" title="åˆ é™¤"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                    <div className="mb-3 flex-1">{g.desc ? (<p className="text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100 line-clamp-2">{g.desc}</p>) : (<p className="text-xs text-gray-300 italic py-2">æš‚æ— å¤‡æ³¨...</p>)}</div>
                                    <div className="mt-auto">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>è¿›åº¦</span>
                                            <span className="font-medium text-indigo-600">{Math.round(((g.green + g.yellow)/g.total)*100)}%</span>
                                        </div>
                                        <div className="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden flex">
                                            <div className="h-full bg-emerald-500 transition-all duration-500" style={{width: `${(g.green/g.total)*100}%`}}></div>
                                            <div className="h-full bg-amber-400 transition-all duration-500" style={{width: `${(g.yellow/g.total)*100}%`}}></div>
                                            <div className="h-full bg-red-100" style={{width: `${(g.red/g.total)*100}%`}}></div>
                                        </div>
                                        <div className="flex justify-between mt-2 text-[10px] text-gray-400 font-mono">
                                            <span className="flex items-center"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1"></div>{g.green}</span>
                                            <span className="flex items-center"><div className="w-1.5 h-1.5 rounded-full bg-amber-400 mr-1"></div>{g.yellow}</span>
                                            <span className="flex items-center"><div className="w-1.5 h-1.5 rounded-full bg-red-200 mr-1"></div>{g.red}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        }
                    </div>

                    {storyModal.open && (
                        <div className="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setStoryModal({ ...storyModal, open: false })}>
                            <div className="bg-white w-full max-w-2xl max-h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-amber-50">
                                    <h3 className="font-bold text-amber-800 flex items-center"><span className="mr-2">âœ¨</span> {storyModal.batchName}</h3>
                                    <button onClick={() => setStoryModal({ ...storyModal, open: false })} className="p-2 hover:bg-amber-100 rounded-full text-amber-800"><Icon name="X" size={20} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 custom-scroll bg-white">
                                    {storyModal.loading && !storyModal.content && (
                                        <div className="flex flex-col items-center justify-center py-10 space-y-4">
                                            <div className="w-10 h-10 border-4 border-amber-200 border-t-amber-500 rounded-full animate-spin"></div>
                                            <p className="text-gray-500 text-sm animate-pulse">æ­£åœ¨æŠ“å–ç”Ÿè¯å¹¶ç¼–ç»‡æ•…äº‹ï¼Œè¯·ç¨å€™...</p>
                                        </div>
                                    )}
                                    <div className="markdown-body text-gray-800 leading-relaxed space-y-4" dangerouslySetInnerHTML={{ __html: marked.parse(storyModal.content) }} />
                                </div>
                                <div className="p-4 border-t border-gray-100 bg-gray-50 text-right">
                                    <button onClick={() => setStoryModal({ ...storyModal, open: false })} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition">å…³é—­</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {moveModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setMoveModal({open:false, targetGroupWords:[]})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">è½¬ç§»è¯¥ç»„å•è¯åˆ°...</h3>
                                <div className="grid grid-cols-2 gap-3 mb-4">{['high', 'medium', 'low', 'zero'].map(cat => (<button key={cat} onClick={() => performMove(cat)} className="py-3 bg-gray-50 hover:bg-indigo-50 border border-gray-200 hover:border-indigo-200 rounded-xl font-bold text-gray-700 hover:text-indigo-700 transition uppercase">{cat}</button>))}</div>
                                <div className="border-t border-gray-100 pt-4 mt-2"><label className="text-xs font-bold text-gray-400 uppercase mb-2 block">è‡ªå®šä¹‰åˆ†ç»„</label><div className="flex space-x-2"><input type="text" value={customTarget} onChange={e => setCustomTarget(e.target.value)} placeholder="è¾“å…¥åˆ†ç»„å..." className="flex-1 p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/><button onClick={() => performMove(customTarget)} disabled={!customTarget.trim()} className="px-4 bg-indigo-600 text-white rounded-xl font-bold disabled:opacity-50">ç¡®å®š</button></div></div>
                                <button onClick={() => setMoveModal({open:false, targetGroupWords:[]})} className="mt-6 w-full py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}
                    {editModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setEditModal({...editModal, open:false})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">ç¼–è¾‘åˆ†ç»„ä¿¡æ¯</h3>
                                <div className="mb-4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">åˆ†ç»„åç§°</label><input type="text" value={editModal.currentName} onChange={e => setEditModal({...editModal, currentName: e.target.value})} placeholder="ä¾‹å¦‚: 2010å¹´çœŸé¢˜é˜…è¯»A" className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" autoFocus /></div>
                                <div className="mb-6"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">å¤‡æ³¨ / ç®€ä»‹</label><textarea value={editModal.currentDesc} onChange={e => setEditModal({...editModal, currentDesc: e.target.value})} placeholder="ä¾‹å¦‚: è¿™éƒ¨åˆ†å•è¯æ¯”è¾ƒéš¾ï¼Œéœ€è¦å¤šå¤ä¹ å‡ æ¬¡..." className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none"></textarea></div>
                                <div className="flex space-x-3"><button onClick={() => setEditModal({...editModal, open:false})} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button><button onClick={saveGroupInfo} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">ä¿å­˜</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

 
const StudySession = ({ words, setWords, sessionConfig, onExit, config, setChatSession }) => {
            const [queue, setQueue] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            
            const [isGeneratingNote, setIsGeneratingNote] = useState(false);
            const [syntaxLoading, setSyntaxLoading] = useState(false);
            
            const [isFullscreen, setIsFullscreen] = useState(false);
            // æ¨¡æ€æ¡†çŠ¶æ€ï¼šcontent åˆå§‹ä¸ºç©º
            const [syntaxModal, setSyntaxModal] = useState({ open: false, content: '' });

            useEffect(() => {
                const now = Date.now();
                let q = [];
                const groupSize = config.groupSize || 208;
                if (sessionConfig.type === 'review') {
                    q = words.filter(w => w.stats && w.stats.nextReview <= now && w.stats.interval !== 0);
                    if(q.length === 0) q = words.filter(w => w.stats && w.stats.interval < 1 && w.stats.interval !== 0);
                    q = q.sort(() => Math.random() - 0.5).slice(0, 30);
                } else if (sessionConfig.type === 'group_study') {
                    const catWords = words.filter(w => (w.category || 'uncategorized') === sessionConfig.category);
                    const batchId = sessionConfig.batchId;
                    const batchWords = catWords.filter(w => (w.importId || 'default') === batchId);
                    const start = sessionConfig.batchIndex * groupSize;
                    const end = start + groupSize;
                    const targetGroup = batchWords.slice(start, end);
                    const newWords = targetGroup.filter(w => !w.stats || w.stats.interval === 0);
                    const reviewWords = targetGroup.filter(w => w.stats && w.stats.interval !== 0);
                    q = [...newWords, ...reviewWords];
                }
                setQueue(q);
            }, [sessionConfig]);

            useEffect(() => { if (queue.length > 0 && !isFinished && !isFlipped) { const word = queue[currentIdx]?.word; if (word) { const timer = setTimeout(() => playAudio(word), 300); return () => clearTimeout(timer); } } }, [currentIdx, queue, isFinished]);

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => console.log(err));
                    setIsFullscreen(true);
                } else {
                    if (document.exitFullscreen) { document.exitFullscreen(); setIsFullscreen(false); }
                }
            };

            const currentCard = queue[currentIdx];
            
            const groupedMeanings = useMemo(() => {
                if (!currentCard || !currentCard.meanings) return [];
                const groups = [];
                currentCard.meanings.forEach((m, idx) => {
                    const lastGroup = groups[groups.length - 1];
                    if (lastGroup && lastGroup.pos === m.pos) {
                        lastGroup.items.push({ ...m, originalIdx: idx });
                    } else {
                        groups.push({ pos: m.pos, items: [{ ...m, originalIdx: idx }] });
                    }
                });
                return groups;
            }, [currentCard]);

            const handleRating = (rating) => {
                const word = currentCard;
                const currentStats = word.stats || { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 };
                const result = calculateNextReview(rating, currentStats.interval, currentStats.easeFactor, currentStats.reviewCount);
                const newStats = { interval: result.interval, easeFactor: result.easeFactor, nextReview: Date.now() + (result.interval * 24 * 60 * 60 * 1000), reviewCount: result.reviewCount };
                const updatedWords = words.map(w => w.id === word.id ? { ...w, stats: newStats } : w);
                setWords(updatedWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(updatedWords));
                if (result.isDueNow) setQueue(prev => [...prev, { ...word, stats: newStats, isRepeat: true }]);
                setIsFlipped(false); setTimeout(() => currentIdx + 1 >= queue.length ? setIsFinished(true) : setCurrentIdx(prev => prev + 1), 200);
            };

            const toggleMeaningMastery = (e, mIdx) => { e.stopPropagation(); const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], isMastered:!meanings[mIdx].isMastered, _forceShow:false}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); const newWords=[...words]; const idx=newWords.findIndex(w=>w.id===currentCard.id); if(idx!==-1){ newWords[idx]={...newWords[idx], meanings:meanings}; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            const toggleForceShow = (mIdx) => { const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], _forceShow:!meanings[mIdx]._forceShow}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); };
            
            const generateWordNote = async (e, forceRegenerate = false) => {
                e.stopPropagation(); 
                // ğŸ”¥ è®°å¿†æ£€æŸ¥ï¼šå¦‚æœæœ‰ä¸”ä¸æ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œç›´æ¥ä½¿ç”¨
                if (!forceRegenerate && currentCard.aiNote) return;

                if (!config.apiKey) { alert("è¯·è®¾ç½® API Key"); return; } 
                setIsGeneratingNote(true); 
                try {
                    const prompt = `é’ˆå¯¹è€ƒç ”è‹±è¯­ï¼Œè¯·ä¸ºå•è¯ "${currentCard.word}" ç”Ÿæˆä¸€ä»½ã€ç»¼åˆé¿å‘æŒ‡å—ã€‘ã€‚è¯·ç”¨ Markdown åˆ—è¡¨æ ¼å¼ï¼ŒåŒ…å«ï¼š\n1. **ç†Ÿè¯åƒ»ä¹‰**ï¼šåˆ—å‡ºçœŸé¢˜ä¸­å¸¸è€ƒä½†å®¹æ˜“è¢«å¿½ç•¥çš„æ„æ€ã€‚\n2. **æ˜“æ··è¾¨æ**ï¼šæœ€å®¹æ˜“ææ··çš„ 1-2 ä¸ªè¯ã€‚\n3. **çœŸé¢˜å‘ç‚¹**ï¼šå¸¸è§çš„æ­é…é™·é˜±æˆ–ç†è§£è¯¯åŒºã€‚\n\nè¦æ±‚ï¼šåˆå¹¶è¾“å‡ºï¼Œæ€»å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ï¼Œå¹²è´§ä¸ºä¸»ã€‚`;
                    let newNote = "";
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    const res = await fetch(`${baseUrl}/chat/completions`, { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${config.apiKey}`}, body: JSON.stringify({model:config.model, messages:[{role:"user",content:prompt}]}) }); 
                    const data = await res.json(); newNote = data.choices?.[0]?.message?.content;
                    if(newNote) { 
                        const s = newNote.trim(); const newWords = [...words]; const targetWord = newWords.find(w => w.id === currentCard.id);
                        if(targetWord) targetWord.aiNote = s;
                        setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); 
                        const newQueue = [...queue]; newQueue[currentIdx].aiNote = s; setQueue(newQueue); 
                    }
                } catch(e){ alert("ç”Ÿæˆå¤±è´¥: " + e.message); } finally { setIsGeneratingNote(false); }
            };

            // ğŸ”¥ é•¿éš¾å¥æ‰‹æœ¯åˆ€ï¼šå¸¦è®°å¿†åŠŸèƒ½
            const performSyntaxSurgery = async (e, forceRegenerate = false) => {
                e.stopPropagation();
                
                // 1. æ£€æŸ¥è®°å¿†
                if (!forceRegenerate && currentCard.aiSyntax) {
                    setSyntaxModal({ open: true, content: currentCard.aiSyntax });
                    return;
                }

                if (!config.apiKey) return alert("è¯·å…ˆé…ç½® API Key");
                setSyntaxLoading(true);
                setSyntaxModal({ open: true, content: '' }); // æ¸…ç©ºå†…å®¹ï¼Œæ˜¾ç¤º Loading

                const prompt = `è¯·ä½œä¸ºè€ƒç ”è‹±è¯­ä¸“å®¶ï¼Œç”¨å•è¯ "${currentCard.word}" é€ ä¸€ä¸ª**è€ƒç ”çœŸé¢˜éš¾åº¦**çš„é•¿éš¾å¥ï¼ˆçº¦30è¯ï¼‰ã€‚
                ç„¶åè¿›è¡Œã€è¯­æ³•æ‰‹æœ¯åˆ€ã€‘åˆ†æã€‚ä¸ºäº†åœ¨æ‰‹æœºä¸Šé˜…è¯»æ¸…æ™°ï¼Œ**ä¸¥ç¦ä½¿ç”¨ Markdown è¡¨æ ¼**ï¼Œè¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

                ### ğŸ§¬ è€ƒç ”é•¿éš¾å¥
                > (è¿™é‡Œå†™è‹±æ–‡å¥å­ï¼Œå°† **${currentCard.word}** åŠ ç²—)
                
                (è¿™é‡Œå†™ä¸­æ–‡ç¿»è¯‘ï¼Œç°è‰²å­—ä½“)

                ---

                ### ğŸ¦´ æ ¸å¿ƒéª¨æ¶ (ä¸»å¹²)
                * **ä¸»è¯­**ï¼š...
                * **è°“è¯­**ï¼š...
                * **å®¾è¯­**ï¼š...

                ### ğŸƒ ä¿®é¥°æˆåˆ† (çš®è‚‰)
                * **å®šè¯­ä»å¥**ï¼š(æ‘˜å½•ä»å¥)... -> ä¿®é¥° (å…ˆè¡Œè¯)
                * **çŠ¶è¯­**ï¼š(æ‘˜å½•)... -> è¡¨ç¤º (æ—¶é—´/åŸå› ç­‰)
                * **æ’å…¥è¯­/åŒä½è¯­**ï¼š...

                ### ğŸ’¡ è¯­æ³•è€ƒç‚¹
                1.  **ç‚¹ 1**ï¼š(è§£é‡Š)
                2.  **ç‚¹ 2**ï¼š(è§£é‡Š)
                `;

                try {
                    let fullText = "";
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";

                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ 
                            model: config.model, 
                            messages: [{ role: "user", content: prompt }],
                            stream: true 
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setSyntaxModal(prev => ({ ...prev, content: fullText }));
                                } catch (e) { }
                            }
                        }
                    }
                    // ğŸ”¥ ä¿å­˜ç”Ÿæˆç»“æœåˆ°å•è¯å¯¹è±¡
                    const newWords = [...words];
                    const targetWord = newWords.find(w => w.id === currentCard.id);
                    if(targetWord) targetWord.aiSyntax = fullText;
                    setWords(newWords);
                    localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                    // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
                    const newQueue = [...queue]; newQueue[currentIdx].aiSyntax = fullText; setQueue(newQueue);

                } catch (e) {
                    setSyntaxModal(prev => ({ ...prev, content: "**åˆ†æå¤±è´¥**ï¼š" + e.message }));
                } finally {
                    setSyntaxLoading(false);
                }
            };

            if (queue.length === 0 && !isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-green-100 p-6 rounded-full mb-6 text-green-600"><Icon name="Check" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-2">å½“å‰ä»»åŠ¡å®Œæˆ</h2><p className="text-gray-500 mb-8">ä¼‘æ¯ä¸€ä¸‹ï¼Œç¨åå†æ¥ï¼</p><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">è¿”å›é¦–é¡µ</button></div></div>;
            if (isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600"><Icon name="Sparkles" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-4">æœ¬è½®å­¦ä¹ ç»“æŸ ğŸ‰</h2><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">è¿”å›</button></div></div>;

            return (
                <div className="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gray-200 z-10">
                        <div className="h-full bg-indigo-600 transition-all duration-300 ease-out" style={{width: `${(currentIdx / queue.length) * 100}%`}}></div>
                    </div>
                    
                    <button onClick={onExit} className="absolute top-4 left-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-600 hover:text-indigo-600 transition hover:bg-white" title="é€€å‡º">
                        <Icon name="ArrowLeft" size={24}/>
                    </button>
                    
                    <button onClick={toggleFullscreen} className="absolute top-4 right-16 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-600 hover:text-indigo-600 transition hover:bg-white" title={isFullscreen ? "é€€å‡ºå…¨å±" : "å…¨å±æ¨¡å¼"}>
                        <Icon name={isFullscreen ? "Minimize" : "Maximize"} size={24}/>
                    </button>

                    <button onClick={(e)=>{e.stopPropagation(); setChatSession(currentCard.word);}} className="absolute top-4 right-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-indigo-500 hover:text-white hover:bg-indigo-500 transition" title="AI è¯¦è§£">
                        <Icon name="MessageCircle" size={24}/>
                    </button>

                    <div className="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden">
                        <div className="relative scene w-full max-w-sm md:max-w-3xl aspect-[3/4] md:aspect-[4/3] max-h-[85vh]">
                            <div className={`card-object ${isFlipped ? 'is-flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                                {/* å¡ç‰‡æ­£é¢ */}
                                <div className="card-face flex flex-col items-center justify-center p-8 md:p-12 text-center bg-gradient-to-br from-white to-gray-50 border border-white">
                                    <div className="flex-1 flex flex-col items-center justify-center w-full">
                                        <h1 className="text-5xl md:text-7xl lg:text-8xl font-black text-gray-800 mb-6 md:mb-10 tracking-tight">{currentCard.word}</h1>
                                        <div className="flex items-center space-x-3 text-gray-500 bg-white border border-gray-200 shadow-sm px-5 py-2.5 rounded-full cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition transform hover:scale-105" onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}}>
                                            <Icon name="Volume2" size={24} className="md:w-7 md:h-7"/><span className="font-mono text-xl md:text-2xl">{currentCard.phonetic}</span>
                                        </div>
                                    </div>
                                    <div className="mt-auto text-gray-400 text-sm md:text-base animate-pulse font-medium">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹é‡Šä¹‰</div>
                                </div>
                                
                                {/* å¡ç‰‡èƒŒé¢ */}
                                <div className="card-face card-face-back p-0 bg-white">
                                    <div className="flex-shrink-0 bg-white/95 backdrop-blur border-b border-gray-100 p-4 md:p-6 flex justify-between items-center z-10 shadow-sm">
                                        <h2 className="text-2xl md:text-4xl font-bold text-indigo-900">{currentCard.word}</h2>
                                        <button onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}} className="p-3 bg-indigo-50 rounded-full text-indigo-600 hover:bg-indigo-100 transition"><Icon name="Volume2" size={24}/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-4 md:space-y-6">
                                        {groupedMeanings.map((group, gIdx) => (
                                            <div key={gIdx} className="relative bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all">
                                                <div className="absolute -top-3 -left-1 z-10">
                                                    <span className="text-xs md:text-sm font-bold bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg border border-indigo-200 shadow-sm uppercase tracking-wide">{group.pos}</span>
                                                </div>
                                                <div className="pt-4 pb-1 px-1">
                                                    {group.items.map((m, subIdx) => {
                                                        const isHidden = m.isMastered && !m._forceShow;
                                                        return (
                                                            <div key={subIdx} className={`p-4 md:p-5 ${subIdx !== group.items.length - 1 ? 'border-b border-dashed border-gray-100' : ''}`}>
                                                                <div className="flex justify-between items-start gap-3">
                                                                    <div className="flex-1 min-h-[1.5rem] flex items-center">
                                                                        {isHidden ? (
                                                                            <div onClick={(e) => { e.stopPropagation(); toggleForceShow(m.originalIdx); }} className="bg-gray-50 text-gray-400 text-xs md:text-sm py-2 px-3 rounded-lg cursor-pointer flex items-center select-none hover:bg-gray-100 transition border border-dashed border-gray-200 w-full">
                                                                                <Icon name="EyeOff" size={14} className="mr-2"/> é‡Šä¹‰å·²éšè—
                                                                            </div>
                                                                        ) : (
                                                                            <div className="text-gray-800 font-medium text-lg md:text-2xl leading-relaxed">{m.def}</div>
                                                                        )}
                                                                    </div>
                                                                    <button onClick={(e) => toggleMeaningMastery(e, m.originalIdx)} className={`flex-shrink-0 p-2 rounded-lg transition active:scale-95 ${m.isMastered ? 'text-gray-400 bg-gray-50' : 'text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50'}`}>
                                                                        {m.isMastered ? <Icon name="EyeOff" size={20} /> : <Icon name="Eye" size={20} /> }
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}

                                        {/* ğŸ”¥ åŠŸèƒ½æ“ä½œåŒº */}
                                        <div className="mt-6 mb-2 grid grid-cols-2 gap-3">
                                            {/* 1. é¿å‘æŒ‡å— */}
                                            <button onClick={(e) => generateWordNote(e, false)} disabled={isGeneratingNote} className="py-4 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-2xl text-orange-600 font-bold flex flex-col items-center justify-center transition active:scale-95 group relative">
                                                {isGeneratingNote ? <div className="w-5 h-5 border-2 border-orange-400 border-t-transparent rounded-full animate-spin"></div> : 
                                                    <>
                                                        <span className="flex items-center"><span className="text-lg mr-2">ğŸ•µï¸â€â™‚ï¸</span> é¿å‘æŒ‡å—</span>
                                                        {currentCard.aiNote && <div className="absolute top-2 right-2 w-2 h-2 bg-orange-500 rounded-full"></div>}
                                                    </>
                                                }
                                            </button>
                                            {/* 2. é•¿éš¾å¥æ‰‹æœ¯åˆ€ */}
                                            <button onClick={(e) => performSyntaxSurgery(e, false)} disabled={syntaxLoading} className="py-4 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-2xl text-purple-600 font-bold flex flex-col items-center justify-center transition active:scale-95 relative">
                                                {syntaxLoading ? <div className="w-5 h-5 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div> : 
                                                    <>
                                                        <span className="flex items-center"><span className="text-lg mr-2">ğŸ§¬</span> é•¿éš¾å¥åˆ‡ç‰‡</span>
                                                        {currentCard.aiSyntax && <div className="absolute top-2 right-2 w-2 h-2 bg-purple-500 rounded-full"></div>}
                                                    </>
                                                }
                                            </button>
                                        </div>
                                        
                                        {/* åŠ¨æ€ç¬”è®°å±•ç¤ºåŒº (æ”¯æŒé‡ç½®) */}
                                        {currentCard.aiNote && (
                                            <div className="bg-orange-50 rounded-2xl border border-orange-100 p-5 shadow-sm animate-fade-in relative group">
                                                <div className="flex items-center justify-between mb-3">
                                                    <span className="text-orange-800 font-bold flex items-center"><span className="text-xl mr-2">ğŸ”¥</span> é¿å‘ & è¾¨æ</span>
                                                    <button onClick={(e)=>generateWordNote(e, true)} className="text-orange-400 hover:text-orange-600 text-xs bg-white/50 px-2 py-1 rounded border border-orange-200 transition">ğŸ”„ åˆ·æ–°</button>
                                                </div>
                                                <div className="markdown-body text-sm text-gray-700 leading-relaxed" dangerouslySetInnerHTML={{ __html: marked.parse(currentCard.aiNote) }} />
                                            </div>
                                        )}
                                        
                                        <div className="h-20"></div> 
                                    </div>
                                    <div className="flex-shrink-0 absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 md:p-6 flex space-x-3 md:space-x-6 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.1)] z-20">
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(1);}} className="flex-1 btn-press bg-red-50 hover:bg-red-100 text-red-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-red-100"><span>ä¸è®¤è¯†</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(2);}} className="flex-1 btn-press bg-yellow-50 hover:bg-yellow-100 text-yellow-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-yellow-100"><span>ä¸ç†Ÿ</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(3);}} className="flex-1 btn-press bg-green-50 hover:bg-green-100 text-green-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-green-100"><span>è®¤è¯†</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ğŸ”¥ é•¿éš¾å¥åˆ†ææ¨¡æ€æ¡† */}
                    {syntaxModal.open && (
                        <div className="fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in" onClick={() => setSyntaxModal({ ...syntaxModal, open: false })}>
                            <div className="bg-white w-full md:max-w-2xl h-[85vh] md:h-[80vh] rounded-t-2xl md:rounded-2xl shadow-2xl flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-purple-50">
                                    <h3 className="font-bold text-purple-900 flex items-center"><span className="text-xl mr-2">ğŸ§¬</span> è¯­æ³•æ‰‹æœ¯å°</h3>
                                    <div className="flex items-center gap-2">
                                        {/* ğŸ”„ é‡ç½®æŒ‰é’® */}
                                        <button onClick={(e) => performSyntaxSurgery(e, true)} className="px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs font-bold rounded-lg transition flex items-center"><span className="mr-1">ğŸ”„</span> é‡æ–°ç”Ÿæˆ</button>
                                        <button onClick={() => setSyntaxModal({ ...syntaxModal, open: false })} className="p-2 hover:bg-purple-100 rounded-full text-purple-800"><Icon name="X" size={20} /></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 custom-scroll bg-white">
                                    {syntaxModal.content ? (
                                        <div className="markdown-body text-gray-800 leading-relaxed space-y-4" dangerouslySetInnerHTML={{ __html: marked.parse(syntaxModal.content) }} />
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full space-y-4 text-purple-400">
                                            <div className="w-10 h-10 border-4 border-purple-200 border-t-purple-500 rounded-full animate-spin"></div>
                                            <p>æ­£åœ¨æ„é€ é•¿éš¾å¥å¹¶è¿›è¡Œè§£å‰–...</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
                                        
        
      const ImportExport = ({ setWords, words, setView, config }) => {
            const [activeTab, setActiveTab] = useState('data');
            const [textInput, setTextInput] = useState('');
            const [importMode, setImportMode] = useState('frequency');
            const [importCategory, setImportCategory] = useState('high');
            const [customGroupName, setCustomGroupName] = useState('');
            const [isNewBatch, setIsNewBatch] = useState(false);
            const [importBatchName, setImportBatchName] = useState(''); 
            
            const [aiInput, setAiInput] = useState('');
            const [isFetching, setIsFetching] = useState(false);
            const [fetchProgress, setFetchProgress] = useState({ current: 0, total: 0, success: 0, fail: 0 });

            const getTargetCategory = () => { if (importMode === 'frequency') return importCategory; return customGroupName.trim() || `Import ${new Date().toLocaleDateString()}`; };
            const saveBatchMeta = (batchId) => { if (isNewBatch && importBatchName.trim()) { try { const metaStr = localStorage.getItem('kaoyan_group_meta'); const meta = metaStr ? JSON.parse(metaStr) : {}; meta[batchId] = { name: importBatchName.trim(), desc: "" }; localStorage.setItem('kaoyan_group_meta', JSON.stringify(meta)); } catch (e) { console.error(e); } } };

            const parseMultiPos = (rawWord, fullText) => {
                let remains = fullText.substring(rawWord.length).trim();
                const parts = remains.split(/(?:^|\s+)([a-z]{1,5}\.)\s+/).filter(p => p.trim());
                const meanings = [];
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.match(/^[a-z]{1,5}\.$/)) { const def = parts[i+1] || ""; meanings.push({ pos: part, def: def.trim(), sentence: "", isMastered: false }); i++; } 
                    else if(i === 0) meanings.push({ pos: "mix.", def: part.trim(), sentence: "", isMastered: false });
                }
                return meanings;
            };

            const parseAndImport = () => { 
                if(!textInput.trim()) return;
                const targetCat = getTargetCategory(); const segments = textInput.split(/[;\n]+/);
                let addedCount = 0, mergedCount = 0; let currentWords = JSON.parse(JSON.stringify(words)); 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default'; saveBatchMeta(batchId);
                segments.forEach((seg, idx) => {
                    seg = seg.trim(); if (!seg) return;
                    const matchHead = seg.match(/^([a-zA-Z\-\s]+?)\s+/);
                    if (matchHead) {
                        const rawWord = matchHead[1].trim(); const parsedMeanings = parseMultiPos(rawWord, seg);
                        if (parsedMeanings.length > 0) {
                            const existingIdx = currentWords.findIndex(w => w.word.toLowerCase() === rawWord.toLowerCase());
                            if (!isNewBatch && existingIdx !== -1) { const existingWord = currentWords[existingIdx]; parsedMeanings.forEach(nm => { if (!existingWord.meanings.some(om => om.pos === nm.pos && om.def === nm.def)) existingWord.meanings.push(nm); }); mergedCount++; } 
                            else { currentWords.push({ id: `auto-${Date.now()}-${idx}`, word: rawWord, phonetic: "", category: targetCat, importId: batchId, meanings: parsedMeanings, stats: { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 } }); addedCount++; }
                        }
                    }
                });
                if (addedCount > 0 || mergedCount > 0) { setWords(currentWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords)); alert(`å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${addedCount}, åˆå¹¶: ${mergedCount}`); setTextInput(''); setImportBatchName(''); } else alert("æ ¼å¼é”™è¯¯");
            };

            const repairData = () => {
                let fixedCount = 0;
                const newWords = words.map(w => {
                    let needsFix = false; let newMeanings = [];
                    w.meanings.forEach(m => {
                        const parts = m.def.split(/\s+([a-z]{1,4}\.)\s+/);
                        if (parts.length > 1) { needsFix = true; newMeanings.push({ ...m, def: parts[0].trim() }); for (let i = 1; i < parts.length; i += 2) if (parts[i+1]) newMeanings.push({ pos: parts[i], def: parts[i+1].trim(), sentence: "", isMastered: false }); } else newMeanings.push(m);
                    });
                    if (needsFix) { fixedCount++; return { ...w, meanings: newMeanings }; } return w;
                });
                if (fixedCount > 0) { setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); alert(`ğŸ‰ ä¿®å¤æˆåŠŸï¼æ•´ç†äº† ${fixedCount} ä¸ªå•è¯ã€‚`); } else alert("æš‚æœªå‘ç°æ ¼å¼é”™ä¹±çš„å•è¯ã€‚");
            };

            // ğŸ”¥ å¼ºåŠ›æ‹†åˆ†ï¼ŒåŒ…å«é€—å·ï¼
            const deepSplitMeanings = () => {
                let splitCount = 0;
                let wordCount = 0;
                const newWords = words.map(w => {
                    let hasSplit = false;
                    let newMeanings = [];
                    w.meanings.forEach(m => {
                        const separators = /[;ï¼›ï¼Œ]|\s\d+\.\s/; 
                        if (m.def.match(separators)) {
                            hasSplit = true;
                            // æ‹†åˆ†
                            const parts = m.def.split(separators)
                                .map(s => s.trim().replace(/^\d+\.\s*/, ''))
                                .filter(s => s && s.length > 0);
                            
                            parts.forEach(part => {
                                // æ£€æŸ¥å»é‡
                                if (!newMeanings.some(nm => nm.pos === m.pos && nm.def === part)) {
                                    newMeanings.push({ ...m, def: part, sentence: m.sentence || "" }); 
                                    splitCount++;
                                }
                            });
                        } else {
                            newMeanings.push(m);
                        }
                    });
                    if (hasSplit) wordCount++;
                    return { ...w, meanings: newMeanings };
                });

                if (splitCount > 0) {
                    setWords(newWords);
                    localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                    alert(`ğŸ”ª é‡Šä¹‰æ‹†åˆ†å®Œæˆï¼\n\nå¤„ç†äº† ${wordCount} ä¸ªå•è¯\n\nç°åœ¨å»èƒŒå•è¯é¡µé¢ï¼Œä½ ä¼šå‘ç°ï¼š\n1. åŒä¸€è¯æ€§çš„æ„æ€è¢«ã€åˆå¹¶ã€‘åœ¨ä¸€ä¸ªæ¡†é‡Œäº†ï¼ˆä¸ä¹±äº†ï¼‰\n2. æ¡†é‡Œçš„æ¯ä¸€è¡Œæ„æ€éƒ½å¯ä»¥ã€å•ç‹¬éšè—ã€‘äº†ï¼ˆæ»¡è¶³ä½ çš„éœ€æ±‚ï¼‰`);
                } else {
                    alert("æ•°æ®çœ‹èµ·æ¥å·²ç»æ˜¯æ‹†åˆ†å¥½çš„çŠ¶æ€äº†ï¼Œå¯ä»¥ç›´æ¥å»èƒŒå•è¯ï¼");
                }
            };

            const fetchWordsFromAI = async () => {
                if (!config.apiKey) { alert("è¯·é…ç½® Key"); return; } if (!aiInput.trim()) return; const wordList = aiInput.split(/[\s,\n]+/).filter(w => w.trim().match(/^[a-zA-Z\-]+$/)); if(wordList.length===0) return;
                setIsFetching(true); setFetchProgress({ current: 0, total: wordList.length, success: 0, fail: 0 }); const targetCat = getTargetCategory(); 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default'; saveBatchMeta(batchId);
                const BATCH_SIZE = 5; let currentWords = JSON.parse(JSON.stringify(words)); let successCount = 0; let failCount = 0;
                for (let i = 0; i < wordList.length; i += BATCH_SIZE) {
                    const batch = wordList.slice(i, i + BATCH_SIZE); const batchStr = batch.join(", "); const prompt = `è€ƒç ”å•è¯æŸ¥è¯¢JSON:[${batchStr}]`;
                    try {
                        let jsonStr=""; if(config.type==='google'){ const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey.trim()}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})}); const data=await res.json(); jsonStr=data.candidates?.[0]?.content?.parts?.[0]?.text; } else { let baseUrl=config.baseUrl.replace(/\/$/,""); if(!baseUrl.includes("/v1")&&!baseUrl.includes("aliyuncs")&&!baseUrl.includes("bigmodel")&&!baseUrl.includes("lingyiwanwu")&&!baseUrl.includes("siliconflow"))baseUrl+="/v1"; const res=await fetch(`${baseUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${config.apiKey.trim()}`},body:JSON.stringify({model:config.model,messages:[{role:"user",content:prompt}]})}); const data=await res.json(); jsonStr=data.choices?.[0]?.message?.content; }
                        if(!jsonStr) throw new Error("Empty"); jsonStr=jsonStr.replace(/```json/g,'').replace(/```/g,'').trim(); const parsedBatch=JSON.parse(jsonStr);
                        if(Array.isArray(parsedBatch)){ parsedBatch.forEach(item=>{ const existIdx=currentWords.findIndex(w=>w.word.toLowerCase()===item.word.toLowerCase()); const meanings=item.meanings.map(m=>({...m,sentence:"",isMastered:false})); if(!isNewBatch && existIdx!==-1){ item.meanings.forEach(nm=>{ if(!currentWords[existIdx].meanings.some(om=>om.pos===nm.pos && om.def===nm.def)) currentWords[existIdx].meanings.push({...nm,sentence:"",isMastered:false}); }); }else{ currentWords.push({id:`ai-${Date.now()}-${Math.random()}`,word:item.word,phonetic:item.phonetic||"",category:targetCat,importId:batchId,meanings,stats:{interval:0,easeFactor:2.5,nextReview:0,reviewCount:0}}); } }); successCount+=batch.length; }
                    } catch(err){ failCount+=batch.length; }
                    setFetchProgress({ current: Math.min(i+BATCH_SIZE, wordList.length), total: wordList.length, success: successCount, fail: failCount }); setWords([...currentWords]); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords));
                } setIsFetching(false); alert("å®Œæˆ"); setImportBatchName('');
            };

            const handleFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const content = JSON.parse(ev.target.result); if (content.type === 'KAOYAN_FULL_BACKUP' && content.storage) { if(confirm(`æ¢å¤å¤‡ä»½å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ`)) { Object.keys(content.storage).forEach(key => { if(key.startsWith('kaoyan_')) localStorage.setItem(key, content.storage[key]); }); window.location.reload(); } return; } if (Array.isArray(content)) { if(confirm(`å¯¼å…¥æ—§ç‰ˆå•è¯è¡¨?`)) { setWords(content); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(content)); alert("å®Œæˆ"); } return; } } catch(err) { alert("é”™è¯¯"); } }; reader.readAsText(file); };
            const exportFullData = async () => { 
                const storage = {}; for(let i=0; i<localStorage.length; i++) { const key = localStorage.key(i); if(key && key.startsWith('kaoyan_')) storage[key] = localStorage.getItem(key); } 
                const backup = { type: 'KAOYAN_FULL_BACKUP', version: 1.0, timestamp: Date.now(), storage };
                const date = new Date(); const fileName = `è€ƒç ”å¤‡ä»½_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate()}.json`;
                const blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"}); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); 
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">æ•°æ®ä¸­å¿ƒ</h2>
                        <div className="flex mb-6 border-b border-gray-100">
                            <button onClick={() => setActiveTab('data')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='data'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>å¤‡ä»½ä¸æ¢å¤</button>
                            <button onClick={() => setActiveTab('ai')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='ai'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>AI é€ŸæŸ¥</button>
                            <button onClick={() => setActiveTab('text')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='text'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>æ‰¹é‡ç²˜è´´</button>
                        </div>
                        
                        {activeTab === 'data' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="p-4 bg-orange-50 border border-orange-100 rounded-2xl shadow-sm flex flex-col justify-between">
                                        <div><h3 className="font-bold text-orange-900 text-sm mb-1">æ ¼å¼ä¿®å¤</h3><p className="text-xs text-orange-700/70 mb-2">åˆ†ç¦»è¿åœ¨ä¸€èµ·çš„ n. v.</p></div>
                                        <button onClick={repairData} className="w-full py-2 bg-white text-orange-600 border border-orange-200 rounded-lg font-bold text-xs shadow-sm hover:bg-orange-100 transition">ä¿®å¤</button>
                                    </div>
                                    <div className="p-4 bg-purple-50 border border-purple-100 rounded-2xl shadow-sm flex flex-col justify-between">
                                        <div><h3 className="font-bold text-purple-900 text-sm mb-1">æ·±åº¦ç»†åˆ†é‡Šä¹‰</h3><p className="text-xs text-purple-700/70 mb-2">ç‚¸å¼€é€—å·/åˆ†å·/åºå·</p></div>
                                        <button onClick={deepSplitMeanings} className="w-full py-2 bg-white text-purple-600 border border-purple-200 rounded-lg font-bold text-xs shadow-sm hover:bg-purple-100 transition">å¼€å§‹æ‹†åˆ†</button>
                                    </div>
                                </div>

                                <div className="p-6 bg-indigo-50 rounded-2xl border border-indigo-100 shadow-sm">
                                    <div className="flex items-center mb-4"><Icon name="Folder" size={24} className="mr-2 text-indigo-600"/><h3 className="font-bold text-indigo-900 text-lg">æœ¬åœ°å¤‡ä»½</h3></div>
                                    <p className="text-indigo-800/80 text-xs mb-4">ç”Ÿæˆ .json æ–‡ä»¶å¹¶ä¿å­˜åˆ°æ‰‹æœº/ç”µè„‘ï¼Œå®‰å…¨å¯é ã€‚</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={exportFullData} className="py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm hover:bg-indigo-50 flex flex-col items-center justify-center transition">
                                            <Icon name="Upload" size={20} className="mb-1"/><span className="text-xs">å¯¼å‡ºæ–‡ä»¶</span>
                                        </button>
                                        <div className="relative">
                                            <button className="w-full h-full py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm hover:bg-indigo-50 flex flex-col items-center justify-center transition">
                                                <Icon name="Download" size={20} className="mb-1"/><span className="text-xs">å¯¼å…¥æ–‡ä»¶</span>
                                            </button>
                                            <input type="file" onChange={handleFile} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-100 text-center">
                                    <button onClick={() => {if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) { setWords([]); localStorage.clear(); window.location.reload(); }}} className="text-red-400 text-xs hover:text-red-600 underline transition">é‡ç½®åº”ç”¨ (æ¸…ç©ºæ•°æ®)</button>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'ai' || activeTab === 'text') && (
                            <div className="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <div className="flex space-x-6 mb-4">
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='frequency'} onChange={()=>setImportMode('frequency')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">å­˜å…¥è€ƒé¢‘</span></label>
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='group'} onChange={()=>setImportMode('group')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">è‡ªå®šä¹‰åˆ†ç»„</span></label>
                                </div>
                                {importMode==='frequency' ? (<div className="grid grid-cols-4 gap-2 mb-4">{['high','medium','low','zero'].map(cat=>(<button key={cat} onClick={()=>setImportCategory(cat)} className={`py-2 text-sm rounded-lg border ${importCategory===cat?'bg-indigo-600 text-white':'bg-white text-gray-600'}`}>{cat}</button>))}</div>) : (<div className="mb-4"><input type="text" value={customGroupName} onChange={e=>setCustomGroupName(e.target.value)} placeholder="è¾“å…¥åˆ†ç»„åç§°" className="w-full p-3 border rounded-lg text-sm outline-none"/></div>)}
                                <label className="flex items-center pt-4 border-t border-gray-200 cursor-pointer"><input type="checkbox" checked={isNewBatch} onChange={e=>setIsNewBatch(e.target.checked)} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-bold text-gray-700">ç‹¬ç«‹ä¸ºæ–°æ‰¹æ¬¡</span></label>
                                {isNewBatch && (<div className="mt-4 animate-fade-in"><input type="text" value={importBatchName} onChange={e=>setImportBatchName(e.target.value)} placeholder="ä¾‹å¦‚: 2015çœŸé¢˜" className="w-full p-3 border border-indigo-200 bg-indigo-50 rounded-lg text-sm outline-none"/></div>)}
                            </div>
                        )}

                        {activeTab === 'ai' && (<div className="space-y-4"><textarea value={aiInput} onChange={e => setAiInput(e.target.value)} placeholder="è¾“å…¥å•è¯..." className="w-full h-40 p-4 border rounded-xl text-sm outline-none resize-none"></textarea>{isFetching ? <div className="text-center text-sm py-3 bg-indigo-50 text-indigo-600 rounded-xl animate-pulse">AI æŠ“å–ä¸­...</div> : <button onClick={fetchWordsFromAI} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Icon name="CloudDownload" size={20}/> å¼€å§‹</button>}</div>)}
                        {activeTab === 'text' && (<div className="space-y-4"><textarea value={textInput} onChange={e => setTextInput(e.target.value)} placeholder="æ ¼å¼ï¼šword n. é‡Šä¹‰ v. é‡Šä¹‰..." className="w-full h-48 p-4 border rounded-xl text-sm outline-none resize-none"></textarea><button onClick={parseAndImport} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">å¼€å§‹å¯¼å…¥</button></div>)}
                    </div>
                </div>
            );
        };

      const SettingsPanel = ({ config, setConfig, setView }) => {
            const [selectedPreset, setSelectedPreset] = useState('deepseek');
            const [models, setModels] = useState([]);
            const [isFetching, setIsFetching] = useState(false);
            const [showModelPicker, setShowModelPicker] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            
            useEffect(() => {
                const matchedKey = Object.keys(API_PRESETS).find(key => {
                    const preset = API_PRESETS[key];
                    return preset.type === config.type && (preset.type === 'google' || config.baseUrl.includes(preset.url));
                });
                if (matchedKey) setSelectedPreset(matchedKey); else setSelectedPreset('custom');
            }, []);

            const handlePresetChange = (key) => {
                setSelectedPreset(key);
                const preset = API_PRESETS[key];
                setConfig(prev => ({ ...prev, type: preset.type, baseUrl: preset.url }));
                // åˆ‡æ¢é¢„è®¾æ—¶æ¸…ç©ºå·²åŠ è½½çš„æ¨¡å‹åˆ—è¡¨
                setModels([]); 
                setShowModelPicker(false);
            };

            const updateConfigTrimmed = (key, value) => setConfig(prev => ({ ...prev, [key]: value.trim() }));

            // ğŸ”¥ æ–°å¢ï¼šè·å–æ¨¡å‹åˆ—è¡¨çš„åŠŸèƒ½
            const fetchModels = async () => {
                if (!config.apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
                if (selectedPreset === 'google') return alert("Google Gemini æš‚ä¸æ”¯æŒè‡ªåŠ¨è·å–åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åï¼ˆå¦‚ gemini-proï¼‰");
                
                setIsFetching(true);
                try {
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    
                    const res = await fetch(`${baseUrl}/models`, {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${config.apiKey}` }
                    });
                    
                    if (!res.ok) throw new Error("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ– URL");
                    const data = await res.json();
                    
                    // å…¼å®¹ä¸åŒå‚å•†çš„è¿”å›æ ¼å¼
                    let list = [];
                    if (Array.isArray(data.data)) list = data.data; // OpenAI æ ‡å‡†
                    else if (Array.isArray(data)) list = data; // æŸäº›å…¼å®¹æ¥å£
                    
                    if (list.length > 0) {
                        // æŒ‰å­—æ¯æ’åº
                        list.sort((a, b) => (a.id || a).localeCompare(b.id || b));
                        setModels(list);
                        setShowModelPicker(true);
                    } else {
                        alert("æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");
                    }
                } catch (e) {
                    alert("è·å–å¤±è´¥: " + e.message);
                } finally {
                    setIsFetching(false);
                }
            };

            const filteredModels = models.filter(m => {
                const id = typeof m === 'string' ? m : m.id;
                return id.toLowerCase().includes(searchQuery.toLowerCase());
            });

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit space-y-6">
                        <h2 className="text-xl font-bold border-b border-gray-100 pb-4 text-gray-800">è®¾ç½®</h2>
                        <div className="pt-2">
                            <label className="block text-sm font-bold text-gray-700 mb-2">AI å‚å•† (é¢„è®¾)</label>
                            <select value={selectedPreset} onChange={(e) => handlePresetChange(e.target.value)} className="w-full border border-gray-200 p-3 rounded-xl bg-white outline-none mb-3 focus:ring-2 focus:ring-indigo-500">
                                {Object.entries(API_PRESETS).map(([key, val]) => (<option key={key} value={key}>{val.name}</option>))}
                            </select>
                            
                            <div className={selectedPreset === 'google' ? 'hidden' : 'block animate-fade-in'}>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">API Base URL</label>
                                <input value={config.baseUrl} onChange={e => updateConfigTrimmed('baseUrl', e.target.value)} className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 mb-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://api.openai.com/v1" disabled={selectedPreset !== 'custom'}/>
                            </div>
                            
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">API Key</label>
                            <input value={config.apiKey} onChange={e => updateConfigTrimmed('apiKey', e.target.value)} type="password" placeholder="sk-..." className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 mb-3 outline-none focus:ring-2 focus:ring-indigo-500"/>
                            
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">æ¨¡å‹åç§° (Model)</label>
                            <div className="relative">
                                <div className="flex gap-2">
                                    <input value={config.model} onChange={e => updateConfigTrimmed('model', e.target.value)} placeholder="ä¾‹å¦‚: gpt-3.5-turbo" className="flex-1 border border-gray-200 p-3 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"/>
                                    <button onClick={fetchModels} disabled={isFetching || !config.apiKey} className="px-4 bg-indigo-50 text-indigo-600 rounded-xl font-bold hover:bg-indigo-100 transition whitespace-nowrap disabled:opacity-50 flex items-center">
                                        {isFetching ? <div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mr-1"></div> : <Icon name="CloudDownload" size={18} className="mr-1"/>}
                                        {isFetching ? "è·å–ä¸­" : "é€‰æ¨¡å‹"}
                                    </button>
                                </div>

                                {/* ğŸ”¥ æ¨¡å‹é€‰æ‹©å¼¹çª—/ä¸‹æ‹‰åˆ—è¡¨ */}
                                {showModelPicker && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 overflow-hidden animate-fade-in ring-1 ring-black/5">
                                        <div className="p-2 border-b border-gray-100 bg-gray-50">
                                            <input 
                                                type="text" 
                                                placeholder="ğŸ” æœç´¢æ¨¡å‹..." 
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full p-2 text-sm bg-white border border-gray-200 rounded-lg outline-none focus:border-indigo-500"
                                                autoFocus
                                            />
                                        </div>
                                        <div className="max-h-60 overflow-y-auto custom-scroll">
                                            {filteredModels.length === 0 ? (
                                                <div className="p-4 text-center text-gray-400 text-sm">æœªæ‰¾åˆ°ç›¸å…³æ¨¡å‹</div>
                                            ) : (
                                                filteredModels.map((m, idx) => {
                                                    const id = typeof m === 'string' ? m : m.id;
                                                    return (
                                                        <div 
                                                            key={idx} 
                                                            onClick={() => { updateConfigTrimmed('model', id); setShowModelPicker(false); }}
                                                            className={`px-4 py-3 text-sm cursor-pointer hover:bg-indigo-50 transition flex justify-between items-center ${config.model === id ? 'bg-indigo-50 text-indigo-700 font-bold' : 'text-gray-700'}`}
                                                        >
                                                            <span>{id}</span>
                                                            {config.model === id && <Icon name="Check" size={14}/>}
                                                        </div>
                                                    )
                                                })
                                            )}
                                        </div>
                                        <div className="p-2 bg-gray-50 border-t border-gray-100 text-center">
                                            <button onClick={() => setShowModelPicker(false)} className="text-xs text-gray-500 hover:text-gray-700">å…³é—­åˆ—è¡¨</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <button onClick={()=>{ localStorage.setItem('kaoyan_config', JSON.stringify(config)); setView('home'); }} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg transition active:scale-95">ä¿å­˜é…ç½®</button>
                    </div>
                    {/* ç‚¹å‡»é®ç½©å…³é—­ä¸‹æ‹‰æ¡† */}
                    {showModelPicker && <div className="fixed inset-0 z-40" onClick={() => setShowModelPicker(false)}></div>}
                </div>
            );
        };
        
        const App = () => {
            const [view, setView] = useState('home');
            const [words, setWords] = useState([]);
            const [sessionConfig, setSessionConfig] = useState({}); 
            const [config, setConfig] = useState({ type: 'openai', baseUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat', groupSize: 208, autoSync: false });
            const [chatSession, setChatSession] = useState(null);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('kaoyan_vocab_list');
                    const savedCfg = localStorage.getItem('kaoyan_config');
                    if (saved) setWords(JSON.parse(saved));
                    if (savedCfg) setConfig(JSON.parse(savedCfg));
                } catch(e) {}
                const loader = document.getElementById('root').querySelector('div');
                if(loader && loader.style.border) loader.remove();
            }, []);

            const handleBack = () => {
                if (view === 'study') {
                    if (sessionConfig.type === 'group_study') setView('group_list');
                    else setView('home');
                } else if (view === 'group_list') setView('home');
                else setView('home');
            };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <Navbar view={view} setView={setView} />
                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        {view === 'home' && <Dashboard words={words} setView={setView} setSessionConfig={setSessionConfig} />}
                        {view === 'group_list' && <GroupList words={words} setWords={setWords} category={sessionConfig.category} setView={setView} setSessionConfig={setSessionConfig} config={config} />}
                        {view === 'study' && <StudySession words={words} setWords={setWords} sessionConfig={sessionConfig} onExit={handleBack} config={config} setChatSession={setChatSession} />}
                        {view === 'list' && <WordListMode words={words} setWords={setWords} setChatSession={setChatSession} />}
                        {view === 'import' && <ImportExport setWords={setWords} words={words} setView={setView} config={config} />}
                        {view === 'settings' && <SettingsPanel config={config} setConfig={setConfig} setView={setView} />}
{chatSession && (<div className="absolute inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in"><WordChat word={chatSession} words={words} setWords={setWords} onClose={() => setChatSession(null)} config={config} /></div>)}                    </main>
                    <style>{`
                        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
                        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
                        .animate-fade-in { animation: fade-in 0.2s ease-out; }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
