<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€ƒç ”è¯æ±‡å¤§å¸ˆ - ç»ˆæå†²åˆºç‰ˆ</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.staticfile.net/lz-string/1.4.4/lz-string.min.js"></script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        .scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        @media (min-width: 768px) { .card-face { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } }
        .card-face-back { transform: rotateY(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body strong { color: inherit; font-weight: 700; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body code { background-color: rgba(0,0,0,0.05); padding: 0.1em 0.3em; border-radius: 3px; font-family: monospace; }
        
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">èµ„æºåŠ è½½ä¸­...</p>
        </div>
        <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var root = document.getElementById('root');
            root.innerHTML = '<div style="padding:20px;text-align:center;color:red;"><h3>å‘ç”Ÿé”™è¯¯</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const Icons = {
            Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Maximize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
            Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            MessageCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Palette: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Dna: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 15c6.667-6 13.333 0 20-6"/><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993"/><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993"/><path d="M17 6l-2.5-2.5"/><path d="M14 8l-1-1"/><path d="M7 18l2.5 2.5"/><path d="M3.5 14.5l.5.5"/><path d="M20 9l.5.5"/><path d="M6.5 6.5l1 1"/><path d="M16.5 16.5l1 1"/></svg>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const Svg = Icons[name] || Icons.Book;
            return <span className={`flex justify-center items-center ${className}`} style={{ width: size, height: size }}><Svg /></span>;
        };

        const API_PRESETS = {
            "deepseek": { name: "DeepSeek (æ·±åº¦æ±‚ç´¢)", type: "openai", url: "https://api.deepseek.com" },
            "siliconflow": { name: "SiliconFlow (ç¡…åŸºæµåŠ¨)", type: "openai", url: "https://api.siliconflow.cn/v1" },
            "openai": { name: "OpenAI (å®˜æ–¹)", type: "openai", url: "https://api.openai.com/v1" },
            "moonshot": { name: "Moonshot (Kimi)", type: "openai", url: "https://api.moonshot.cn/v1" },
            "zhipu": { name: "æ™ºè°±AI (GLM)", type: "openai", url: "https://open.bigmodel.cn/api/paas/v4" },
            "aliyun": { name: "é˜¿é‡Œäº‘ (é€šä¹‰åƒé—®)", type: "openai", url: "https://dashscope.aliyuncs.com/compatible-mode/v1" },
            "yi": { name: "é›¶ä¸€ä¸‡ç‰© (Yi)", type: "openai", url: "https://api.lingyiwanwu.com/v1" },
            "google": { name: "Google (Gemini)", type: "google", url: "" },
            "custom": { name: "è‡ªå®šä¹‰ (OpenAIå…¼å®¹)", type: "openai", url: "" }
        };

        const logActivity = (count = 1) => {
            try {
                const data = JSON.parse(localStorage.getItem('kaoyan_activity') || '{}');
                const today = new Date().toISOString().split('T')[0];
                data[today] = (data[today] || 0) + count;
                localStorage.setItem('kaoyan_activity', JSON.stringify(data));
            } catch(e){}
        };

        const AudioController = {
            current: null,
            play: (text, onEnd) => {
                AudioController.stop();
                const cleanText = text.replace(/[\*\#\-\>]/g, '');
                if (cleanText.length < 200) {
                    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encodeURIComponent(cleanText)}`);
                    AudioController.current = audio;
                    audio.onended = onEnd;
                    audio.onerror = () => AudioController.playSystem(cleanText, onEnd);
                    audio.play().catch(() => AudioController.playSystem(cleanText, onEnd));
                } else {
                    AudioController.playSystem(cleanText, onEnd);
                }
            },
            playSystem: (text, onEnd) => {
                if (!('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                const voices = window.speechSynthesis.getVoices();
                const bestVoice = voices.find(v => v.name.includes("Google US")) || voices.find(v => v.lang === 'en-US');
                if (bestVoice) u.voice = bestVoice;
                u.onend = onEnd;
                u.onerror = onEnd;
                AudioController.current = u;
                window.speechSynthesis.speak(u);
            },
            stop: () => {
                if (AudioController.current) {
                    if (AudioController.current instanceof Audio) AudioController.current.pause();
                    else window.speechSynthesis.cancel();
                    AudioController.current = null;
                }
            }
        };

        const calculateNextReview = (rating, currentInterval, easeFactor, currentReviewCount) => {
            let nextInterval, nextEaseFactor = easeFactor;
            const newReviewCount = (currentReviewCount || 0) + 1;
            if (rating === 1) { 
                return { interval: 0, easeFactor: Math.max(1.3, easeFactor - 0.2), isDueNow: true, reviewCount: newReviewCount };
            } else if (rating === 2) { 
                return { interval: 0.5, easeFactor: Math.max(1.3, easeFactor - 0.15), isDueNow: true, reviewCount: newReviewCount }; 
            } else { 
                if (currentInterval === 0) nextInterval = 1; 
                else if (currentInterval === 1) nextInterval = 3;
                else nextInterval = Math.round(currentInterval * easeFactor);
                return { interval: nextInterval, easeFactor: easeFactor + 0.1, isDueNow: false, reviewCount: newReviewCount };
            }
        };

        const WordChat = ({ word, onClose, config }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [playingIdx, setPlayingIdx] = useState(null);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                setMessages([{ role: "assistant", content: `Hi! æˆ‘æ˜¯ä½ çš„ä¸“å± AI ç§æ•™ã€‚\næˆ‘ä»¬ä»Šå¤©è¦æ­»ç£•çš„å•è¯æ˜¯ï¼š **${word}**ã€‚\n\næˆ‘èƒ½å¸®ä½ ï¼š\n1. æ‹†è§£è¯æ ¹è¯ç¼€\n2. è®²è€ƒç ”çœŸé¢˜é‡Œçš„å‘\n3. ç¼–é¡ºå£æºœåŠ©è®°` }]);
                handleSend(null, `è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è®²è§£å•è¯ "${word}"ï¼š\n1. **è¯æ ¹è¯ç¼€æ‹†è§£**ï¼ˆè¿™æ˜¯æœ€å…³é”®çš„ï¼‰ï¼šè¯¦ç»†æ‹†åˆ†å¹¶è§£é‡Šæ¯ä¸€éƒ¨åˆ†ã€‚\n2. **æ ¸å¿ƒå«ä¹‰ä¸è€ƒæ³•**ï¼šç»“åˆè€ƒç ”çœŸé¢˜è¯­å¢ƒè§£é‡Šï¼Œåˆ—å‡ºç†Ÿè¯åƒ»ä¹‰ã€‚\n3. **è®°å¿†å£è¯€**ï¼šç»™å‡ºä¸€ä¸ªå¥½è®°çš„é¡ºå£æºœã€‚\nä½¿ç”¨ Markdown æ ¼å¼ï¼Œé‡ç‚¹åŠ ç²—ã€‚`);
                return () => AudioController.stop();
            }, []);

            useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), [messages]);

            const handleSend = async (e, manualContent) => {
                if (e) e.preventDefault();
                const content = manualContent || input.trim();
                if (!content || isLoading) return;
                if (!manualContent) { setMessages(prev => [...prev, { role: "user", content }]); setInput(""); }
                setIsLoading(true);

                try {
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs")) baseUrl += "/v1";
                    const res = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: [{role:"system",content:"ä½ æ˜¯ä¸€ä½è€ƒç ”è‹±è¯­ä¸“å®¶ã€‚"}, ...messages, { role: "user", content }], stream: true })
                    });
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = "";
                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ") && line !== "data: [DONE]") {
                                try {
                                    const delta = JSON.parse(line.slice(6)).choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setMessages(prev => { const n=[...prev]; n[n.length-1].content=fullText; return n; });
                                } catch (e) {}
                            }
                        }
                    }
                } catch (e) { setMessages(prev => [...prev, { role: "error", content: "Error: " + e.message }]); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-white md:fixed md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[90vw] md:max-w-4xl md:h-[85vh] md:rounded-2xl md:shadow-2xl md:border md:border-gray-200 overflow-hidden animate-fade-in">
                    <div className="p-4 border-b flex justify-between items-center bg-white z-10">
                        <h3 className="font-bold text-lg">{word} <span className="text-xs text-gray-400 font-normal ml-2">AI ç§æ•™</span></h3>
                        <button onClick={onClose}><Icon name="X" size={24}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50 custom-scroll">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[90%] p-4 rounded-2xl relative text-sm md:text-base leading-relaxed break-words whitespace-pre-wrap ${msg.role === 'user' ? 'bg-white border border-gray-200' : 'bg-indigo-600 text-white markdown-body'}`}>
                                    {msg.role === 'assistant' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}
                                    {msg.role === 'assistant' && msg.content !== '...' && (
                                        <button onClick={() => { if(playingIdx===idx){AudioController.stop();setPlayingIdx(null);}else{AudioController.play(msg.content, ()=>setPlayingIdx(null));setPlayingIdx(idx);} }} className="absolute -right-8 bottom-0 p-2 text-gray-400 hover:text-indigo-600 bg-white/50 rounded-full shadow-sm transition">
                                            {playingIdx === idx ? <Icon name="Pause" size={16}/> : <Icon name="Volume2" size={16}/>}
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef}/>
                    </div>
                    <div className="p-4 bg-white border-t flex gap-2">
                        <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend()} placeholder="é—®ç‚¹ä»€ä¹ˆ..." className="flex-1 p-3 bg-gray-50 rounded-xl outline-none"/>
                        <button onClick={handleSend} disabled={isLoading} className="p-3 bg-indigo-600 text-white rounded-xl"><Icon name="Send"/></button>
                    </div>
                </div>
            );
        };

        const StoryModal = ({ words, onClose, config }) => {
            const [story, setStory] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            
            useEffect(() => {
                generateStory();
                return () => AudioController.stop();
            }, []);

            const generateStory = async () => {
                if (!config.apiKey) return alert("è¯·å…ˆè®¾ç½® API Key");
                setIsLoading(true);
                const targetWords = words.map(w => w.word).slice(0, 20).join(", ");
                const prompt = `Use these words to write a short, coherent story (max 150 words) in the style of The Economist (sophisticated, academic). Words: [${targetWords}]. 
                Format Requirements: 
                Strictly line by line. 
                Odd line: English sentence. 
                Even line: Chinese translation. 
                Do not output anything else.`;

                try {
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1")) baseUrl += "/v1";
                    const res = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: [{ role: "user", content: prompt }] })
                    });
                    const data = await res.json();
                    const content = data.choices[0].message.content;
                    const lines = content.split('\n').filter(l => l.trim());
                    const pairs = [];
                    for(let i=0; i<lines.length; i+=2) {
                        if(lines[i] && lines[i+1]) pairs.push({ en: lines[i], cn: lines[i+1], showCn: false });
                    }
                    setStory(pairs);
                } catch (e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); onClose(); } 
                finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[70] bg-white md:fixed md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[90vw] md:max-w-3xl md:h-[85vh] md:rounded-2xl md:shadow-2xl overflow-hidden flex flex-col animate-fade-in">
                    <div className="p-4 border-b flex justify-between items-center bg-indigo-50">
                        <h3 className="font-bold text-indigo-900 flex items-center"><Icon name="Sparkles" className="mr-2"/> AI ä¸²çƒ§æ•…äº‹ (é€å¥å¯¹ç…§)</h3>
                        <button onClick={onClose}><Icon name="X"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 md:p-10 custom-scroll bg-white">
                        {isLoading ? (
                            <div className="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                                <div className="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                                <p>æ­£åœ¨ç¼–ç»‡æ•…äº‹...</p>
                            </div>
                        ) : (
                            <div className="space-y-6 max-w-2xl mx-auto">
                                {story.map((pair, idx) => (
                                    <div key={idx} className="group">
                                        <p className="text-lg md:text-xl font-serif text-gray-800 leading-relaxed mb-2 cursor-pointer hover:text-indigo-700 transition" 
                                           onClick={() => AudioController.play(pair.en, () => {})}>
                                            {pair.en} <span className="inline-block ml-2 text-gray-300"><Icon name="Volume2" size={16}/></span>
                                        </p>
                                        <p onClick={() => {const s=[...story]; s[idx].showCn=!s[idx].showCn; setStory(s);}} 
                                           className={`text-sm md:text-base p-2 rounded-lg cursor-pointer transition-all select-none ${pair.showCn ? 'text-gray-600 bg-gray-50' : 'text-transparent bg-gray-100 hover:bg-gray-200'}`}>
                                            {pair.cn}
                                        </p>
                                    </div>
                                ))}
                                <div className="h-20 flex items-center justify-center text-gray-400 text-sm">--- End of Story ---</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SyntaxModal = ({ word, onClose, config }) => {
            const [content, setContent] = useState("");
            
            useEffect(() => {
                const fetchSyntax = async () => {
                    const prompt = `Create a complex sentence using "${word}" (Graduate Exam level). Then analyze its syntax structure using a markdown table (Role | Segment). Finally, translate it.`;
                    try {
                        let baseUrl = config.baseUrl.replace(/\/$/, ""); if (!baseUrl.includes("/v1")) baseUrl += "/v1";
                        const res = await fetch(`${baseUrl}/chat/completions`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                            body: JSON.stringify({ model: config.model, messages: [{ role: "user", content: prompt }] })
                        });
                        const data = await res.json();
                        setContent(data.choices[0].message.content);
                    } catch (e) { setContent("Error loading syntax."); }
                };
                fetchSyntax();
            }, []);

            return (
                <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <h3 className="font-bold text-xl mb-4 flex items-center text-indigo-900"><Icon name="Dna" className="mr-2"/> é•¿éš¾å¥æ‰‹æœ¯åˆ€</h3>
                        {content ? <div className="markdown-body" dangerouslySetInnerHTML={{__html: marked.parse(content)}}/> : <div className="p-10 text-center">Analyzing...</div>}
                    </div>
                </div>
            );
        };

        const Navbar = ({ view, setView }) => {
            return (
                <nav className="bg-indigo-600 text-white shadow-md sticky top-0 z-50 safe-top flex-shrink-0">
                    <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div className="font-bold text-lg cursor-pointer flex items-center space-x-2" onClick={() => setView('home')}>
                            <Icon name="Book" size={24}/> <span className="hidden sm:inline">è€ƒç ”è¯æ±‡å¤§å¸ˆ</span>
                        </div>
                        <div className="flex space-x-2">
                            <button onClick={() => setView('home')} className={`p-2 rounded-lg hover:bg-indigo-500 ${view==='home'?'bg-indigo-700':''}`}><Icon name="Brain"/></button>
                            <button onClick={() => setView('list')} className={`p-2 rounded-lg hover:bg-indigo-500 ${view==='list'?'bg-indigo-700':''}`}><Icon name="List"/></button>
                            <button onClick={() => setView('import')} className={`p-2 rounded-lg hover:bg-indigo-500 ${view==='import'?'bg-indigo-700':''}`}><Icon name="Upload"/></button>
                            <button onClick={() => setView('settings')} className={`p-2 rounded-lg hover:bg-indigo-500 ${view==='settings'?'bg-indigo-700':''}`}><Icon name="Settings"/></button>
                        </div>
                    </div>
                </nav>
            );
        };

        const Dashboard = ({ words, setView, setSessionConfig }) => {
            // ğŸ”¥ ä¿®å¤ç‰ˆç»Ÿè®¡é€»è¾‘ & çƒ­åŠ›å›¾æ•°æ®ç”Ÿæˆ
            const { stats, heatmapData } = useMemo(() => {
                const now = Date.now();
                let due = 0, newW = 0, master = 0, total = words.length;
                
                // è¯»å–æ´»åŠ¨è®°å½• (ç”¨äºçƒ­åŠ›å›¾)
                const activityLog = JSON.parse(localStorage.getItem('kaoyan_activity') || '{}');

                words.forEach(w => {
                    // æ ¸å¿ƒå¤ä¹ ç®—æ³•ä¿®å¤ï¼šå¦‚æœ interval > 0 ä¸” nextReview < nowï¼Œå°±æ˜¯å¾…å¤ä¹ 
                    if (w.stats && w.stats.interval > 0) {
                        if (w.stats.nextReview <= now) due++;
                        else master++; // åªè¦ interval > 0 ä¸”æ²¡åˆ°æœŸï¼Œå°±ç®—æŒæ¡/å­¦ä¹ ä¸­
                    } else {
                        newW++;
                    }
                });

                // ç”Ÿæˆ 30 å¤©çƒ­åŠ›å›¾æ•°ç»„
                const heatmap = [];
                for(let i=29; i>=0; i--) {
                    const d = new Date(); 
                    d.setDate(d.getDate() - i);
                    const k = d.toISOString().split('T')[0];
                    // æ ¹æ®æ´»åŠ¨è®°å½•ç€è‰²ï¼Œå¦‚æœæ²¡æœ‰è®°å½•åˆ™ä¸º 0
                    heatmap.push({ date: k, count: activityLog[k] || 0 });
                }

                return { stats: { due, newW, master, total }, heatmapData: heatmap };
            }, [words]);

            return (
                <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div className="max-w-4xl mx-auto space-y-6">
                        {/* ğŸ”¥ GitHub é£æ ¼çƒ­åŠ›å›¾æ¿å— */}
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">Learning Streak</h3>
                                <span className="text-xs text-gray-400">Last 30 Days</span>
                            </div>
                            <div className="flex justify-between items-end gap-1 h-16">
                                {heatmapData.map((d, i) => (
                                    <div key={i} className="flex-1 flex flex-col justify-end items-center group relative h-full">
                                        <div 
                                            className={`w-full rounded-sm transition-all duration-500 ${d.count===0 ? 'h-1 bg-gray-100' : d.count<10 ? 'h-2/4 bg-green-300' : 'h-full bg-green-500'}`}
                                            style={{minHeight: d.count > 0 ? '20%' : '4px'}}
                                        ></div>
                                        {/* Tooltip */}
                                        <div className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs p-2 rounded shadow-lg whitespace-nowrap z-10">
                                            {d.date}: èƒŒäº† {d.count} ä¸ªè¯
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div onClick={() => { setSessionConfig({type: 'review'}); setView('study'); }} 
                             className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 rounded-3xl shadow-xl text-white cursor-pointer relative overflow-hidden group transform transition hover:scale-[1.01]">
                            <div className="relative z-10">
                                <h2 className="text-3xl font-bold mb-1">å¼€å§‹ä»Šæ—¥å¤ä¹ </h2>
                                <p className="opacity-80">ä½ æœ‰ <span className="font-bold bg-white/20 px-2 rounded">{stats.due}</span> ä¸ªå•è¯éœ€è¦å·©å›º</p>
                            </div>
                            <Icon name="Brain" size={120} className="absolute -right-4 -bottom-4 text-white/10 group-hover:scale-110 transition duration-500"/>
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <div className="text-2xl font-bold text-blue-500">{stats.newW}</div>
                                <div className="text-xs text-gray-400">å¾…å­¦æ–°è¯</div>
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <div className="text-2xl font-bold text-orange-500">{stats.due}</div>
                                <div className="text-xs text-gray-400">ä»Šæ—¥åˆ°æœŸ</div>
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <div className="text-2xl font-bold text-green-500">{Math.round((stats.master/stats.total)*100 || 0)}%</div>
                                <div className="text-xs text-gray-400">æ€»è¿›åº¦</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GroupList = ({ words, setWords, category, setView, setSessionConfig, config }) => {
            const [openStory, setOpenStory] = useState(null);
            
            const groups = useMemo(() => {
                // ç­›é€‰å½“å‰åˆ†ç±»
                const catWords = words.filter(w => (w.category || 'uncategorized') === category);
                // æŒ‰æ¯ 50 ä¸ªè¯åˆ†ç»„
                const chunk = 50;
                const res = [];
                for (let i=0; i<catWords.length; i+=chunk) {
                    const groupWords = catWords.slice(i, i+chunk);
                    // è®¡ç®—ç†Ÿç»ƒåº¦åˆ†å¸ƒ
                    const newC = groupWords.filter(w => !w.stats || w.stats.interval===0).length;
                    const masterC = groupWords.filter(w => w.stats && w.stats.interval>20).length; 
                    const learningC = groupWords.length - newC - masterC;
                    res.push({ id: i, title: `Group ${Math.floor(i/chunk)+1}`, words: groupWords, newC, masterC, learningC, total: groupWords.length });
                }
                return res;
            }, [words, category]);

            return (
                <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div className="max-w-4xl mx-auto space-y-4">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 capitalize border-l-4 border-indigo-600 pl-3">{category} Vocabulary</h2>
                        {groups.map(g => (
                            <div key={g.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div className="flex-1">
                                    <div className="flex justify-between items-baseline mb-2">
                                        <h3 className="font-bold text-lg text-gray-800">{g.title}</h3>
                                        <span className="text-xs text-gray-400">{g.masterC}/{g.total} Mastered</span>
                                    </div>
                                    {/* å½©è‰²è¿›åº¦æ¡ */}
                                    <div className="flex h-2.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                        <div className="bg-green-500 h-full" style={{width: `${(g.masterC/g.total)*100}%`}} title="Mastered"></div>
                                        <div className="bg-yellow-400 h-full" style={{width: `${(g.learningC/g.total)*100}%`}} title="Learning"></div>
                                    </div>
                                </div>
                                <div className="flex gap-3 shrink-0">
                                    {/* âœ¨ AI ä¸²çƒ§æ•…äº‹å…¥å£ */}
                                    <button onClick={() => setOpenStory(g.words)} className="flex-1 md:flex-none px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100 transition flex items-center justify-center gap-2 border border-indigo-100">
                                        <Icon name="Sparkles" size={16}/> ä¸²çƒ§æ•…äº‹
                                    </button>
                                    <button onClick={() => {setSessionConfig({type:'group_study', category, batchIndex: g.id/50, batchId: 'default' }); setView('study');}} className="flex-1 md:flex-none px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg transition">
                                        Start
                                    </button>
                                </div>
                            </div>
                        ))}
                        {groups.length === 0 && <div className="text-center py-10 text-gray-400">æ­¤åˆ†ç±»ä¸‹æ²¡æœ‰å•è¯</div>}
                    </div>
                    {/* æ•…äº‹æ¨¡æ€æ¡† */}
                    {openStory && <StoryModal words={openStory} onClose={() => setOpenStory(null)} config={config} />}
                </div>
            );
        };

        const StudySession = ({ words, setWords, sessionConfig, onExit, config, setChatSession }) => {
            const [queue, setQueue] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            const [showSyntax, setShowSyntax] = useState(false);
            const [isGeneratingNote, setIsGeneratingNote] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false);

            useEffect(() => {
                const now = Date.now();
                let q = [];
                if (sessionConfig.type === 'review') {
                    // ä¿®å¤ç®—æ³•ï¼šåªå–çœŸæ­£åˆ°æœŸçš„ (interval > 0 ä¸” time <= now)
                    q = words.filter(w => w.stats && w.stats.interval > 0 && w.stats.nextReview <= now);
                    // å¦‚æœå¤ä¹ çš„å¤ªå°‘ï¼Œè¡¥ä¸€ç‚¹æ–°è¯ (interval == 0)
                    if (q.length < 15) {
                        const newWords = words.filter(w => !w.stats || w.stats.interval === 0).slice(0, 20);
                        q = [...q, ...newWords];
                    }
                    // ä¹±åº
                    q = q.sort(() => Math.random() - 0.5).slice(0, 40);
                } else {
                    // Group study: ç²¾ç¡®åˆ‡ç‰‡
                    const catWords = words.filter(w => (w.category || 'uncategorized') === sessionConfig.category);
                    const start = sessionConfig.batchIndex * 50;
                    q = catWords.slice(start, start + 50);
                }
                setQueue(q);
            }, [sessionConfig]);

            useEffect(() => { 
                if (queue.length > 0 && !isFinished && !isFlipped) {
                    const word = queue[currentIdx]?.word;
                    if(word) setTimeout(() => AudioController.play(word), 300);
                }
            }, [currentIdx, isFlipped]);

            const currentCard = queue[currentIdx];

            // ğŸ”¥ èšåˆé‡Šä¹‰ Hook (å¿…é¡»åœ¨ return å‰)
            const groupedMeanings = useMemo(() => {
                if (!currentCard?.meanings) return [];
                const groups = [];
                currentCard.meanings.forEach((m, i) => {
                    if (groups.length > 0 && groups[groups.length-1].pos === m.pos) groups[groups.length-1].items.push({...m, _id: i});
                    else groups.push({ pos: m.pos, items: [{...m, _id: i}] });
                });
                return groups;
            }, [currentCard]);

            // ğŸ”¥ å…¨å±€ç¬”è®°ç”Ÿæˆ
            const generateWordNote = async (e) => {
                e.stopPropagation();
                if (!config.apiKey) return alert("è¯·å…ˆè®¾ç½® API Key");
                setIsGeneratingNote(true);
                try {
                    const prompt = `è€ƒç ”è‹±è¯­åˆ†æ: "${currentCard.word}"ã€‚Markdownåˆ—è¡¨æ ¼å¼ï¼ŒåŒ…å«ï¼š\n1. **ç†Ÿè¯åƒ»ä¹‰**\n2. **æ˜“æ··è¾¨æ**\n3. **çœŸé¢˜å‘ç‚¹**\næ€»å­—æ•°100å­—ä»¥å†…ï¼Œå¹²è´§ã€‚`;
                    let resText = "";
                    
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    
                    const res = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: [{role:"user",content:prompt}]})
                    });
                    const data = await res.json();
                    resText = data.choices?.[0]?.message?.content || "";

                    if(resText) {
                        const newWords = [...words];
                        const idx = newWords.findIndex(w => w.id === currentCard.id);
                        if (idx !== -1) newWords[idx].aiNote = resText;
                        setWords(newWords);
                        localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                        
                        // æ›´æ–°å½“å‰é˜Ÿåˆ—
                        const newQueue = [...queue];
                        newQueue[currentIdx].aiNote = resText;
                        setQueue(newQueue);
                    }
                } catch(e){ alert("ç”Ÿæˆå¤±è´¥"); } finally { setIsGeneratingNote(false); }
            };

            const handleRating = (rating) => {
                if (!currentCard) return;
                let { interval=0, easeFactor=2.5, reviewCount=0 } = currentCard.stats || {};
                
                if (rating === 1) { // ä¸è®¤è¯†
                    interval = 0; 
                    easeFactor = Math.max(1.3, easeFactor - 0.2);
                } else { // è®¤è¯†
                    if (interval === 0) interval = 1;
                    else if (interval === 1) interval = 3;
                    else interval = Math.round(interval * easeFactor);
                    easeFactor += 0.1;
                }
                
                const nextReview = Date.now() + (interval * 24 * 60 * 60 * 1000);
                const newStats = { interval, easeFactor, nextReview, reviewCount: reviewCount + 1 };
                
                // è®°å½•æ´»åŠ¨æ—¥å¿— (ç”¨äºçƒ­åŠ›å›¾)
                logActivity(1);

                const newWords = [...words];
                const idx = newWords.findIndex(w => w.id === currentCard.id);
                if (idx !== -1) newWords[idx].stats = newStats;
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));

                setIsFlipped(false);
                if (currentIdx < queue.length - 1) setCurrentIdx(c => c + 1);
                else setIsFinished(true);
            };

            const toggleForceShow = (origIdx) => {
                const newQueue = [...queue];
                const m = newQueue[currentIdx].meanings[origIdx];
                m._forceShow = !m._forceShow;
                setQueue(newQueue);
            };
            
            const toggleMastery = (origIdx) => {
                const newQueue = [...queue];
                const card = newQueue[currentIdx];
                card.meanings[origIdx].isMastered = !card.meanings[origIdx].isMastered;
                card.meanings[origIdx]._forceShow = false;
                setQueue(newQueue);
                
                // Sync to global
                const newWords = [...words];
                const idx = newWords.findIndex(w => w.id === currentCard.id);
                if (idx !== -1) newWords[idx].meanings = card.meanings;
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
            };

            if (queue.length === 0 && !isFinished) return <div className="h-full flex flex-col items-center justify-center p-6 bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg text-center"><h2 className="text-xl font-bold text-gray-800 mb-2">æš‚æ— ä»»åŠ¡</h2><p className="text-gray-500 mb-6">è¯¥åˆ†ç»„æ²¡æœ‰å•è¯ï¼Œæˆ–ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆã€‚</p><button onClick={onExit} className="px-6 py-3 bg-indigo-600 text-white rounded-xl">è¿”å›</button></div></div>;
            if (isFinished) return <div className="h-full flex flex-col items-center justify-center p-6 bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg text-center"><div className="text-5xl mb-4">ğŸ‰</div><h2 className="text-2xl font-bold text-gray-800 mb-4">æœ¬ç»„æ‰“å¡å®Œæˆ!</h2><button onClick={onExit} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">è¿”å›é¦–é¡µ</button></div></div>;

            return (
                <div className="h-full flex flex-col bg-gray-100 relative overflow-hidden">
                    {/* é¡¶éƒ¨è¿›åº¦æ¡ */}
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gray-200 z-10">
                        <div className="h-full bg-indigo-600 transition-all duration-300" style={{width: `${(currentIdx / queue.length) * 100}%`}}></div>
                    </div>

                    <div className="absolute top-4 left-4 z-20"><button onClick={onExit} className="p-2.5 bg-white/80 backdrop-blur rounded-full shadow hover:bg-white transition"><Icon name="ArrowLeft"/></button></div>
                    <div className="absolute top-4 right-4 z-20 flex gap-2">
                        <button onClick={()=>setChatSession(currentCard.word)} className="p-2.5 bg-white/80 backdrop-blur rounded-full shadow text-indigo-600 hover:bg-white transition"><Icon name="MessageCircle"/></button>
                    </div>

                    <div className="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden">
                        <div className="relative scene w-full max-w-sm md:max-w-2xl aspect-[3/4] md:aspect-[4/3] max-h-[85vh]">
                            <div className={`card-object ${isFlipped ? 'is-flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                                {/* æ­£é¢ */}
                                <div className="card-face flex flex-col items-center justify-center p-8 bg-white border-4 border-white">
                                    <h1 className="text-5xl md:text-6xl font-black text-gray-800 mb-8 tracking-tight">{currentCard.word}</h1>
                                    <div onClick={(e)=>{e.stopPropagation(); AudioController.play(currentCard.word)}} className="flex items-center gap-2 px-5 py-2.5 bg-gray-50 rounded-full text-gray-600 cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 transition border border-gray-200">
                                        <Icon name="Volume2" size={20}/> <span className="font-mono text-lg">{currentCard.phonetic}</span>
                                    </div>
                                    <div className="mt-auto text-gray-300 text-sm animate-pulse">ç‚¹å‡»ç¿»é¢</div>
                                </div>

                                {/* èƒŒé¢ */}
                                <div className="card-face card-face-back bg-white p-0 flex flex-col">
                                    <div className="p-5 border-b flex justify-between items-center bg-gray-50/50">
                                        <h2 className="text-3xl font-bold text-indigo-900">{currentCard.word}</h2>
                                        <button onClick={(e)=>{e.stopPropagation(); AudioController.play(currentCard.word)}} className="p-2 bg-white rounded-full shadow-sm text-indigo-600"><Icon name="Volume2"/></button>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto p-5 space-y-4 custom-scroll">
                                        {groupedMeanings.map((g, i) => (
                                            <div key={i} className="bg-white border border-gray-100 rounded-xl shadow-sm relative mt-3">
                                                <div className="absolute -top-3 -left-1 bg-indigo-100 text-indigo-700 px-2 py-0.5 text-xs font-bold rounded uppercase tracking-wide border border-indigo-200">{g.pos}</div>
                                                <div className="p-4 pt-5 space-y-4">
                                                    {g.items.map(m => {
                                                        const isHidden = m.isMastered && !m._forceShow;
                                                        return (
                                                            <div key={m._id} className="flex justify-between items-start gap-3 border-b border-dashed border-gray-100 last:border-0 pb-2 last:pb-0">
                                                                <div className="flex-1">
                                                                    {isHidden ? 
                                                                        <div onClick={(e)=>{e.stopPropagation(); toggleForceShow(m._id)}} className="text-gray-300 text-sm bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100 flex items-center"><Icon name="EyeOff" size={14} className="mr-1"/> å·²éšè—</div> 
                                                                        : <div className="text-gray-800 text-lg font-medium">{m.def}</div>
                                                                    }
                                                                </div>
                                                                <button onClick={(e)=>{e.stopPropagation(); toggleMastery(m._id)}} className={`p-2 rounded transition ${m.isMastered ? 'text-gray-300' : 'text-indigo-400 hover:text-indigo-600'}`}>
                                                                    {m.isMastered ? <Icon name="EyeOff"/> : <Icon name="Eye"/>}
                                                                </button>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}

                                        {/* åº•éƒ¨å…¨å±€æŒ‰é’®åŒº */}
                                        <div className="grid grid-cols-2 gap-3 pt-2">
                                            <button onClick={(e)=>{e.stopPropagation(); setShowSyntax(true);}} className="p-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-blue-100 transition">
                                                <Icon name="Dna" size={18}/> ğŸ§¬ é•¿éš¾å¥åˆ‡ç‰‡
                                            </button>
                                            {currentCard.aiNote ? (
                                                <div className="col-span-2 bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm text-gray-700 markdown-body" onClick={e=>e.stopPropagation()}>
                                                    <div className="font-bold text-orange-800 mb-2 flex items-center"><span className="mr-2">ğŸ”¥</span>è€ƒç ”é¿å‘æŒ‡å—</div>
                                                    <div dangerouslySetInnerHTML={{__html: marked.parse(currentCard.aiNote)}}/>
                                                </div>
                                            ) : (
                                                <button onClick={generateWordNote} disabled={isGeneratingNote} className="p-3 bg-orange-50 text-orange-600 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-orange-100 transition border border-orange-100">
                                                    {isGeneratingNote ? "æŒ–æ˜ä¸­..." : <><span className="text-lg">ğŸ”¥</span> è€ƒç ”å…¨ç»´é¿å‘</>}
                                                </button>
                                            )}
                                        </div>
                                        <div className="h-16"></div>
                                    </div>

                                    <div className="p-4 bg-white border-t grid grid-cols-2 gap-4 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] z-10">
                                        <button onClick={(e)=>{e.stopPropagation(); handleRating(1)}} className="py-3.5 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 transition border border-red-100 text-lg">ä¸è®¤è¯†</button>
                                        <button onClick={(e)=>{e.stopPropagation(); handleRating(3)}} className="py-3.5 bg-green-50 text-green-600 font-bold rounded-xl hover:bg-green-100 transition border border-green-100 text-lg">è®¤è¯†</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {showSyntax && <SyntaxModal word={currentCard.word} onClose={()=>setShowSyntax(false)} config={config} />}
                </div>
            );
        };

        const WordListMode = ({ words, setWords, setChatSession }) => {
            const [search, setSearch] = useState("");
            const displayWords = words.filter(w => w.word.toLowerCase().includes(search.toLowerCase()));
            
            return (
                <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div className="max-w-4xl mx-auto">
                        <div className="sticky top-0 bg-gray-50 pt-2 pb-4 z-10">
                            <div className="relative">
                                <input className="w-full p-3 pl-10 rounded-xl border shadow-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)}/>
                                <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="Search"/></div>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {displayWords.map(w => (
                                <div key={w.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-lg">{w.word}</div>
                                        <div className="text-xs text-gray-400 font-mono">{w.phonetic}</div>
                                    </div>
                                    <button onClick={()=>setChatSession(w.word)} className="p-2 text-indigo-500 bg-indigo-50 rounded-full"><Icon name="MessageCircle"/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ImportExport = ({ setWords, words, setView, config }) => {
            const [text, setText] = useState("");
            const [importBatch, setImportBatch] = useState("");
            const [isBatch, setIsBatch] = useState(false);
            const [mode, setMode] = useState('high'); // high, medium, low, zero

            const handleImport = () => {
                if (!text) return;
                const lines = text.split('\n').filter(l => l.trim());
                const newWords = [...words];
                const batchId = isBatch ? `batch-${Date.now()}` : 'default';
                
                // ä¿å­˜åˆ†ç»„å…ƒæ•°æ®
                if (isBatch && importBatch) {
                    const meta = JSON.parse(localStorage.getItem('kaoyan_group_meta') || '{}');
                    meta[batchId] = { name: importBatch, desc: 'Imported' };
                    localStorage.setItem('kaoyan_group_meta', JSON.stringify(meta));
                }

                lines.forEach((line, idx) => {
                    // ç®€å•è§£æ: word n. def...
                    const match = line.match(/^([a-zA-Z\-]+)\s+(.*)/);
                    if (match) {
                        const word = match[1].trim();
                        const rest = match[2].trim();
                        // è‡ªåŠ¨æ‹†åˆ†å¤šé‡Šä¹‰ (é€—å·/åˆ†å·)
                        const rawMeanings = [];
                        
                        // å°è¯•æå–è¯æ€§
                        const parts = rest.split(/([a-z]+\.)/g).filter(s => s.trim());
                        for(let i=0; i<parts.length; i++) {
                            if (parts[i].match(/^[a-z]+\.$/) && parts[i+1]) {
                                // è¿™æ˜¯ä¸€ä¸ªè¯æ€§å’Œé‡Šä¹‰
                                const pos = parts[i];
                                const defRaw = parts[i+1];
                                // ğŸ’¥ å¼ºåŠ›æ‹†åˆ†é€»è¾‘: æŒ‰é€—å·ã€åˆ†å·æ‹†
                                const defs = defRaw.split(/[;ï¼›ï¼Œ,]/).map(s => s.trim()).filter(s => s);
                                defs.forEach(d => rawMeanings.push({ pos, def: d, isMastered: false }));
                                i++;
                            } else if (i===0 && !parts[i].match(/^[a-z]+\.$/)) {
                                // æ²¡æœ‰è¯æ€§ï¼Œé»˜è®¤ mix
                                const defs = parts[i].split(/[;ï¼›ï¼Œ,]/).map(s => s.trim()).filter(s => s);
                                defs.forEach(d => rawMeanings.push({ pos: 'mix.', def: d, isMastered: false }));
                            }
                        }

                        if (rawMeanings.length > 0) {
                            newWords.push({
                                id: `imp-${Date.now()}-${idx}`,
                                word,
                                phonetic: "",
                                meanings: rawMeanings,
                                category: mode, // high/medium/low
                                importId: batchId,
                                stats: { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 }
                            });
                        }
                    }
                });
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                alert(`å¯¼å…¥å®Œæˆ! åŒ…å«å¼ºåŠ›æ‹†åˆ†ã€‚`);
                setText("");
            };

            // æ·±åº¦æ‹†åˆ†ç°æœ‰æ•°æ®çš„æŒ‰é’®é€»è¾‘
            const deepSplit = () => {
                const updated = words.map(w => {
                    let newMeanings = [];
                    w.meanings.forEach(m => {
                        const parts = m.def.split(/[;ï¼›ï¼Œ,]/).map(s=>s.trim().replace(/^\d+\./,'')).filter(s=>s);
                        parts.forEach(p => newMeanings.push({...m, def: p}));
                    });
                    return {...w, meanings: newMeanings};
                });
                setWords(updated);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(updated));
                alert("å…¨åº“æ·±åº¦æ‹†åˆ†å®Œæˆï¼");
            };

            return (
                <div className="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <div className="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-sm space-y-6">
                        <h2 className="text-xl font-bold">æ•°æ®å¯¼å…¥ & ç»´æŠ¤</h2>
                        
                        <div className="space-y-4">
                            <textarea className="w-full h-40 p-4 border rounded-xl" placeholder="word n. é‡Šä¹‰1; é‡Šä¹‰2..." value={text} onChange={e=>setText(e.target.value)}/>
                            
                            <div className="flex gap-4 items-center">
                                <select value={mode} onChange={e=>setMode(e.target.value)} className="p-2 border rounded-lg">
                                    <option value="high">é«˜é¢‘</option>
                                    <option value="medium">ä¸­é¢‘</option>
                                    <option value="low">ä½é¢‘</option>
                                </select>
                                <label className="flex items-center gap-2 text-sm">
                                    <input type="checkbox" checked={isBatch} onChange={e=>setIsBatch(e.target.checked)}/> æ–°å»ºåˆ†ç»„
                                </label>
                                {isBatch && <input className="border p-2 rounded-lg flex-1" placeholder="åˆ†ç»„å (å¦‚: 2010çœŸé¢˜)" value={importBatch} onChange={e=>setImportBatch(e.target.value)}/>}
                            </div>

                            <button onClick={handleImport} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">å¯¼å…¥ (è‡ªåŠ¨æ‹†åˆ†)</button>
                        </div>

                        <div className="border-t pt-6">
                            <h3 className="font-bold mb-2 text-purple-900">ç»´æŠ¤å·¥å…·</h3>
                            <button onClick={deepSplit} className="w-full py-3 bg-purple-50 text-purple-600 border border-purple-200 rounded-xl font-bold mb-2">
                                ğŸ”ª å¯¹ç°æœ‰å•è¯è¿›è¡Œã€å¼ºåŠ›æ‹†åˆ†ã€‘
                            </button>
                            <p className="text-xs text-gray-400">æ³¨ï¼šå°† "æ‰¿è®¤ï¼Œè‡´è°¢" è¿™ç§é‡Šä¹‰è‡ªåŠ¨ç‚¸å¼€æˆä¸¤è¡Œï¼Œä»¥ä¾¿å•ç‹¬éšè—ã€‚</p>
                        </div>
                        
                        <div className="border-t pt-6">
                             <button onClick={()=>{if(confirm('æ¸…ç©ºæ‰€æœ‰?')) {localStorage.clear(); window.location.reload()}}} className="text-red-500 text-sm underline">æ¸…ç©ºæ•°æ® (é‡ç½®)</button>
                        </div>
                    </div>
                </div>
            );
        };

        // SettingsPanel ä¿æŒä¹‹å‰çš„ç®€åŒ–ç‰ˆå³å¯ï¼Œæ ¸å¿ƒåŠŸèƒ½éƒ½åœ¨
        const SettingsPanel = ({ config, setConfig, setView }) => {
            const update = (k, v) => setConfig(p => ({...p, [k]: v}));
            return (
                <div className="p-6 max-w-lg mx-auto bg-white rounded-2xl mt-10 shadow-sm space-y-4">
                    <h2 className="font-bold text-xl">è®¾ç½®</h2>
                    <div><label className="block text-xs text-gray-400 mb-1">API Key</label><input className="w-full border p-3 rounded-xl" value={config.apiKey} onChange={e=>update('apiKey', e.target.value)} type="password"/></div>
                    <div><label className="block text-xs text-gray-400 mb-1">Base URL</label><input className="w-full border p-3 rounded-xl" value={config.baseUrl} onChange={e=>update('baseUrl', e.target.value)}/></div>
                    <div><label className="block text-xs text-gray-400 mb-1">Model</label><input className="w-full border p-3 rounded-xl" value={config.model} onChange={e=>update('model', e.target.value)}/></div>
                    <button onClick={()=>{localStorage.setItem('kaoyan_config', JSON.stringify(config)); setView('home')}} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">ä¿å­˜</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
