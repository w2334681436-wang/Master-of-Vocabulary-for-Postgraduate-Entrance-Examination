<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ËÄÉÁ†îËØçÊ±áÂ§ßÂ∏à - ËøõÈò∂Áâà</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.staticfile.net/lz-string/1.4.4/lz-string.min.js"></script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        .scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        @media (min-width: 768px) { .card-face { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } }
        .card-face-back { transform: rotateY(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body strong { color: inherit; font-weight: 700; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body code { background-color: rgba(0,0,0,0.05); padding: 0.1em 0.3em; border-radius: 3px; font-family: monospace; }
        
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">ËµÑÊ∫êÂä†ËΩΩ‰∏≠...</p>
        </div>
        <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var root = document.getElementById('root');
            root.innerHTML = '<div style="padding:20px;text-align:center;color:red;"><h3>ÂèëÁîüÈîôËØØ</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            CloudCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 15l2 2 4-4"/><path d="M19 17a5 5 0 0 0 0-10c-5.523 0-10 4.477-10 10"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Maximize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
            Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            MessageCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Palette: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const Svg = Icons[name] || Icons.Book;
            return <span className={`flex justify-center items-center ${className}`} style={{ width: size, height: size }}><Svg /></span>;
        };

        const API_PRESETS = {
            "deepseek": { name: "DeepSeek (Ê∑±Â∫¶Ê±ÇÁ¥¢)", type: "openai", url: "https://api.deepseek.com" },
            "siliconflow": { name: "SiliconFlow (Á°ÖÂü∫ÊµÅÂä®)", type: "openai", url: "https://api.siliconflow.cn/v1" },
            "openai": { name: "OpenAI (ÂÆòÊñπ)", type: "openai", url: "https://api.openai.com/v1" },
            "moonshot": { name: "Moonshot (Kimi)", type: "openai", url: "https://api.moonshot.cn/v1" },
            "zhipu": { name: "Êô∫Ë∞±AI (GLM)", type: "openai", url: "https://open.bigmodel.cn/api/paas/v4" },
            "aliyun": { name: "ÈòøÈáå‰∫ë (ÈÄö‰πâÂçÉÈóÆ)", type: "openai", url: "https://dashscope.aliyuncs.com/compatible-mode/v1" },
            "yi": { name: "Èõ∂‰∏Ä‰∏áÁâ© (Yi)", type: "openai", url: "https://api.lingyiwanwu.com/v1" },
            "google": { name: "Google (Gemini)", type: "google", url: "" },
            "custom": { name: "Ëá™ÂÆö‰πâ (OpenAIÂÖºÂÆπ)", type: "openai", url: "" }
        };

       const playAudio = (text) => {
            if (text.includes(' ') || text.length > 20) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    u.rate = 0.9;
                    window.speechSynthesis.speak(u);
                }
            } else {
                const audio = new Audio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`);
                audio.play().catch(e => {
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                });
            }
        };

        const calculateNextReview = (rating, currentInterval, easeFactor, currentReviewCount) => {
            let nextInterval, nextEaseFactor = easeFactor;
            const newReviewCount = (currentReviewCount || 0) + 1;
            if (rating === 1) { 
                return { interval: 0, easeFactor: Math.max(1.3, easeFactor - 0.2), isDueNow: true, reviewCount: newReviewCount };
            } else if (rating === 2) { 
                return { interval: 0.5, easeFactor: Math.max(1.3, easeFactor - 0.15), isDueNow: true, reviewCount: newReviewCount }; 
            } else { 
                if (currentInterval === 0) nextInterval = 1; 
                else if (currentInterval === 1) nextInterval = 3;
                else nextInterval = Math.round(currentInterval * easeFactor);
                return { interval: nextInterval, easeFactor: easeFactor + 0.1, isDueNow: false, reviewCount: newReviewCount };
            }
        };

        const WordChat = ({ word, onClose, config }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [thinkMode, setThinkMode] = useState("fast");
            const [bubbleColor, setBubbleColor] = useState("bg-indigo-600");
            const [showColorPicker, setShowColorPicker] = useState(false);
            const messagesEndRef = useRef(null);

            const colors = [
                { name: "Indigo", class: "bg-indigo-600" },
                { name: "Pink", class: "bg-pink-500" },
                { name: "Green", class: "bg-emerald-500" },
                { name: "Blue", class: "bg-blue-500" },
                { name: "Orange", class: "bg-orange-500" },
                { name: "Black", class: "bg-gray-800" }
            ];

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
            useEffect(() => { scrollToBottom(); }, [messages]);

            useEffect(() => {
                // üî• ‰øÆÊîπÔºöAI ÁßÅÊïôÈªòËÆ§ÂÖàËÆ≤ËØçÊ†πËØçÁºÄ
                const initialMsg = {
                    role: "assistant",
                    content: `Hi! ÊàëÊòØ‰Ω†ÁöÑ‰∏ìÂ±û AI ÁßÅÊïô„ÄÇ\nÊàë‰ª¨‰ªäÂ§©Ë¶ÅÊ≠ªÁ£ïÁöÑÂçïËØçÊòØÔºö **${word}**„ÄÇ\n\nüí° **ÈªòËÆ§Ê®°Âºè**ÔºöÂÖàÊãÜËØçÊ†πÔºåÂÜçËÆ≤ËÄÉÁÇπÔºåÊúÄÂêéÁªôËÆ∞ÂøÜÂè£ËØÄ„ÄÇ\n\n‰Ω†ÂèØ‰ª•ÂàáÊç¢‰∏äÊñπÊ®°ÂºèÔºö\n‚ö° **Âø´ÈÄü**ÔºöÁÆÄÂçïÈÄö‰øóËÆ≤Ëß£\nüìñ **Ê∑±Â∫¶**ÔºöËÄÉÁ†îÁúüÈ¢òËÄÉÊ≥ï\nüëÑ **Âè£ËØ≠**ÔºöÁ∫ØËã±ÂØπËØùÁªÉÂê¨Âäõ`
                };
                setMessages([initialMsg]);
                // üî• ‰øÆÊîπÔºöËá™Âä®ÂèëÈÄÅÁöÑ Prompt ÊòéÁ°ÆË¶ÅÊ±ÇËØçÊ†πËØçÁºÄÂíåËÄÉÁ†îÈÅøÂùë
                handleSend(null, `ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãÊ≠•È™§ËÆ≤Ëß£ÂçïËØç "${word}"Ôºö\n1. **ËØçÊ†πËØçÁºÄÊãÜËß£**ÔºàËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑÔºâÔºöËØ¶ÁªÜÊãÜÂàÜÂπ∂Ëß£ÈáäÊØè‰∏ÄÈÉ®ÂàÜ„ÄÇ\n2. **Ê†∏ÂøÉÂê´‰πâ‰∏éËÄÉÊ≥ï**ÔºöÁªìÂêàËÄÉÁ†îÁúüÈ¢òËØ≠Â¢ÉËß£ÈáäÔºåÂàóÂá∫ÁÜüËØçÂÉª‰πâ„ÄÇ\n3. **ËÆ∞ÂøÜÂè£ËØÄ**ÔºöÁªôÂá∫‰∏Ä‰∏™Â•ΩËÆ∞ÁöÑÈ°∫Âè£Ê∫ú„ÄÇ\n‰ΩøÁî® Markdown Ê†ºÂºèÔºåÈáçÁÇπÂä†Á≤ó„ÄÇ`);
            }, []);

            const handleSend = async (e, manualContent) => {
                if (e) e.preventDefault();
                const content = manualContent || input.trim();
                if (!content || isLoading) return;

                if (!manualContent) {
                    setMessages(prev => [...prev, { role: "user", content }]);
                    setInput("");
                }
                setIsLoading(true);

                let systemPrompt = "";
                if (thinkMode === 'oral') systemPrompt = "You are a friendly American English tutor. Speak ONLY in English. Keep your sentences simple, clear, and encouraging. Correct the user's grammar gently if needed. Engage in a conversation using the target word.";
                else if (thinkMode === 'deep') systemPrompt = "‰Ω†ÊòØ‰∏Ä‰Ωç‰∏•ËÇÉÁöÑËÄÉÁ†îËã±ËØ≠ÂëΩÈ¢òÁªÑ‰∏ìÂÆ∂„ÄÇËØ∑‰ªéËØçÊ∫êËØçÊ†π„ÄÅÁÜüËØçÂÉª‰πâ„ÄÅÂéÜÂπ¥ÁúüÈ¢òËÄÉÊ≥ï„ÄÅÊòìÊ∑∑ËØçËæ®ÊûêËøôÂõõ‰∏™Áª¥Â∫¶ËøõË°åÊ∑±Â∫¶Ëß£Êûê„ÄÇÂøÖÈ°ª‰ΩøÁî® Markdown Ê†ºÂºèÔºåÂÖ≥ÈîÆÁÇπÂä†Á≤ó„ÄÇ";
                else systemPrompt = "‰Ω†ÊòØ‰∏Ä‰ΩçÈùûÂ∏∏ÊìÖÈïøÁ±ªÊØîÁöÑËã±ËØ≠ÁßÅÊïô„ÄÇËØ∑Áî®ÊúÄÈÄö‰øó„ÄÅÁîüÊ¥ªÂåñ„ÄÅÁîöËá≥ÊúâÁÇπÂπΩÈªòÁöÑËØ≠Ë®ÄËß£ÈáäÂçïËØç„ÄÇÊ†∏ÂøÉÁ≠ñÁï•Ôºö1.ÊääÊäΩË±°Ê¶ÇÂøµÂÖ∑Ë±°Âåñ„ÄÇ2.Â§öÁî®ÁîüÊ¥ªÂú∫ÊôØ‰∏≤ËÅî‰∏çÂêåËØçÊÄß„ÄÇ3.ÊúÄÂêéÁªô‰∏ÄÂè•‚ÄúÁÆÄÂçïËÆ∞‚ÄùÂè£ËØÄ„ÄÇ‰ΩøÁî® Markdown Ê†ºÂºè„ÄÇ";

                try {
                    const apiMessages = [{ role: "system", content: systemPrompt }, ...messages.filter(m => m.role !== 'error' && m.content !== '...'), { role: "user", content }];
                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);
                    
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel") && !baseUrl.includes("lingyiwanwu")) baseUrl += "/v1";

                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` },
                        body: JSON.stringify({ model: config.model, messages: apiMessages, stream: true })
                    });
                    if (!response.ok) throw new Error("API ËØ∑Ê±ÇÂ§±Ë¥•");
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    setMessages(prev => { const newMsgs = [...prev]; newMsgs[newMsgs.length - 1] = { role: "assistant", content: fullText }; return newMsgs; });
                                } catch (e) { }
                            }
                        }
                    }
                } catch (error) { setMessages(prev => [...prev, { role: "error", content: "Âá∫Èîô‰∫Ü: " + error.message }]); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-white md:max-w-md md:mx-auto md:my-4 md:rounded-2xl md:shadow-2xl md:border md:border-gray-200 overflow-hidden animate-slide-up">
                    <div className="flex justify-between items-center p-4 border-b bg-white z-10 shadow-sm">
                        <div className="flex flex-col">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center">{word} <span className="ml-2 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded">AI ÁßÅÊïô</span></h3>
                            <div className="flex gap-2 mt-2">
                                <button onClick={() => setThinkMode('fast')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='fast' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>‚ö° Âø´ÈÄüÁêÜËß£</button>
                                <button onClick={() => setThinkMode('deep')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='deep' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>üìñ Ê∑±Â∫¶ËÄÉÁ†î</button>
                                <button onClick={() => setThinkMode('oral')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='oral' ? 'bg-orange-50 text-orange-600 border-orange-200 font-bold' : 'text-gray-500 border-transparent'}`}>üëÑ Âè£ËØ≠ÂØπÁªÉ</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={()=>setShowColorPicker(!showColorPicker)} className="p-2 rounded-full hover:bg-gray-100 text-gray-400 relative"><Icon name="Palette" size={20}/></button>
                            {showColorPicker && (
                                <div className="absolute right-14 top-16 bg-white shadow-xl border rounded-lg p-2 grid grid-cols-3 gap-2 w-32 z-50">
                                    {colors.map(c => (<div key={c.name} onClick={()=>setBubbleColor(c.class)} className={`w-6 h-6 rounded-full cursor-pointer border border-gray-100 ${c.class}`}></div>))}
                                </div>
                            )}
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 text-gray-400"><Icon name="X" size={24}/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-5 bg-gray-50 custom-scroll" onClick={()=>setShowColorPicker(false)}>
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`flex flex-col max-w-[90%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div className={`p-3.5 rounded-2xl text-sm md:text-base leading-relaxed shadow-sm relative group ${msg.role === 'user' ? 'bg-white text-gray-800 border border-gray-100 rounded-tr-none' : `${bubbleColor} text-white rounded-tl-none markdown-body`} ${msg.role === 'error' ? 'bg-red-50 text-red-600 border-red-200' : ''}`}>
                                        {msg.role === 'assistant' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}
                                        {msg.role === 'assistant' && msg.content !== '...' && (
                                            <button onClick={(e) => {e.stopPropagation(); playAudio(msg.content.replace(/[\*\#]/g, ''));}} className="absolute -right-8 bottom-0 p-1.5 text-gray-400 hover:text-indigo-600 bg-white/50 rounded-full hover:bg-white transition shadow-sm"><Icon name="Volume2" size={16}/></button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="p-3 bg-white border-t flex items-end gap-2 safe-bottom">
                        <textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}} placeholder="ÁªßÁª≠ËøΩÈóÆ..." className="flex-1 max-h-32 p-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-100 outline-none resize-none text-sm" rows="1"></textarea>
                        <button onClick={(e)=>handleSend(e)} disabled={isLoading || !input.trim()} className={`p-3 rounded-xl text-white shadow-md transition-all ${isLoading || !input.trim() ? 'bg-gray-300' : bubbleColor} active:scale-95`}>{isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icon name="Send" size={20} />}</button>
                    </div>
                </div>
            );
        };

        // --- Components ---

       const Navbar = ({ view, setView }) => {
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            };

            return (
                <nav className="bg-indigo-600 text-white shadow-md sticky top-0 z-50 safe-top transition-all duration-300 flex-shrink-0">
                    <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div className="flex items-center space-x-2" onClick={() => setView('home')}>
                            <div className="font-bold text-lg cursor-pointer flex items-center space-x-2">
                                <Icon name="Book" size={24}/>
                                <span className="tracking-wide hidden sm:inline">ËÄÉÁ†îËØçÊ±áÂ§ßÂ∏à</span>
                            </div>
                        </div>
                        <div className="flex space-x-1 items-center">
                            <button onClick={toggleFullscreen} className="p-2 rounded-lg hover:bg-indigo-500 transition" title="ÂÖ®Â±è/ÈÄÄÂá∫">
                                <Icon name="Maximize" />
                            </button>
                            <button onClick={() => setView('home')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'home' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Brain" /></button>
                            <button onClick={() => setView('list')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'list' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="List" /></button>
                            <button onClick={() => setView('import')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'import' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Upload" /></button>
                            <button onClick={() => setView('settings')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'settings' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Settings" /></button>
                        </div>
                    </div>
                </nav>
            );
        };

        const WordListMode = ({ words, setWords, setChatSession }) => {
            const [search, setSearch] = useState("");
            const [sortMode, setSortMode] = useState('default');
            const [sortDesc, setSortDesc] = useState(false);
            const [showSortMenu, setShowSortMenu] = useState(false);
            const displayWords = useMemo(() => {
                let list = words.filter(w => w.word.toLowerCase().includes(search.toLowerCase()) || w.meanings.some(m => m.def.includes(search)));
                list.sort((a, b) => {
                    if (sortMode === 'alpha') return a.word.localeCompare(b.word);
                    else if (sortMode === 'reviews') return (a.stats?.reviewCount || 0) - (b.stats?.reviewCount || 0);
                    return 0;
                });
                if (sortDesc) list.reverse();
                return list;
            }, [words, search, sortMode, sortDesc]);
            const toggleSort = (mode) => { if (sortMode === mode) setSortDesc(!sortDesc); else { setSortMode(mode); setSortDesc(mode === 'reviews'); } setShowSortMenu(false); };
            const toggleMastery = (wordId, meaningIndex) => { const newWords = [...words]; const idx = newWords.findIndex(w => w.id === wordId); if (idx !== -1) { newWords[idx].meanings[meaningIndex].isMastered = !newWords[idx].meanings[meaningIndex].isMastered; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            
            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50">
                    <div className="max-w-6xl mx-auto pb-20">
                        <div className="sticky top-0 bg-gray-50 pt-2 pb-4 z-40 space-y-2 md:flex md:space-y-0 md:space-x-4 md:items-center">
                            <div className="relative flex-1">
                                <input type="text" placeholder="ÊêúÁ¥¢ÂçïËØçÊàñÈáä‰πâ..." className="w-full pl-10 pr-4 py-3 rounded-xl shadow-sm border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition" value={search} onChange={e => setSearch(e.target.value)} />
                                <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="Search" /></div>
                            </div>
                            <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm border border-gray-200 text-sm relative md:w-auto">
                                <span className="text-gray-500 ml-2 whitespace-nowrap font-medium">ÂÖ± {displayWords.length} ËØç</span>
                                <button onClick={() => setShowSortMenu(!showSortMenu)} className="ml-4 flex items-center space-x-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-medium whitespace-nowrap transition"><Icon name="Sort" size={16} /><span>ÊéíÂ∫è</span></button>
                                {showSortMenu && (<div className="absolute right-0 top-full mt-2 w-40 bg-white rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden ring-1 ring-black/5"><button onClick={() => toggleSort('default')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">ÈªòËÆ§</button><button onClick={() => toggleSort('alpha')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">Â≠óÊØç A-Z</button><button onClick={() => toggleSort('reviews')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">Â§ç‰π†Ê¨°Êï∞</button></div>)}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {displayWords.map((word) => (
                                <div key={word.id} className="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition duration-200 border border-gray-100 hover:border-indigo-100 flex flex-col h-full relative group">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-baseline space-x-2 overflow-hidden">
                                            <h3 className="text-lg font-bold text-gray-900 truncate">{word.word}</h3>
                                            <span className="text-sm font-mono text-gray-500 truncate">{word.phonetic}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={(e)=>{e.stopPropagation(); setChatSession(word.word);}} className="p-1.5 bg-indigo-50 text-indigo-500 hover:text-white hover:bg-indigo-500 rounded-full transition shadow-sm" title="AI ËØ¶Ëß£"><Icon name="MessageCircle" size={18}/></button>
                                            <div className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap font-medium">Â§ç‰π† {word.stats?.reviewCount || 0}</div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {word.meanings.map((m, mIdx) => (
                                            <div key={mIdx} className="flex items-start group cursor-pointer p-1 -ml-1 rounded hover:bg-gray-50 transition" onClick={() => toggleMastery(word.id, mIdx)}>
                                                <div className={`mt-0.5 mr-2 flex-shrink-0 transition-colors ${m.isMastered ? 'text-green-500' : 'text-gray-300 group-hover:text-gray-400'}`}><Icon name="Check" size={16} /></div>
                                                <div className={`text-sm leading-snug break-words ${m.isMastered ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                                    <span className="font-semibold mr-1 text-gray-500 text-xs uppercase">{m.pos}</span>{m.def}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ words, setView, setSessionConfig }) => {
            const stats = useMemo(() => {
                const counts = { high: 0, medium: 0, low: 0, zero: 0, uncategorized: 0, review: 0 };
                const now = Date.now();
                words.forEach(w => {
                    const cat = w.category || 'uncategorized';
                    if (['high', 'medium', 'low', 'zero'].includes(cat)) counts[cat]++; else if (!counts[cat]) counts[cat] = 1; else counts[cat]++;
                    if (w.stats && w.stats.nextReview <= now && w.stats.interval !== 0) counts.review++;
                });
                return counts;
            }, [words]);
            const standardCats = ['high', 'medium', 'low', 'zero'];
            const customCats = Object.keys(stats).filter(k => !standardCats.includes(k) && k !== 'review' && k !== 'uncategorized');
            const openCategory = (category) => { setSessionConfig({ type: 'group_select', category }); setView('group_list'); };
            const startReview = () => { setSessionConfig({ type: 'review' }); setView('study'); };
            
            const Card = ({ title, count, color, onClick, isCustom }) => (
                <div onClick={onClick} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer transform transition hover:scale-[1.02] hover:shadow-md active:scale-95 relative overflow-hidden group h-32 flex flex-col justify-between`}>
                    <div className={`absolute top-0 left-0 w-1.5 h-full ${color} transition-all group-hover:w-2`}></div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-gray-800 text-lg truncate pl-2">{title}</h3>
                        <div className={`text-gray-200 group-hover:text-indigo-100 transition-colors ${isCustom ? 'opacity-70' : ''}`}>{isCustom ? <Icon name="Folder" size={28}/> : <Icon name="Book" size={28}/>}</div>
                    </div>
                    <div className="pl-2">
                        <span className="text-2xl font-bold text-gray-700">{count}</span>
                        <span className="text-xs text-gray-400 ml-1">ËØç</span>
                    </div>
                </div>
            );

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 bg-gray-50">
                    <div className="max-w-5xl mx-auto space-y-8 pb-10">
                        <div onClick={startReview} className="w-full bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl text-white shadow-xl shadow-indigo-200 cursor-pointer transform transition hover:-translate-y-1 hover:shadow-2xl active:scale-[0.99] relative overflow-hidden flex flex-col md:flex-row justify-between items-center group">
                            <div className="z-10 relative text-center md:text-left">
                                <h2 className="text-3xl font-bold mb-2 tracking-tight">Êô∫ËÉΩÂ§ç‰π†ËÆ°Âàí</h2>
                                <p className="text-indigo-100 text-lg opacity-90">‰ªäÊó•ÂæÖÂ§ç‰π†: <span className="font-bold text-white bg-white/20 px-3 py-0.5 rounded-lg ml-1">{stats.review}</span> ‰∏™ÂçïËØç</p>
                            </div>
                            <div className="mt-4 md:mt-0 bg-white/20 w-20 h-20 rounded-full flex items-center justify-center z-10 relative group-hover:scale-110 transition duration-300 backdrop-blur-sm border border-white/30">
                                <Icon name="Brain" size={40} className="text-white"/>
                            </div>
                            <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                            <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-indigo-900/20 rounded-full blur-2xl"></div>
                            {stats.review > 0 && <div className="absolute top-6 right-6 w-3 h-3 bg-red-400 rounded-full animate-ping"></div>}
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="List" size={20} className="mr-2 text-indigo-600"/>Ê†∏ÂøÉËÄÉÈ¢ë</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                                <Card title="È´òÈ¢ëËØç" count={stats.high || 0} color="bg-red-500" onClick={() => openCategory('high')} />
                                <Card title="‰∏≠È¢ëËØç" count={stats.medium || 0} color="bg-orange-500" onClick={() => openCategory('medium')} />
                                <Card title="‰ΩéÈ¢ëËØç" count={stats.low || 0} color="bg-yellow-500" onClick={() => openCategory('low')} />
                                <Card title="Èõ∂È¢ëËØç" count={stats.zero || 0} color="bg-green-500" onClick={() => openCategory('zero')} />
                                {stats.uncategorized > 0 && <Card title="Êú™ÂàÜÁ±ª" count={stats.uncategorized} color="bg-gray-400" onClick={() => openCategory('uncategorized')} />}
                            </div>
                        </div>

                        {customCats.length > 0 && (
                            <div>
                                <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="Folder" size={20} className="mr-2 text-indigo-600"/>ÊàëÁöÑÂàÜÁªÑ</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 lg:gap-6">
                                    {customCats.map(cat => (<Card key={cat} title={cat} count={stats[cat]} color="bg-blue-500" onClick={() => openCategory(cat)} isCustom={true} />))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const GroupList = ({ words, setWords, category, setView, setSessionConfig, config }) => {
            const [moveModal, setMoveModal] = useState({ open: false, targetGroupWords: [] });
            const [editModal, setEditModal] = useState({ open: false, batchId: '', currentName: '', currentDesc: '' });
            const [customTarget, setCustomTarget] = useState('');
            const [groupMeta, setGroupMeta] = useState({});

            useEffect(() => {
                try {
                    const savedMeta = localStorage.getItem('kaoyan_group_meta');
                    if (savedMeta) setGroupMeta(JSON.parse(savedMeta));
                } catch (e) { console.error("Âä†ËΩΩÂàÜÁªÑ‰ø°ÊÅØÂ§±Ë¥•", e); }
            }, []);

            const groups = useMemo(() => {
                const catWords = words.filter(w => (w.category || 'uncategorized') === category);
                const groupSize = config.groupSize || 208;
                const batches = {};
                catWords.forEach(w => { const batchId = w.importId || 'default'; if (!batches[batchId]) batches[batchId] = []; batches[batchId].push(w); });
                const result = [];
                const batchKeys = Object.keys(batches).sort((a, b) => { if (a === 'default') return -1; if (b === 'default') return 1; return parseInt(b.split('-')[1] || 0) - parseInt(a.split('-')[1] || 0); });
                let globalIndex = 1;
                batchKeys.forEach(batchId => {
                    const batchWords = batches[batchId]; const count = Math.ceil(batchWords.length / groupSize);
                    for(let i=0; i<count; i++) {
                        const start = i * groupSize; const end = Math.min((i+1) * groupSize, batchWords.length);
                        const groupWords = batchWords.slice(start, end);
                        const mastered = groupWords.filter(w => w.stats && w.stats.interval > 0).length;
                        const meta = groupMeta[batchId] || {};
                        let batchName = meta.name;
                        if (!batchName) {
                            if (batchId !== 'default') { 
                                const ts = parseInt(batchId.split('-')[1]); 
                                if (!isNaN(ts)) { const date = new Date(ts); batchName = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ÂØºÂÖ•`; } else { batchName = "Êñ∞ÊâπÊ¨°"; } 
                            } else { batchName = "ÈªòËÆ§ËØçÂ∫ì"; }
                        }
                        result.push({ index: globalIndex++, batchId, batchIndex: i, batchName, desc: meta.desc || "", start: start + 1, end, total: groupWords.length, mastered, words: groupWords });
                    }
                });
                return result;
            }, [words, category, config.groupSize, groupMeta]);

            const displayTitle = ({ high: "È´òÈ¢ëËØç", medium: "‰∏≠È¢ëËØç", low: "‰ΩéÈ¢ëËØç", zero: "Èõ∂È¢ëËØç", uncategorized: "Êú™ÂàÜÁ±ª" })[category] || category;
            const startGroup = (batchId, batchIndex) => { setSessionConfig({ type: 'group_study', category, batchId, batchIndex }); setView('study'); };
            
            const handleDeleteGroup = (e, groupWords) => {
                e.stopPropagation();
                if(confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ÁªÑÁöÑ ${groupWords.length} ‰∏™ÂçïËØçÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                    const idsToDelete = groupWords.map(w => w.id);
                    const newWords = words.filter(w => !idsToDelete.includes(w.id));
                    setWords(newWords);
                    localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                }
            };

            const openMoveModal = (e, groupWords) => { e.stopPropagation(); setMoveModal({ open: true, targetGroupWords: groupWords }); setCustomTarget(''); };
            const performMove = (targetCat) => {
                if(!targetCat) return;
                const idsToMove = moveModal.targetGroupWords.map(w => w.id);
                const newWords = words.map(w => idsToMove.includes(w.id) ? { ...w, category: targetCat } : w);
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                setMoveModal({ open: false, targetGroupWords: [] });
                alert("ËΩ¨ÁßªÊàêÂäüÔºÅ");
            };

            const openEditModal = (e, batchId, currentName, currentDesc) => {
                e.stopPropagation();
                const isDefaultName = currentName.includes("ÂØºÂÖ•") || currentName === "ÈªòËÆ§ËØçÂ∫ì" || currentName === "Êñ∞ÊâπÊ¨°";
                setEditModal({ open: true, batchId, currentName: isDefaultName ? '' : currentName, currentDesc: currentDesc || '' });
            };

            const saveGroupInfo = () => {
                const newMeta = { ...groupMeta, [editModal.batchId]: { name: editModal.currentName.trim(), desc: editModal.currentDesc.trim() } };
                setGroupMeta(newMeta);
                localStorage.setItem('kaoyan_group_meta', JSON.stringify(newMeta));
                setEditModal({ open: false, batchId: '', currentName: '', currentDesc: '' });
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50 relative">
                    <div className="max-w-5xl mx-auto pb-20">
                        <div className="flex items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800 truncate border-l-4 border-indigo-600 pl-3">{displayTitle}</h2>
                            <span className="ml-3 text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded-md">ÂàÜÁªÑÁÆ°ÁêÜ</span>
                        </div>
                        {groups.length === 0 ? 
                            <div className="flex flex-col items-center justify-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100"><div className="text-gray-300 mb-4"><Icon name="Book" size={48}/></div><div className="text-gray-500">ËØ•ÂàÜÁ±ª‰∏ãÊöÇÊó†ÂçïËØç</div></div> 
                        : 
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {groups.map(g => (
                                <div key={g.index} onClick={() => startGroup(g.batchId, g.batchIndex)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:border-indigo-300 hover:shadow-md transition duration-200 flex flex-col group relative overflow-hidden min-h-[160px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex-1 pr-2">
                                            <h3 className="font-bold text-gray-800 text-lg line-clamp-1" title={g.batchName}>{g.batchName}</h3>
                                            <div className="flex items-center mt-1 space-x-2"><span className="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded border border-gray-200">Group {g.index}</span></div>
                                        </div>
                                        <div className="flex space-x-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                            <button onClick={(e) => openEditModal(e, g.batchId, g.batchName, g.desc)} className="p-1.5 bg-gray-50 text-gray-600 rounded hover:bg-indigo-50 hover:text-indigo-600 transition" title="ÁºñËæë‰ø°ÊÅØ"><Icon name="Edit" size={16}/></button>
                                            <button onClick={(e) => openMoveModal(e, g.words)} className="p-1.5 bg-blue-50 text-blue-500 rounded hover:bg-blue-100 transition" title="ËΩ¨ÁßªÂàÜÁªÑ"><Icon name="Move" size={16}/></button>
                                            <button onClick={(e) => handleDeleteGroup(e, g.words)} className="p-1.5 bg-red-50 text-red-500 rounded hover:bg-red-100 transition" title="Âà†Èô§ÂàÜÁªÑ"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                    <div className="mb-3 flex-1">{g.desc ? (<p className="text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100 line-clamp-2">{g.desc}</p>) : (<p className="text-xs text-gray-300 italic py-2">ÊöÇÊó†Â§áÊ≥®...</p>)}</div>
                                    <div className="mt-auto">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1"><span>ËøõÂ∫¶</span><span className="font-medium">{Math.round((g.mastered/g.total)*100)}%</span></div>
                                        <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${(g.mastered/g.total)*100}%`}}></div></div>
                                        <p className="text-xs text-gray-400 mt-2 text-right">{g.mastered} / {g.total} ËØç</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        }
                    </div>
                    {moveModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setMoveModal({open:false, targetGroupWords:[]})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">ËΩ¨ÁßªËØ•ÁªÑÂçïËØçÂà∞...</h3>
                                <div className="grid grid-cols-2 gap-3 mb-4">{['high', 'medium', 'low', 'zero'].map(cat => (<button key={cat} onClick={() => performMove(cat)} className="py-3 bg-gray-50 hover:bg-indigo-50 border border-gray-200 hover:border-indigo-200 rounded-xl font-bold text-gray-700 hover:text-indigo-700 transition uppercase">{cat}</button>))}</div>
                                <div className="border-t border-gray-100 pt-4 mt-2"><label className="text-xs font-bold text-gray-400 uppercase mb-2 block">Ëá™ÂÆö‰πâÂàÜÁªÑ</label><div className="flex space-x-2"><input type="text" value={customTarget} onChange={e => setCustomTarget(e.target.value)} placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç..." className="flex-1 p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/><button onClick={() => performMove(customTarget)} disabled={!customTarget.trim()} className="px-4 bg-indigo-600 text-white rounded-xl font-bold disabled:opacity-50">Á°ÆÂÆö</button></div></div>
                                <button onClick={() => setMoveModal({open:false, targetGroupWords:[]})} className="mt-6 w-full py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    )}
                    {editModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setEditModal({...editModal, open:false})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">ÁºñËæëÂàÜÁªÑ‰ø°ÊÅØ</h3>
                                <div className="mb-4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">ÂàÜÁªÑÂêçÁß∞</label><input type="text" value={editModal.currentName} onChange={e => setEditModal({...editModal, currentName: e.target.value})} placeholder="‰æãÂ¶Ç: 2010Âπ¥ÁúüÈ¢òÈòÖËØªA" className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" autoFocus /></div>
                                <div className="mb-6"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Â§áÊ≥® / ÁÆÄ‰ªã</label><textarea value={editModal.currentDesc} onChange={e => setEditModal({...editModal, currentDesc: e.target.value})} placeholder="‰æãÂ¶Ç: ËøôÈÉ®ÂàÜÂçïËØçÊØîËæÉÈöæÔºåÈúÄË¶ÅÂ§öÂ§ç‰π†Âá†Ê¨°..." className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none"></textarea></div>
                                <div className="flex space-x-3"><button onClick={() => setEditModal({...editModal, open:false})} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">ÂèñÊ∂à</button><button onClick={saveGroupInfo} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">‰øùÂ≠ò</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

    const StudySession = ({ words, setWords, sessionConfig, onExit, config, setChatSession }) => {
            const [queue, setQueue] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            // üî• ‰øÆÊîπÔºöÊääÂÖ®Â±Ä loading ÊîπÊàêËÆ∞ÂΩïÂÖ∑‰ΩìÂì™‰∏™Èáä‰πâÂú®Âä†ËΩΩ (Â≠ò indexÔºå-1 Ë°®Á§∫Ê≤°Êúâ)
            const [generatingMeaningIdx, setGeneratingMeaningIdx] = useState(-1);
            const [isFullscreen, setIsFullscreen] = useState(false);

            useEffect(() => {
                const now = Date.now();
                let q = [];
                const groupSize = config.groupSize || 208;
                if (sessionConfig.type === 'review') {
                    q = words.filter(w => w.stats && w.stats.nextReview <= now && w.stats.interval !== 0);
                    if(q.length === 0) q = words.filter(w => w.stats && w.stats.interval < 1 && w.stats.interval !== 0);
                    q = q.sort(() => Math.random() - 0.5).slice(0, 30);
                } else if (sessionConfig.type === 'group_study') {
                    const catWords = words.filter(w => (w.category || 'uncategorized') === sessionConfig.category);
                    const batchId = sessionConfig.batchId;
                    const batchWords = catWords.filter(w => (w.importId || 'default') === batchId);
                    const start = sessionConfig.batchIndex * groupSize;
                    const end = start + groupSize;
                    const targetGroup = batchWords.slice(start, end);
                    const newWords = targetGroup.filter(w => !w.stats || w.stats.interval === 0);
                    const reviewWords = targetGroup.filter(w => w.stats && w.stats.interval !== 0);
                    q = [...newWords, ...reviewWords];
                }
                setQueue(q);
            }, [sessionConfig]);

            useEffect(() => { if (queue.length > 0 && !isFinished && !isFlipped) { const word = queue[currentIdx]?.word; if (word) { const timer = setTimeout(() => playAudio(word), 300); return () => clearTimeout(timer); } } }, [currentIdx, queue, isFinished]);

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                    setIsFullscreen(true);
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        setIsFullscreen(false);
                    }
                }
            };

            if (queue.length === 0 && !isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-green-100 p-6 rounded-full mb-6 text-green-600"><Icon name="Check" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-2">ÂΩìÂâç‰ªªÂä°ÂÆåÊàê</h2><p className="text-gray-500 mb-8">‰ºëÊÅØ‰∏Ä‰∏ãÔºåÁ®çÂêéÂÜçÊù•ÔºÅ</p><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">ËøîÂõûÈ¶ñÈ°µ</button></div></div>;
            if (isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600"><Icon name="Sparkles" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-4">Êú¨ËΩÆÂ≠¶‰π†ÁªìÊùü üéâ</h2><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">ËøîÂõû</button></div></div>;

            const currentCard = queue[currentIdx];
            const handleRating = (rating) => {
                const word = currentCard;
                const currentStats = word.stats || { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 };
                const result = calculateNextReview(rating, currentStats.interval, currentStats.easeFactor, currentStats.reviewCount);
                const newStats = { interval: result.interval, easeFactor: result.easeFactor, nextReview: Date.now() + (result.interval * 24 * 60 * 60 * 1000), reviewCount: result.reviewCount };
                const updatedWords = words.map(w => w.id === word.id ? { ...w, stats: newStats } : w);
                setWords(updatedWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(updatedWords));
                if (result.isDueNow) setQueue(prev => [...prev, { ...word, stats: newStats, isRepeat: true }]);
                setIsFlipped(false); setTimeout(() => currentIdx + 1 >= queue.length ? setIsFinished(true) : setCurrentIdx(prev => prev + 1), 200);
            };
            const toggleMeaningMastery = (e, mIdx) => { e.stopPropagation(); const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], isMastered:!meanings[mIdx].isMastered, _forceShow:false}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); const newWords=[...words]; const idx=newWords.findIndex(w=>w.id===currentCard.id); if(idx!==-1){ newWords[idx]={...newWords[idx], meanings:meanings}; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            const toggleForceShow = (mIdx) => { const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], _forceShow:!meanings[mIdx]._forceShow}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); };
            
            const generateSentence = async (e, meaningIndex) => {
                e.stopPropagation(); 
                if (!config.apiKey) { alert("ËØ∑ËÆæÁΩÆ API Key"); return; } 
                // üî• ‰øÆÊîπÔºöËÆæÁΩÆÂΩìÂâçÊ≠£Âú®ÁîüÊàêÁöÑÁ¥¢ÂºïÔºåËß¶Âèë UI ÂèòÂåñ
                setGeneratingMeaningIdx(meaningIndex); 

                try {
                    // üî• ‰øÆÊîπÔºöPrompt ÊûÅÂÖ∂‰∏•Ê†ºÔºåË¶ÅÊ±Ç Markdown ÂàóË°®ÂíåÂ≠óÊï∞ÈôêÂà∂
                    const prompt = `ÈíàÂØπËÄÉÁ†îËã±ËØ≠ÔºåËØ∑Áî® Markdown Êó†Â∫èÂàóË°®Ê†ºÂºèÔºà- ÂºÄÂ§¥ÔºâÔºå**ÊûÅÁÆÄ**ÂàóÂá∫ÂçïËØç "${currentCard.word}" Âú®Èáä‰πâ "${currentCard.meanings[meaningIndex].def}" ‰∏ãÁöÑÔºö\n1. **ÁÜüËØçÂÉª‰πâ** (Â¶ÇÊúâ)\n2. **ÊòìÊ∑∑ËØç** (‰ªÖÈôê‰∏Ä‰∏™ÊúÄÂÉèÁöÑ)\n3. **ÁúüÈ¢òÂùëÁÇπ** (Êê≠ÈÖç/ËÄÉÊ≥ï)\n\nË¶ÅÊ±ÇÔºö**ÊÄªÂ≠óÊï∞‰∏•Ê†ºÊéßÂà∂Âú® 60 Â≠ó‰ª•ÂÜÖ**ÔºÅÁõ¥Êé•ÂÜôÂπ≤Ë¥ßÔºå‰∏çË¶Å‰ªª‰ΩïÂºÄÂú∫ÁôΩ„ÄÇ`;
                    
                    let newSentence = "";
                    if (config.type === 'google') { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({contents:[{parts:[{text:prompt}]}]}) }); const data = await res.json(); newSentence = data.candidates?.[0]?.content?.parts?.[0]?.text; }
                    else { let baseUrl = config.baseUrl.replace(/\/$/, ""); if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel") && !baseUrl.includes("lingyiwanwu") && !baseUrl.includes("siliconflow")) baseUrl += "/v1"; const res = await fetch(`${baseUrl}/chat/completions`, { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${config.apiKey}`}, body: JSON.stringify({model:config.model, messages:[{role:"user",content:prompt}]}) }); const data = await res.json(); newSentence = data.choices?.[0]?.message?.content; }
                    
                    if(newSentence) { 
                        const s = newSentence.trim().replace(/^["']|["']$/g, ''); 
                        const newWords = [...words]; newWords.find(w => w.id === currentCard.id).meanings[meaningIndex].sentence = s; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); const newQueue = [...queue]; newQueue[currentIdx].meanings[meaningIndex].sentence = s; setQueue(newQueue); 
                    }
                } catch(e){ 
                    alert("ÁîüÊàêÂ§±Ë¥•: " + e.message); 
                } finally { 
                    // üî• ‰øÆÊîπÔºöÊÅ¢Â§çÁä∂ÊÄÅ
                    setGeneratingMeaningIdx(-1); 
                }
            };

            return (
                <div className="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gray-200 z-10">
                        <div className="h-full bg-indigo-600 transition-all duration-300 ease-out" style={{width: `${(currentIdx / queue.length) * 100}%`}}></div>
                    </div>
                    
                    <button onClick={onExit} className="absolute top-4 left-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-600 hover:text-indigo-600 transition hover:bg-white" title="ÈÄÄÂá∫">
                        <Icon name="ArrowLeft" size={24}/>
                    </button>
                    
                    <button onClick={toggleFullscreen} className="absolute top-4 right-16 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-600 hover:text-indigo-600 transition hover:bg-white" title={isFullscreen ? "ÈÄÄÂá∫ÂÖ®Â±è" : "ÂÖ®Â±èÊ®°Âºè"}>
                        <Icon name={isFullscreen ? "Minimize" : "Maximize"} size={24}/>
                    </button>

                    <button onClick={(e)=>{e.stopPropagation(); setChatSession(currentCard.word);}} className="absolute top-4 right-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-indigo-500 hover:text-white hover:bg-indigo-500 transition" title="AI ËØ¶Ëß£">
                        <Icon name="MessageCircle" size={24}/>
                    </button>

                    <div className="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden">
                        <div className="relative scene w-full max-w-sm md:max-w-3xl aspect-[3/4] md:aspect-[4/3] max-h-[85vh]">
                            <div className={`card-object ${isFlipped ? 'is-flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                                {/* Âç°ÁâáÊ≠£Èù¢ */}
                                <div className="card-face flex flex-col items-center justify-center p-8 md:p-12 text-center bg-gradient-to-br from-white to-gray-50 border border-white">
                                    <div className="flex-1 flex flex-col items-center justify-center w-full">
                                        <h1 className="text-5xl md:text-7xl lg:text-8xl font-black text-gray-800 mb-6 md:mb-10 tracking-tight">{currentCard.word}</h1>
                                        <div className="flex items-center space-x-3 text-gray-500 bg-white border border-gray-200 shadow-sm px-5 py-2.5 rounded-full cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition transform hover:scale-105" onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}}>
                                            <Icon name="Volume2" size={24} className="md:w-7 md:h-7"/><span className="font-mono text-xl md:text-2xl">{currentCard.phonetic}</span>
                                        </div>
                                    </div>
                                    <div className="mt-auto text-gray-400 text-sm md:text-base animate-pulse font-medium">ÁÇπÂáªÁøªËΩ¨Êü•ÁúãÈáä‰πâ</div>
                                </div>
                                
                                {/* Âç°ÁâáËÉåÈù¢ */}
                                <div className="card-face card-face-back p-0 bg-white">
                                    <div className="flex-shrink-0 bg-white/95 backdrop-blur border-b border-gray-100 p-4 md:p-6 flex justify-between items-center z-10 shadow-sm">
                                        <h2 className="text-2xl md:text-4xl font-bold text-indigo-900">{currentCard.word}</h2>
                                        <button onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}} className="p-3 bg-indigo-50 rounded-full text-indigo-600 hover:bg-indigo-100 transition"><Icon name="Volume2" size={24}/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-4 md:space-y-6">
                                        {currentCard.meanings.map((m, idx) => {
                                            const isHidden = m.isMastered && !m._forceShow;
                                            return (
                                                <div key={idx} className="relative p-5 md:p-6 bg-white rounded-2xl border border-gray-100 shadow-sm transition-all hover:shadow-md hover:border-indigo-100">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="text-xs md:text-sm font-bold bg-indigo-50 text-indigo-600 px-2.5 py-1 rounded-md uppercase tracking-wide">{m.pos}</span>
                                                        <button onClick={(e) => toggleMeaningMastery(e, idx)} className={`p-2 rounded-lg transition active:scale-95 ${m.isMastered ? 'text-gray-400 bg-gray-100' : 'text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50'}`}>{m.isMastered ? <Icon name="EyeOff" size={20} /> : <Icon name="Eye" size={20} />}</button>
                                                    </div>
                                                    <div className="mb-3 min-h-[1.5rem]">
                                                        {isHidden ? (
                                                            <div onClick={(e) => { e.stopPropagation(); toggleForceShow(idx); }} className="bg-gray-50 text-gray-400 text-sm py-4 px-4 rounded-xl cursor-pointer flex items-center justify-center select-none hover:bg-gray-100 transition border border-dashed border-gray-200">
                                                                <Icon name="EyeOff" size={16} className="mr-2"/> Èáä‰πâÂ∑≤ÈöêËóè (ÁÇπÂáªÊü•Áúã)
                                                            </div>
                                                        ) : (
                                                            <div className="text-gray-800 font-medium text-lg md:text-2xl leading-relaxed">{m.def}</div>
                                                        )}
                                                    </div>
                                                    <div className="mt-4 pt-3 border-t border-gray-50">
                                                        {m.sentence ? 
                                                            <div className="text-sm text-gray-700 bg-orange-50 p-3 rounded-lg border-l-4 border-orange-300">
                                                                <div className="font-bold text-orange-800 mb-2 flex items-center text-xs md:text-sm"><span className="mr-1">üî•</span> ËÄÉÁÇπÁ¨îËÆ∞</div>
                                                                {/* üî• ‰øÆÊîπÔºö‰ΩøÁî® Markdown Ê∏≤ÊüìÔºåÊîØÊåÅÂä†Á≤óÂíåÂàóË°® */}
                                                                <div className="markdown-body text-xs md:text-sm leading-relaxed" dangerouslySetInnerHTML={{ __html: marked.parse(m.sentence) }} />
                                                            </div> 
                                                            : 
                                                            // üî• ‰øÆÊîπÔºöÊ†πÊçÆ generatingMeaningIdx Áä∂ÊÄÅÊòæÁ§∫Âä†ËΩΩ‰∏≠
                                                            <button onClick={(e) => generateSentence(e, idx)} disabled={generatingMeaningIdx === idx} className={`group flex items-center gap-2 px-3 py-2 rounded-lg transition-all w-fit border shadow-sm ${generatingMeaningIdx === idx ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-wait' : 'bg-orange-50 hover:bg-orange-100 text-orange-600 border-orange-100 active:scale-95'}`}>
                                                                {generatingMeaningIdx === idx ? (
                                                                    <>
                                                                        <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                                                                        <span className="text-xs font-bold">AI ÊåñÊéò‰∏≠...</span>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <span className="text-lg">üî•</span>
                                                                        <span className="text-xs md:text-sm font-bold whitespace-nowrap">ËÄÉÁ†îÈÅøÂùë (ÁÜüËØç/Ëæ®Êûê)</span>
                                                                    </>
                                                                )}
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        <div className="h-20"></div> 
                                    </div>
                                    <div className="flex-shrink-0 absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 md:p-6 flex space-x-3 md:space-x-6 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.1)] z-20">
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(1);}} className="flex-1 btn-press bg-red-50 hover:bg-red-100 text-red-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-red-100"><span>‰∏çËÆ§ËØÜ</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(2);}} className="flex-1 btn-press bg-yellow-50 hover:bg-yellow-100 text-yellow-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-yellow-100"><span>‰∏çÁÜü</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(3);}} className="flex-1 btn-press bg-green-50 hover:bg-green-100 text-green-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-green-100"><span>ËÆ§ËØÜ</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ImportExport = ({ setWords, words, setView, config }) => {
            const [activeTab, setActiveTab] = useState('data');
            const [textInput, setTextInput] = useState('');
            const [importMode, setImportMode] = useState('frequency');
            const [importCategory, setImportCategory] = useState('high');
            const [customGroupName, setCustomGroupName] = useState('');
            const [isNewBatch, setIsNewBatch] = useState(false);
            const [importBatchName, setImportBatchName] = useState(''); 
            
            const [aiInput, setAiInput] = useState('');
            const [isFetching, setIsFetching] = useState(false);
            const [fetchProgress, setFetchProgress] = useState({ current: 0, total: 0, success: 0, fail: 0 });

            const getTargetCategory = () => { if (importMode === 'frequency') return importCategory; return customGroupName.trim() || `Import ${new Date().toLocaleDateString()}`; };
            const saveBatchMeta = (batchId) => { if (isNewBatch && importBatchName.trim()) { try { const metaStr = localStorage.getItem('kaoyan_group_meta'); const meta = metaStr ? JSON.parse(metaStr) : {}; meta[batchId] = { name: importBatchName.trim(), desc: "" }; localStorage.setItem('kaoyan_group_meta', JSON.stringify(meta)); } catch (e) { console.error(e); } } };

            const parseMultiPos = (rawWord, fullText) => {
                let remains = fullText.substring(rawWord.length).trim();
                const parts = remains.split(/(?:^|\s+)([a-z]{1,5}\.)\s+/).filter(p => p.trim());
                const meanings = [];
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.match(/^[a-z]{1,5}\.$/)) { const def = parts[i+1] || ""; meanings.push({ pos: part, def: def.trim(), sentence: "", isMastered: false }); i++; } 
                    else if(i === 0) meanings.push({ pos: "mix.", def: part.trim(), sentence: "", isMastered: false });
                }
                return meanings;
            };

            const parseAndImport = () => { 
                if(!textInput.trim()) return;
                const targetCat = getTargetCategory(); const segments = textInput.split(/[;\n]+/);
                let addedCount = 0, mergedCount = 0; let currentWords = JSON.parse(JSON.stringify(words)); 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default'; saveBatchMeta(batchId);
                segments.forEach((seg, idx) => {
                    seg = seg.trim(); if (!seg) return;
                    const matchHead = seg.match(/^([a-zA-Z\-\s]+?)\s+/);
                    if (matchHead) {
                        const rawWord = matchHead[1].trim(); const parsedMeanings = parseMultiPos(rawWord, seg);
                        if (parsedMeanings.length > 0) {
                            const existingIdx = currentWords.findIndex(w => w.word.toLowerCase() === rawWord.toLowerCase());
                            if (!isNewBatch && existingIdx !== -1) { const existingWord = currentWords[existingIdx]; parsedMeanings.forEach(nm => { if (!existingWord.meanings.some(om => om.pos === nm.pos && om.def === nm.def)) existingWord.meanings.push(nm); }); mergedCount++; } 
                            else { currentWords.push({ id: `auto-${Date.now()}-${idx}`, word: rawWord, phonetic: "", category: targetCat, importId: batchId, meanings: parsedMeanings, stats: { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 } }); addedCount++; }
                        }
                    }
                });
                if (addedCount > 0 || mergedCount > 0) { setWords(currentWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords)); alert(`ÂØºÂÖ•ÊàêÂäüÔºÅÊñ∞Â¢û: ${addedCount}, ÂêàÂπ∂: ${mergedCount}`); setTextInput(''); setImportBatchName(''); } else alert("Ê†ºÂºèÈîôËØØ");
            };

            const repairData = () => {
                let fixedCount = 0;
                const newWords = words.map(w => {
                    let needsFix = false; let newMeanings = [];
                    w.meanings.forEach(m => {
                        const parts = m.def.split(/\s+([a-z]{1,4}\.)\s+/);
                        if (parts.length > 1) { needsFix = true; newMeanings.push({ ...m, def: parts[0].trim() }); for (let i = 1; i < parts.length; i += 2) if (parts[i+1]) newMeanings.push({ pos: parts[i], def: parts[i+1].trim(), sentence: "", isMastered: false }); } else newMeanings.push(m);
                    });
                    if (needsFix) { fixedCount++; return { ...w, meanings: newMeanings }; } return w;
                });
                if (fixedCount > 0) { setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); alert(`üéâ ‰øÆÂ§çÊàêÂäüÔºÅÊï¥ÁêÜ‰∫Ü ${fixedCount} ‰∏™ÂçïËØç„ÄÇ`); } else alert("ÊöÇÊú™ÂèëÁé∞Ê†ºÂºèÈîô‰π±ÁöÑÂçïËØç„ÄÇ");
            };

            const fetchWordsFromAI = async () => {
                if (!config.apiKey) { alert("ËØ∑ÈÖçÁΩÆ Key"); return; } if (!aiInput.trim()) return; const wordList = aiInput.split(/[\s,\n]+/).filter(w => w.trim().match(/^[a-zA-Z\-]+$/)); if(wordList.length===0) return;
                setIsFetching(true); setFetchProgress({ current: 0, total: wordList.length, success: 0, fail: 0 }); const targetCat = getTargetCategory(); 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default'; saveBatchMeta(batchId);
                const BATCH_SIZE = 5; let currentWords = JSON.parse(JSON.stringify(words)); let successCount = 0; let failCount = 0;
                for (let i = 0; i < wordList.length; i += BATCH_SIZE) {
                    const batch = wordList.slice(i, i + BATCH_SIZE); const batchStr = batch.join(", "); const prompt = `ËÄÉÁ†îÂçïËØçÊü•ËØ¢JSON:[${batchStr}]`;
                    try {
                        let jsonStr=""; if(config.type==='google'){ const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey.trim()}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})}); const data=await res.json(); jsonStr=data.candidates?.[0]?.content?.parts?.[0]?.text; } else { let baseUrl=config.baseUrl.replace(/\/$/,""); if(!baseUrl.includes("/v1")&&!baseUrl.includes("aliyuncs")&&!baseUrl.includes("bigmodel")&&!baseUrl.includes("lingyiwanwu")&&!baseUrl.includes("siliconflow"))baseUrl+="/v1"; const res=await fetch(`${baseUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${config.apiKey.trim()}`},body:JSON.stringify({model:config.model,messages:[{role:"user",content:prompt}]})}); const data=await res.json(); jsonStr=data.choices?.[0]?.message?.content; }
                        if(!jsonStr) throw new Error("Empty"); jsonStr=jsonStr.replace(/```json/g,'').replace(/```/g,'').trim(); const parsedBatch=JSON.parse(jsonStr);
                        if(Array.isArray(parsedBatch)){ parsedBatch.forEach(item=>{ const existIdx=currentWords.findIndex(w=>w.word.toLowerCase()===item.word.toLowerCase()); const meanings=item.meanings.map(m=>({...m,sentence:"",isMastered:false})); if(!isNewBatch && existIdx!==-1){ item.meanings.forEach(nm=>{ if(!currentWords[existIdx].meanings.some(om=>om.pos===nm.pos && om.def===nm.def)) currentWords[existIdx].meanings.push({...nm,sentence:"",isMastered:false}); }); }else{ currentWords.push({id:`ai-${Date.now()}-${Math.random()}`,word:item.word,phonetic:item.phonetic||"",category:targetCat,importId:batchId,meanings,stats:{interval:0,easeFactor:2.5,nextReview:0,reviewCount:0}}); } }); successCount+=batch.length; }
                    } catch(err){ failCount+=batch.length; }
                    setFetchProgress({ current: Math.min(i+BATCH_SIZE, wordList.length), total: wordList.length, success: successCount, fail: failCount }); setWords([...currentWords]); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords));
                } setIsFetching(false); alert("ÂÆåÊàê"); setImportBatchName('');
            };

            const handleFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const content = JSON.parse(ev.target.result); if (content.type === 'KAOYAN_FULL_BACKUP' && content.storage) { if(confirm(`ÊÅ¢Â§çÂ§á‰ªΩÂ∞ÜË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºåÁ°ÆÂÆöÂêóÔºü`)) { Object.keys(content.storage).forEach(key => { if(key.startsWith('kaoyan_')) localStorage.setItem(key, content.storage[key]); }); window.location.reload(); } return; } if (Array.isArray(content)) { if(confirm(`ÂØºÂÖ•ÊóßÁâàÂçïËØçË°®?`)) { setWords(content); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(content)); alert("ÂÆåÊàê"); } return; } } catch(err) { alert("ÈîôËØØ"); } }; reader.readAsText(file); };
            const exportFullData = async () => { 
                const storage = {}; for(let i=0; i<localStorage.length; i++) { const key = localStorage.key(i); if(key && key.startsWith('kaoyan_')) storage[key] = localStorage.getItem(key); } 
                const backup = { type: 'KAOYAN_FULL_BACKUP', version: 1.0, timestamp: Date.now(), storage };
                const date = new Date(); const fileName = `ËÄÉÁ†îÂ§á‰ªΩ_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate()}.json`;
                const blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"}); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); 
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">Êï∞ÊçÆ‰∏≠ÂøÉ</h2>
                        <div className="flex mb-6 border-b border-gray-100">
                            <button onClick={() => setActiveTab('data')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='data'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>Â§á‰ªΩ‰∏éÊÅ¢Â§ç</button>
                            <button onClick={() => setActiveTab('ai')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='ai'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>AI ÈÄüÊü•</button>
                            <button onClick={() => setActiveTab('text')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='text'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>ÊâπÈáèÁ≤òË¥¥</button>
                        </div>
                        
                        {activeTab === 'data' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="p-5 bg-orange-50 border border-orange-100 rounded-2xl flex justify-between items-center shadow-sm">
                                    <div><h3 className="font-bold text-orange-900 text-sm mb-1">ËØçÊÄßÊ†ºÂºè‰øÆÂ§ç</h3><p className="text-xs text-orange-700/70">Ëá™Âä®ÊãÜÂàÜ v. adj. Á≠âËøûÂú®‰∏ÄËµ∑ÁöÑÈáä‰πâ</p></div>
                                    <button onClick={repairData} className="px-4 py-2 bg-white text-orange-600 border border-orange-200 rounded-lg font-bold text-xs shadow-sm hover:bg-orange-100 transition">üõ†Ô∏è ‰øÆÂ§ç</button>
                                </div>

                                <div className="p-6 bg-indigo-50 rounded-2xl border border-indigo-100 shadow-sm">
                                    <div className="flex items-center mb-4"><Icon name="Folder" size={24} className="mr-2 text-indigo-600"/><h3 className="font-bold text-indigo-900 text-lg">Êú¨Âú∞Â§á‰ªΩ</h3></div>
                                    <p className="text-indigo-800/80 text-xs mb-4">ÁîüÊàê .json Êñá‰ª∂Âπ∂‰øùÂ≠òÂà∞ÊâãÊú∫/ÁîµËÑëÔºåÂÆâÂÖ®ÂèØÈù†„ÄÇ</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={exportFullData} className="py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm hover:bg-indigo-50 flex flex-col items-center justify-center transition">
                                            <Icon name="Upload" size={20} className="mb-1"/><span className="text-xs">ÂØºÂá∫Êñá‰ª∂</span>
                                        </button>
                                        <div className="relative">
                                            <button className="w-full h-full py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm hover:bg-indigo-50 flex flex-col items-center justify-center transition">
                                                <Icon name="Download" size={20} className="mb-1"/><span className="text-xs">ÂØºÂÖ•Êñá‰ª∂</span>
                                            </button>
                                            <input type="file" onChange={handleFile} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-100 text-center">
                                    <button onClick={() => {if(confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) { setWords([]); localStorage.clear(); window.location.reload(); }}} className="text-red-400 text-xs hover:text-red-600 underline transition">ÈáçÁΩÆÂ∫îÁî® (Ê∏ÖÁ©∫Êï∞ÊçÆ)</button>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'ai' || activeTab === 'text') && (
                            <div className="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <div className="flex space-x-6 mb-4">
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='frequency'} onChange={()=>setImportMode('frequency')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">Â≠òÂÖ•ËÄÉÈ¢ë</span></label>
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='group'} onChange={()=>setImportMode('group')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">Ëá™ÂÆö‰πâÂàÜÁªÑ</span></label>
                                </div>
                                {importMode==='frequency' ? (<div className="grid grid-cols-4 gap-2 mb-4">{['high','medium','low','zero'].map(cat=>(<button key={cat} onClick={()=>setImportCategory(cat)} className={`py-2 text-sm rounded-lg border ${importCategory===cat?'bg-indigo-600 text-white':'bg-white text-gray-600'}`}>{cat}</button>))}</div>) : (<div className="mb-4"><input type="text" value={customGroupName} onChange={e=>setCustomGroupName(e.target.value)} placeholder="ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞" className="w-full p-3 border rounded-lg text-sm outline-none"/></div>)}
                                <label className="flex items-center pt-4 border-t border-gray-200 cursor-pointer"><input type="checkbox" checked={isNewBatch} onChange={e=>setIsNewBatch(e.target.checked)} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-bold text-gray-700">Áã¨Á´ã‰∏∫Êñ∞ÊâπÊ¨°</span></label>
                                {isNewBatch && (<div className="mt-4 animate-fade-in"><input type="text" value={importBatchName} onChange={e=>setImportBatchName(e.target.value)} placeholder="‰æãÂ¶Ç: 2015ÁúüÈ¢ò" className="w-full p-3 border border-indigo-200 bg-indigo-50 rounded-lg text-sm outline-none"/></div>)}
                            </div>
                        )}

                        {activeTab === 'ai' && (<div className="space-y-4"><textarea value={aiInput} onChange={e => setAiInput(e.target.value)} placeholder="ËæìÂÖ•ÂçïËØç..." className="w-full h-40 p-4 border rounded-xl text-sm outline-none resize-none"></textarea>{isFetching ? <div className="text-center text-sm py-3 bg-indigo-50 text-indigo-600 rounded-xl animate-pulse">AI ÊäìÂèñ‰∏≠...</div> : <button onClick={fetchWordsFromAI} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Icon name="CloudDownload" size={20}/> ÂºÄÂßã</button>}</div>)}
                        {activeTab === 'text' && (<div className="space-y-4"><textarea value={textInput} onChange={e => setTextInput(e.target.value)} placeholder="Ê†ºÂºèÔºöword n. Èáä‰πâ v. Èáä‰πâ..." className="w-full h-48 p-4 border rounded-xl text-sm outline-none resize-none"></textarea><button onClick={parseAndImport} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">ÂºÄÂßãÂØºÂÖ•</button></div>)}
                    </div>
                </div>
            );
        };

      const SettingsPanel = ({ config, setConfig, setView }) => {
            const [selectedPreset, setSelectedPreset] = useState('deepseek');
            const [models, setModels] = useState([]);
            const [isFetching, setIsFetching] = useState(false);
            const [showModelPicker, setShowModelPicker] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            
            useEffect(() => {
                const matchedKey = Object.keys(API_PRESETS).find(key => {
                    const preset = API_PRESETS[key];
                    return preset.type === config.type && (preset.type === 'google' || config.baseUrl.includes(preset.url));
                });
                if (matchedKey) setSelectedPreset(matchedKey); else setSelectedPreset('custom');
            }, []);

            const handlePresetChange = (key) => {
                setSelectedPreset(key);
                const preset = API_PRESETS[key];
                setConfig(prev => ({ ...prev, type: preset.type, baseUrl: preset.url }));
                // ÂàáÊç¢È¢ÑËÆæÊó∂Ê∏ÖÁ©∫Â∑≤Âä†ËΩΩÁöÑÊ®°ÂûãÂàóË°®
                setModels([]); 
                setShowModelPicker(false);
            };

            const updateConfigTrimmed = (key, value) => setConfig(prev => ({ ...prev, [key]: value.trim() }));

            // üî• Êñ∞Â¢ûÔºöËé∑ÂèñÊ®°ÂûãÂàóË°®ÁöÑÂäüËÉΩ
            const fetchModels = async () => {
                if (!config.apiKey) return alert("ËØ∑ÂÖàÂ°´ÂÜô API Key");
                if (selectedPreset === 'google') return alert("Google Gemini ÊöÇ‰∏çÊîØÊåÅËá™Âä®Ëé∑ÂèñÂàóË°®ÔºåËØ∑ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÔºàÂ¶Ç gemini-proÔºâ");
                
                setIsFetching(true);
                try {
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    
                    const res = await fetch(`${baseUrl}/models`, {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${config.apiKey}` }
                    });
                    
                    if (!res.ok) throw new Error("ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• Key Êàñ URL");
                    const data = await res.json();
                    
                    // ÂÖºÂÆπ‰∏çÂêåÂéÇÂïÜÁöÑËøîÂõûÊ†ºÂºè
                    let list = [];
                    if (Array.isArray(data.data)) list = data.data; // OpenAI Ê†áÂáÜ
                    else if (Array.isArray(data)) list = data; // Êüê‰∫õÂÖºÂÆπÊé•Âè£
                    
                    if (list.length > 0) {
                        // ÊåâÂ≠óÊØçÊéíÂ∫è
                        list.sort((a, b) => (a.id || a).localeCompare(b.id || b));
                        setModels(list);
                        setShowModelPicker(true);
                    } else {
                        alert("Êú™Ëé∑ÂèñÂà∞Ê®°ÂûãÂàóË°®ÔºåËØ∑ÊâãÂä®ËæìÂÖ•");
                    }
                } catch (e) {
                    alert("Ëé∑ÂèñÂ§±Ë¥•: " + e.message);
                } finally {
                    setIsFetching(false);
                }
            };

            const filteredModels = models.filter(m => {
                const id = typeof m === 'string' ? m : m.id;
                return id.toLowerCase().includes(searchQuery.toLowerCase());
            });

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit space-y-6">
                        <h2 className="text-xl font-bold border-b border-gray-100 pb-4 text-gray-800">ËÆæÁΩÆ</h2>
                        <div className="pt-2">
                            <label className="block text-sm font-bold text-gray-700 mb-2">AI ÂéÇÂïÜ (È¢ÑËÆæ)</label>
                            <select value={selectedPreset} onChange={(e) => handlePresetChange(e.target.value)} className="w-full border border-gray-200 p-3 rounded-xl bg-white outline-none mb-3 focus:ring-2 focus:ring-indigo-500">
                                {Object.entries(API_PRESETS).map(([key, val]) => (<option key={key} value={key}>{val.name}</option>))}
                            </select>
                            
                            <div className={selectedPreset === 'google' ? 'hidden' : 'block animate-fade-in'}>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">API Base URL</label>
                                <input value={config.baseUrl} onChange={e => updateConfigTrimmed('baseUrl', e.target.value)} className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 mb-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://api.openai.com/v1" disabled={selectedPreset !== 'custom'}/>
                            </div>
                            
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">API Key</label>
                            <input value={config.apiKey} onChange={e => updateConfigTrimmed('apiKey', e.target.value)} type="password" placeholder="sk-..." className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 mb-3 outline-none focus:ring-2 focus:ring-indigo-500"/>
                            
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Ê®°ÂûãÂêçÁß∞ (Model)</label>
                            <div className="relative">
                                <div className="flex gap-2">
                                    <input value={config.model} onChange={e => updateConfigTrimmed('model', e.target.value)} placeholder="‰æãÂ¶Ç: gpt-3.5-turbo" className="flex-1 border border-gray-200 p-3 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"/>
                                    <button onClick={fetchModels} disabled={isFetching || !config.apiKey} className="px-4 bg-indigo-50 text-indigo-600 rounded-xl font-bold hover:bg-indigo-100 transition whitespace-nowrap disabled:opacity-50 flex items-center">
                                        {isFetching ? <div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mr-1"></div> : <Icon name="CloudDownload" size={18} className="mr-1"/>}
                                        {isFetching ? "Ëé∑Âèñ‰∏≠" : "ÈÄâÊ®°Âûã"}
                                    </button>
                                </div>

                                {/* üî• Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó/‰∏ãÊãâÂàóË°® */}
                                {showModelPicker && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 overflow-hidden animate-fade-in ring-1 ring-black/5">
                                        <div className="p-2 border-b border-gray-100 bg-gray-50">
                                            <input 
                                                type="text" 
                                                placeholder="üîç ÊêúÁ¥¢Ê®°Âûã..." 
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full p-2 text-sm bg-white border border-gray-200 rounded-lg outline-none focus:border-indigo-500"
                                                autoFocus
                                            />
                                        </div>
                                        <div className="max-h-60 overflow-y-auto custom-scroll">
                                            {filteredModels.length === 0 ? (
                                                <div className="p-4 text-center text-gray-400 text-sm">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Ê®°Âûã</div>
                                            ) : (
                                                filteredModels.map((m, idx) => {
                                                    const id = typeof m === 'string' ? m : m.id;
                                                    return (
                                                        <div 
                                                            key={idx} 
                                                            onClick={() => { updateConfigTrimmed('model', id); setShowModelPicker(false); }}
                                                            className={`px-4 py-3 text-sm cursor-pointer hover:bg-indigo-50 transition flex justify-between items-center ${config.model === id ? 'bg-indigo-50 text-indigo-700 font-bold' : 'text-gray-700'}`}
                                                        >
                                                            <span>{id}</span>
                                                            {config.model === id && <Icon name="Check" size={14}/>}
                                                        </div>
                                                    )
                                                })
                                            )}
                                        </div>
                                        <div className="p-2 bg-gray-50 border-t border-gray-100 text-center">
                                            <button onClick={() => setShowModelPicker(false)} className="text-xs text-gray-500 hover:text-gray-700">ÂÖ≥Èó≠ÂàóË°®</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <button onClick={()=>{ localStorage.setItem('kaoyan_config', JSON.stringify(config)); setView('home'); }} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg transition active:scale-95">‰øùÂ≠òÈÖçÁΩÆ</button>
                    </div>
                    {/* ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠‰∏ãÊãâÊ°Ü */}
                    {showModelPicker && <div className="fixed inset-0 z-40" onClick={() => setShowModelPicker(false)}></div>}
                </div>
            );
        };
        
        const App = () => {
            const [view, setView] = useState('home');
            const [words, setWords] = useState([]);
            const [sessionConfig, setSessionConfig] = useState({}); 
            const [config, setConfig] = useState({ type: 'openai', baseUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat', groupSize: 208, autoSync: false });
            const [chatSession, setChatSession] = useState(null);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('kaoyan_vocab_list');
                    const savedCfg = localStorage.getItem('kaoyan_config');
                    if (saved) setWords(JSON.parse(saved));
                    if (savedCfg) setConfig(JSON.parse(savedCfg));
                } catch(e) {}
                const loader = document.getElementById('root').querySelector('div');
                if(loader && loader.style.border) loader.remove();
            }, []);

            const handleBack = () => {
                if (view === 'study') {
                    if (sessionConfig.type === 'group_study') setView('group_list');
                    else setView('home');
                } else if (view === 'group_list') setView('home');
                else setView('home');
            };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <Navbar view={view} setView={setView} />
                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        {view === 'home' && <Dashboard words={words} setView={setView} setSessionConfig={setSessionConfig} />}
                        {view === 'group_list' && <GroupList words={words} setWords={setWords} category={sessionConfig.category} setView={setView} setSessionConfig={setSessionConfig} config={config} />}
                        {view === 'study' && <StudySession words={words} setWords={setWords} sessionConfig={sessionConfig} onExit={handleBack} config={config} setChatSession={setChatSession} />}
                        {view === 'list' && <WordListMode words={words} setWords={setWords} setChatSession={setChatSession} />}
                        {view === 'import' && <ImportExport setWords={setWords} words={words} setView={setView} config={config} />}
                        {view === 'settings' && <SettingsPanel config={config} setConfig={setConfig} setView={setView} />}
                        {chatSession && (<div className="absolute inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in"><WordChat word={chatSession} onClose={() => setChatSession(null)} config={config} /></div>)}
                    </main>
                    <style>{`
                        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
                        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
                        .animate-fade-in { animation: fade-in 0.2s ease-out; }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
