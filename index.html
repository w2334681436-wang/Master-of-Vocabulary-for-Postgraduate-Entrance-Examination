<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€ƒç ”è¯æ±‡å¤§å¸ˆ</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.staticfile.net/lz-string/1.4.4/lz-string.min.js"></script>

    <style>
        /* å…¨å±€æ ·å¼ä¸å­—ä½“ */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        
        /* 3D å¡ç‰‡ç¿»è½¬æ•ˆæœ */
        .scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        .card-face-back { transform: rotateY(180deg); }
        
        /* æ»šåŠ¨æ¡éšè—ä¸ç‚¹å‡»æ€ */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Markdown å†…å®¹æ ·å¼ */
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body strong { color: inherit; font-weight: 700; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body code { background-color: rgba(0,0,0,0.05); padding: 0.1em 0.3em; border-radius: 3px; font-family: monospace; }
        
        /* åŠ¨ç”» */
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">èµ„æºåŠ è½½ä¸­...</p>
        </div>
    </div>

    <script>
        // PWA Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Icons (å±…ä¸­ä¿®å¤ç‰ˆ) ---
        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Maximize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
            Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            MessageCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Palette: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const Svg = Icons[name] || Icons.Book;
            return <span className={`flex justify-center items-center ${className}`} style={{ width: size, height: size }}><Svg /></span>;
        };

        const API_PRESETS = {
            "deepseek": { name: "DeepSeek (æ·±åº¦æ±‚ç´¢)", type: "openai", url: "https://api.deepseek.com" },
            "siliconflow": { name: "SiliconFlow (ç¡…åŸºæµåŠ¨)", type: "openai", url: "https://api.siliconflow.cn/v1" },
            "openai": { name: "OpenAI (å®˜æ–¹)", type: "openai", url: "https://api.openai.com/v1" },
            "moonshot": { name: "Moonshot (Kimi)", type: "openai", url: "https://api.moonshot.cn/v1" },
            "zhipu": { name: "æ™ºè°±AI (GLM)", type: "openai", url: "https://open.bigmodel.cn/api/paas/v4" },
            "aliyun": { name: "é˜¿é‡Œäº‘ (é€šä¹‰åƒé—®)", type: "openai", url: "https://dashscope.aliyuncs.com/compatible-mode/v1" },
            "yi": { name: "é›¶ä¸€ä¸‡ç‰© (Yi)", type: "openai", url: "https://api.lingyiwanwu.com/v1" },
            "google": { name: "Google (Gemini)", type: "google", url: "" },
            "custom": { name: "è‡ªå®šä¹‰ (OpenAIå…¼å®¹)", type: "openai", url: "" }
        };

        const playAudio = (text) => {
            if (text.includes(' ') || text.length > 20) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US'; u.rate = 0.9;
                    window.speechSynthesis.speak(u);
                }
            } else {
                const audio = new Audio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`);
                audio.play().catch(() => {
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                });
            }
        };

        const calculateNextReview = (rating, currentInterval, easeFactor, currentReviewCount) => {
            let nextInterval, nextEaseFactor = easeFactor;
            const newReviewCount = (currentReviewCount || 0) + 1;
            if (rating === 1) return { interval: 0, easeFactor: Math.max(1.3, easeFactor - 0.2), isDueNow: true, reviewCount: newReviewCount };
            else if (rating === 2) return { interval: 0.5, easeFactor: Math.max(1.3, easeFactor - 0.15), isDueNow: true, reviewCount: newReviewCount };
            else {
                if (currentInterval === 0) nextInterval = 1;
                else if (currentInterval === 1) nextInterval = 3;
                else nextInterval = Math.round(currentInterval * easeFactor);
                return { interval: nextInterval, easeFactor: easeFactor + 0.1, isDueNow: false, reviewCount: newReviewCount };
            }
        };

        const WordChat = ({ word, onClose, config }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [thinkMode, setThinkMode] = useState("fast");
            const [bubbleColor, setBubbleColor] = useState("bg-indigo-600");
            const [showColorPicker, setShowColorPicker] = useState(false);
            const messagesEndRef = useRef(null);
            const colors = [{ name: "Indigo", class: "bg-indigo-600" }, { name: "Pink", class: "bg-pink-500" }, { name: "Green", class: "bg-emerald-500" }, { name: "Blue", class: "bg-blue-500" }, { name: "Orange", class: "bg-orange-500" }, { name: "Black", class: "bg-gray-800" }];

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
            useEffect(() => { scrollToBottom(); }, [messages]);
            useEffect(() => {
                setMessages([{ role: "assistant", content: `Hi! æˆ‘æ˜¯ä½ çš„ä¸“å± AI ç§æ•™ã€‚\næˆ‘ä»¬ä»Šå¤©è¦æ­»ç£•çš„å•è¯æ˜¯ï¼š **${word}**ã€‚\n\nä½ å¯ä»¥åˆ‡æ¢ä¸Šæ–¹æ¨¡å¼ï¼š\nâš¡ **å¿«é€Ÿ**ï¼šç®€å•é€šä¿—è®²è§£\nğŸ“– **æ·±åº¦**ï¼šè€ƒç ”çœŸé¢˜è€ƒæ³•\nğŸ‘„ **å£è¯­**ï¼šçº¯è‹±å¯¹è¯ç»ƒå¬åŠ›` }]);
                handleSend(null, `è¯·ç”¨é€šä¿—æ˜“æ‡‚ã€ç”Ÿæ´»åŒ–çš„åœºæ™¯ï¼ˆåƒè®²æ•…äº‹ä¸€æ ·ï¼‰è®²è§£å•è¯ "${word}"ã€‚æ‹†åˆ†ä¸ºï¼š1.ä½œä¸ºåè¯/åŠ¨è¯çš„æ ¸å¿ƒå«ä¹‰ï¼›2.ç»™å‡ºä¸€ä¸ªå®¹æ˜“è®°ä½çš„åœºæ™¯ä¾‹å­ï¼›3.æ€»ç»“è®°å¿†ç‚¹ã€‚ä½¿ç”¨ Markdown æ ¼å¼ï¼Œé‡ç‚¹åŠ ç²—ã€‚`);
            }, []);

            const handleSend = async (e, manualContent) => {
                if (e) e.preventDefault();
                const content = manualContent || input.trim();
                if (!content || isLoading) return;
                if (!manualContent) { setMessages(prev => [...prev, { role: "user", content }]); setInput(""); }
                setIsLoading(true);
                let systemPrompt = "";
                if (thinkMode === 'oral') systemPrompt = "You are a friendly American English tutor. Speak ONLY in English. Keep your sentences simple, clear, and encouraging. Correct the user's grammar gently if needed. Engage in a conversation using the target word.";
                else if (thinkMode === 'deep') systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸¥è‚ƒçš„è€ƒç ”è‹±è¯­å‘½é¢˜ç»„ä¸“å®¶ã€‚è¯·ä»è¯æºè¯æ ¹ã€ç†Ÿè¯åƒ»ä¹‰ã€å†å¹´çœŸé¢˜è€ƒæ³•ã€æ˜“æ··è¯è¾¨æè¿™å››ä¸ªç»´åº¦è¿›è¡Œæ·±åº¦è§£æã€‚å¿…é¡»ä½¿ç”¨ Markdown æ ¼å¼ï¼Œå…³é”®ç‚¹åŠ ç²—ã€‚";
                else systemPrompt = "ä½ æ˜¯ä¸€ä½éå¸¸æ“…é•¿ç±»æ¯”çš„è‹±è¯­ç§æ•™ã€‚è¯·ç”¨æœ€é€šä¿—ã€ç”Ÿæ´»åŒ–ã€ç”šè‡³æœ‰ç‚¹å¹½é»˜çš„è¯­è¨€è§£é‡Šå•è¯ã€‚æ ¸å¿ƒç­–ç•¥ï¼š1.æŠŠæŠ½è±¡æ¦‚å¿µå…·è±¡åŒ–ã€‚2.å¤šç”¨ç”Ÿæ´»åœºæ™¯ä¸²è”ä¸åŒè¯æ€§ã€‚3.æœ€åç»™ä¸€å¥â€œç®€å•è®°â€å£è¯€ã€‚ä½¿ç”¨ Markdown æ ¼å¼ã€‚";

                try {
                    const apiMessages = [{ role: "system", content: systemPrompt }, ...messages.filter(m => m.role !== 'error' && m.content !== '...'), { role: "user", content }];
                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);
                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";
                    const response = await fetch(`${baseUrl}/chat/completions`, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${config.apiKey}` }, body: JSON.stringify({ model: config.model, messages: apiMessages, stream: true }) });
                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try { const json = JSON.parse(data); const delta = json.choices[0]?.delta?.content || ""; fullText += delta; setMessages(prev => { const newMsgs = [...prev]; newMsgs[newMsgs.length - 1] = { role: "assistant", content: fullText }; return newMsgs; }); } catch (e) { }
                            }
                        }
                    }
                } catch (error) { setMessages(prev => [...prev, { role: "error", content: "å‡ºé”™äº†: " + error.message }]); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-white md:max-w-md md:mx-auto md:my-4 md:rounded-2xl md:shadow-2xl md:border md:border-gray-200 overflow-hidden animate-slide-up">
                    <div className="flex justify-between items-center p-4 border-b bg-white z-10 shadow-sm">
                        <div className="flex flex-col">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center">{word} <span className="ml-2 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded">AI ç§æ•™</span></h3>
                            <div className="flex gap-2 mt-2">
                                <button onClick={() => setThinkMode('fast')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='fast' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>âš¡ å¿«é€Ÿ</button>
                                <button onClick={() => setThinkMode('deep')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='deep' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>ğŸ“– æ·±åº¦</button>
                                <button onClick={() => setThinkMode('oral')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='oral' ? 'bg-orange-50 text-orange-600 border-orange-200 font-bold' : 'text-gray-500 border-transparent'}`}>ğŸ‘„ å£è¯­</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={()=>setShowColorPicker(!showColorPicker)} className="p-2 rounded-full hover:bg-gray-100 text-gray-400 relative"><Icon name="Palette" size={20}/></button>
                            {showColorPicker && (<div className="absolute right-14 top-16 bg-white shadow-xl border rounded-lg p-2 grid grid-cols-3 gap-2 w-32 z-50">{colors.map(c => (<div key={c.name} onClick={()=>setBubbleColor(c.class)} className={`w-6 h-6 rounded-full cursor-pointer border border-gray-100 ${c.class}`}></div>))}</div>)}
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 text-gray-400"><Icon name="X" size={24}/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-5 bg-gray-50 custom-scroll" onClick={()=>setShowColorPicker(false)}>
                        {messages.map((msg, idx) => (<div key={idx} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`flex flex-col max-w-[90%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}><div className={`p-3.5 rounded-2xl text-sm md:text-base leading-relaxed shadow-sm relative group ${msg.role === 'user' ? 'bg-white text-gray-800 border border-gray-100 rounded-tr-none' : `${bubbleColor} text-white rounded-tl-none markdown-body`} ${msg.role === 'error' ? 'bg-red-50 text-red-600 border-red-200' : ''}`}>{msg.role === 'assistant' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}{msg.role === 'assistant' && msg.content !== '...' && (<button onClick={(e) => {e.stopPropagation(); playAudio(msg.content.replace(/[\*\#]/g, ''));}} className="absolute -right-8 bottom-0 p-1.5 text-gray-400 hover:text-indigo-600 bg-white/50 rounded-full hover:bg-white transition shadow-sm"><Icon name="Volume2" size={16}/></button>)}</div></div></div>))}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="p-3 bg-white border-t flex items-end gap-2 safe-bottom">
                        <textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}} placeholder="è¾“å…¥é—®é¢˜..." className="flex-1 max-h-32 p-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-100 outline-none resize-none text-sm" rows="1"></textarea>
                        <button onClick={(e)=>handleSend(e)} disabled={isLoading || !input.trim()} className={`p-3 rounded-xl text-white shadow-md transition-all ${isLoading || !input.trim() ? 'bg-gray-300' : bubbleColor} active:scale-95`}>{isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icon name="Send" size={20} />}</button>
                    </div>
                </div>
            );
        };

        // --- æ ¸å¿ƒç»„ä»¶åŒºåŸŸ ---

        const Navbar = ({ view, setView }) => (
            <nav className="bg-indigo-600 text-white shadow-md sticky top-0 z-50 safe-top transition-all duration-300 flex-shrink-0">
                <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                    <div className="flex items-center space-x-2" onClick={() => setView('home')}>
                        <div className="font-bold text-lg cursor-pointer flex items-center space-x-2"><Icon name="Book" size={24}/><span className="tracking-wide hidden sm:inline">è€ƒç ”è¯æ±‡å¤§å¸ˆ</span></div>
                    </div>
                    <div className="flex space-x-1 items-center">
                        <button onClick={() => setView('home')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'home' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Brain" /></button>
                        <button onClick={() => setView('list')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'list' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="List" /></button>
                        <button onClick={() => setView('import')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'import' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Upload" /></button>
                        <button onClick={() => setView('settings')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'settings' ? 'bg-indigo-800 shadow-inner' : ''}`}><Icon name="Settings" /></button>
                    </div>
                </div>
            </nav>
        );

        const WordListMode = ({ words, setWords, setChatSession }) => {
            const [search, setSearch] = useState("");
            const [sortMode, setSortMode] = useState('default');
            const displayWords = useMemo(() => {
                let list = words.filter(w => w.word.toLowerCase().includes(search.toLowerCase()) || w.meanings.some(m => m.def.includes(search)));
                if (sortMode === 'alpha') list.sort((a, b) => a.word.localeCompare(b.word));
                else if (sortMode === 'reviews') list.sort((a, b) => (b.stats?.reviewCount || 0) - (a.stats?.reviewCount || 0));
                return list;
            }, [words, search, sortMode]);
            
            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50">
                    <div className="max-w-6xl mx-auto pb-20">
                        <div className="sticky top-0 bg-gray-50 pt-2 pb-4 z-40 flex gap-2">
                            <div className="relative flex-1">
                                <input type="text" placeholder="æœç´¢..." className="w-full pl-10 pr-4 py-3 rounded-xl shadow-sm border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500" value={search} onChange={e => setSearch(e.target.value)} />
                                <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="Search" /></div>
                            </div>
                            <button onClick={() => setSortMode(sortMode === 'default' ? 'alpha' : sortMode === 'alpha' ? 'reviews' : 'default')} className="px-3 bg-white border border-gray-200 rounded-xl shadow-sm text-gray-600"><Icon name="Sort" /></button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {displayWords.map((word) => (
                                <div key={word.id} className="bg-white rounded-xl shadow-sm p-5 border border-gray-100 flex flex-col group relative">
                                    <div className="flex justify-between items-center mb-3">
                                        <div><h3 className="text-lg font-bold text-gray-900">{word.word}</h3><span className="text-sm font-mono text-gray-500">{word.phonetic}</span></div>
                                        <button onClick={(e)=>{e.stopPropagation(); setChatSession(word.word);}} className="p-1.5 bg-indigo-50 text-indigo-500 rounded-full"><Icon name="MessageCircle" size={18}/></button>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {word.meanings.map((m, mIdx) => (
                                            <div key={mIdx} className="flex items-start text-sm text-gray-700"><span className="font-semibold mr-1 text-gray-500 text-xs uppercase">{m.pos}</span>{m.def}</div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ words, setView, setSessionConfig }) => {
            const stats = useMemo(() => {
                const counts = { high: 0, medium: 0, low: 0, zero: 0, uncategorized: 0, review: 0 };
                const now = Date.now();
                words.forEach(w => {
                    const cat = w.category || 'uncategorized';
                    if (['high', 'medium', 'low', 'zero'].includes(cat)) counts[cat]++; else counts[cat] = (counts[cat] || 0) + 1;
                    if (w.stats && w.stats.nextReview <= now && w.stats.interval !== 0) counts.review++;
                });
                return counts;
            }, [words]);
            const customCats = Object.keys(stats).filter(k => !['high', 'medium', 'low', 'zero', 'review', 'uncategorized'].includes(k));
            const Card = ({ title, count, color, onClick, icon }) => (
                <div onClick={onClick} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md relative overflow-hidden h-32 flex flex-col justify-between`}>
                    <div className={`absolute top-0 left-0 w-1.5 h-full ${color}`}></div>
                    <div className="flex justify-between items-start"><h3 className="font-bold text-gray-800 text-lg">{title}</h3><div className="text-gray-200">{icon || <Icon name="Book" size={28}/>}</div></div>
                    <div><span className="text-2xl font-bold text-gray-700">{count}</span><span className="text-xs text-gray-400 ml-1">è¯</span></div>
                </div>
            );

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 bg-gray-50">
                    <div className="max-w-5xl mx-auto space-y-8 pb-10">
                        <div onClick={() => { setSessionConfig({ type: 'review' }); setView('study'); }} className="w-full bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl text-white shadow-xl cursor-pointer flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
                            <div className="z-10"><h2 className="text-3xl font-bold mb-2">æ™ºèƒ½å¤ä¹ è®¡åˆ’</h2><p className="text-indigo-100 text-lg">ä»Šæ—¥å¾…å¤ä¹ : <span className="font-bold bg-white/20 px-2 rounded">{stats.review}</span> è¯</p></div>
                            <div className="mt-4 md:mt-0 bg-white/20 w-20 h-20 rounded-full flex items-center justify-center z-10 border border-white/30"><Icon name="Brain" size={40} className="text-white"/></div>
                            <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                        </div>
                        <div><h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="List" size={20} className="mr-2 text-indigo-600"/>æ ¸å¿ƒè€ƒé¢‘</h3><div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <Card title="é«˜é¢‘è¯" count={stats.high} color="bg-red-500" onClick={() => { setSessionConfig({ type: 'group_select', category: 'high' }); setView('group_list'); }} />
                            <Card title="ä¸­é¢‘è¯" count={stats.medium} color="bg-orange-500" onClick={() => { setSessionConfig({ type: 'group_select', category: 'medium' }); setView('group_list'); }} />
                            <Card title="ä½é¢‘è¯" count={stats.low} color="bg-yellow-500" onClick={() => { setSessionConfig({ type: 'group_select', category: 'low' }); setView('group_list'); }} />
                            <Card title="é›¶é¢‘è¯" count={stats.zero} color="bg-green-500" onClick={() => { setSessionConfig({ type: 'group_select', category: 'zero' }); setView('group_list'); }} />
                        </div></div>
                        {customCats.length > 0 && <div><h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="Folder" size={20} className="mr-2 text-indigo-600"/>æˆ‘çš„åˆ†ç»„</h3><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{customCats.map(cat => <Card key={cat} title={cat} count={stats[cat]} color="bg-blue-500" icon={<Icon name="Folder" size={28}/>} onClick={() => { setSessionConfig({ type: 'group_select', category: cat }); setView('group_list'); }} />)}</div></div>}
                    </div>
                </div>
            );
        };

        const GroupList = ({ words, category, setView, setSessionConfig, config }) => {
            const groups = useMemo(() => {
                const catWords = words.filter(w => (w.category || 'uncategorized') === category);
                const groupSize = config.groupSize || 208;
                const batches = {};
                catWords.forEach(w => { const bid = w.importId || 'default'; if(!batches[bid]) batches[bid]=[]; batches[bid].push(w); });
                const res = [];
                Object.keys(batches).forEach(bid => {
                    const bWords = batches[bid];
                    const count = Math.ceil(bWords.length / groupSize);
                    for(let i=0; i<count; i++) {
                        const groupWords = bWords.slice(i*groupSize, (i+1)*groupSize);
                        const mastered = groupWords.filter(w => w.stats && w.stats.interval > 0).length;
                        res.push({ batchId: bid, batchIndex: i, name: bid==='default'?'é»˜è®¤è¯åº“':`å¯¼å…¥æ‰¹æ¬¡ ${bid.split('-')[1]||''}`, total: groupWords.length, mastered, words: groupWords });
                    }
                });
                return res;
            }, [words, category]);

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50">
                    <div className="max-w-5xl mx-auto pb-20">
                        <div className="flex items-center mb-6"><h2 className="text-2xl font-bold text-gray-800 border-l-4 border-indigo-600 pl-3">{category} åˆ†ç»„</h2></div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {groups.map((g, idx) => (
                                <div key={idx} onClick={() => { setSessionConfig({ type: 'group_study', category, batchId: g.batchId, batchIndex: g.batchIndex }); setView('study'); }} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:border-indigo-300 hover:shadow-md transition">
                                    <h3 className="font-bold text-gray-800 text-lg">{g.name} - ç»„ {g.batchIndex + 1}</h3>
                                    <div className="mt-3"><div className="flex justify-between text-xs text-gray-500 mb-1"><span>è¿›åº¦</span><span>{Math.round((g.mastered/g.total)*100)}%</span></div><div className="w-full h-2 bg-gray-100 rounded-full"><div className="h-full bg-indigo-500" style={{width: `${(g.mastered/g.total)*100}%`}}></div></div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const StudySession = ({ words, setWords, sessionConfig, onExit, config, setChatSession }) => {
            const [queue, setQueue] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false); // å…¨å±çŠ¶æ€

            useEffect(() => {
                const now = Date.now();
                let q = [];
                if (sessionConfig.type === 'review') {
                    q = words.filter(w => w.stats && w.stats.nextReview <= now && w.stats.interval !== 0);
                    if(q.length === 0) q = words.filter(w => w.stats && w.stats.interval < 1 && w.stats.interval !== 0);
                    q = q.sort(() => Math.random() - 0.5).slice(0, 30);
                } else if (sessionConfig.type === 'group_study') {
                    const catWords = words.filter(w => (w.category || 'uncategorized') === sessionConfig.category);
                    const batchWords = catWords.filter(w => (w.importId || 'default') === sessionConfig.batchId);
                    const start = sessionConfig.batchIndex * (config.groupSize || 208);
                    q = batchWords.slice(start, start + (config.groupSize || 208));
                }
                setQueue(q);
            }, [sessionConfig]);

            useEffect(() => { if (queue.length > 0 && !isFinished && !isFlipped) { const timer = setTimeout(() => playAudio(queue[currentIdx].word), 300); return () => clearTimeout(timer); } }, [currentIdx, queue, isFinished]);

            // å…¨å±åˆ‡æ¢é€»è¾‘
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                    setIsFullscreen(true);
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    setIsFullscreen(false);
                }
            };

            if (queue.length === 0 && !isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6"><div className="bg-green-100 p-6 rounded-full mb-6 text-green-600"><Icon name="Check" size={48}/></div><h2 className="text-2xl font-bold mb-2">ä»»åŠ¡å®Œæˆ</h2><button onClick={onExit} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg mt-4">è¿”å›</button></div>;
            if (isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6"><div className="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600"><Icon name="Sparkles" size={48}/></div><h2 className="text-2xl font-bold mb-4">å­¦ä¹ ç»“æŸ ğŸ‰</h2><button onClick={onExit} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">è¿”å›</button></div>;

            const currentCard = queue[currentIdx];
            const handleRating = (rating) => {
                const res = calculateNextReview(rating, currentCard.stats?.interval||0, currentCard.stats?.easeFactor||2.5, currentCard.stats?.reviewCount||0);
                const newStats = { ...res, nextReview: Date.now() + (res.interval * 86400000) };
                const newWords = words.map(w => w.id === currentCard.id ? { ...w, stats: newStats } : w);
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                if (res.isDueNow) setQueue(prev => [...prev, { ...currentCard, stats: newStats }]);
                setIsFlipped(false); setTimeout(() => currentIdx + 1 >= queue.length ? setIsFinished(true) : setCurrentIdx(prev => prev + 1), 200);
            };

            return (
                <div className="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gray-200 z-10"><div className="h-full bg-indigo-600 transition-all duration-300" style={{width: `${(currentIdx / queue.length) * 100}%`}}></div></div>
                    
                    <button onClick={onExit} className="absolute top-4 left-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow text-gray-600"><Icon name="ArrowLeft" size={24}/></button>
                    {/* ä¿®å¤ï¼šå…¨å±æŒ‰é’®åŠ å›æ¥äº†ï¼æ”¾åœ¨ AI æŒ‰é’®å·¦ä¾§ */}
                    <button onClick={toggleFullscreen} className="absolute top-4 right-16 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow text-gray-600"><Icon name={isFullscreen ? "Minimize" : "Maximize"} size={24}/></button>
                    <button onClick={(e)=>{e.stopPropagation(); setChatSession(currentCard.word);}} className="absolute top-4 right-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow text-indigo-500"><Icon name="MessageCircle" size={24}/></button>

                    <div className="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden">
                        <div className="relative scene w-full max-w-sm md:max-w-3xl aspect-[3/4] md:aspect-[4/3] max-h-[85vh]">
                            <div className={`card-object ${isFlipped ? 'is-flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                                <div className="card-face flex flex-col items-center justify-center p-8 text-center bg-gradient-to-br from-white to-gray-50 border border-white">
                                    <h1 className="text-5xl md:text-7xl font-black text-gray-800 mb-6">{currentCard.word}</h1>
                                    <div className="flex items-center space-x-3 text-gray-500 bg-white border border-gray-200 shadow-sm px-5 py-2.5 rounded-full" onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}}><Icon name="Volume2" size={24}/><span className="font-mono text-xl">{currentCard.phonetic}</span></div>
                                    <div className="mt-auto text-gray-400 text-sm animate-pulse">ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰</div>
                                </div>
                                <div className="card-face card-face-back p-0 bg-white">
                                    <div className="flex-shrink-0 bg-white/95 backdrop-blur border-b border-gray-100 p-6 flex justify-between items-center z-10"><h2 className="text-3xl font-bold text-indigo-900">{currentCard.word}</h2><button onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}} className="p-2 bg-indigo-50 rounded-full text-indigo-600"><Icon name="Volume2" size={24}/></button></div>
                                    <div className="flex-1 overflow-y-auto custom-scroll p-6 space-y-4">
                                        {currentCard.meanings.map((m, idx) => (
                                            <div key={idx} className="p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                                <div className="flex justify-between mb-2"><span className="font-bold bg-indigo-50 text-indigo-600 px-2 rounded uppercase text-sm">{m.pos}</span></div>
                                                <div className="text-lg text-gray-800">{m.isMastered && !m._forceShow ? <span className="text-gray-400 cursor-pointer" onClick={(e)=>{e.stopPropagation(); const nw=[...words]; nw.find(w=>w.id===currentCard.id).meanings[idx]._forceShow=true; setWords(nw);}}>(å·²æŒæ¡ï¼Œç‚¹å‡»æŸ¥çœ‹)</span> : m.def}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex-shrink-0 absolute bottom-0 left-0 right-0 bg-white border-t p-4 flex space-x-4 z-20">
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(1);}} className="flex-1 bg-red-50 text-red-600 py-4 rounded-xl font-bold">ä¸è®¤è¯†</button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(2);}} className="flex-1 bg-yellow-50 text-yellow-600 py-4 rounded-xl font-bold">ä¸ç†Ÿ</button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(3);}} className="flex-1 bg-green-50 text-green-600 py-4 rounded-xl font-bold">è®¤è¯†</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ImportExport = ({ setWords, words, setView, config }) => {
            const [activeTab, setActiveTab] = useState('data');
            const handleFile = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const content = JSON.parse(ev.target.result);
                        if (confirm(`ç¡®å®šè¦å¯¼å…¥å¤‡ä»½å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼`)) {
                            if(content.storage) { Object.keys(content.storage).forEach(k => localStorage.setItem(k, content.storage[k])); window.location.reload(); }
                            else { setWords(content); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(content)); alert("å¯¼å…¥æˆåŠŸ"); }
                        }
                    } catch(err) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
                };
                reader.readAsText(file);
            };
            const exportData = () => {
                const storage = {};
                for(let i=0; i<localStorage.length; i++) { const key = localStorage.key(i); if(key.startsWith('kaoyan_')) storage[key] = localStorage.getItem(key); }
                const blob = new Blob([JSON.stringify({ type: 'BACKUP', storage }, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            };

            return (
                <div className="flex-1 overflow-y-auto bg-gray-50 p-6 flex justify-center">
                    <div className="w-full max-w-xl bg-white rounded-2xl shadow p-8 h-fit space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">æ•°æ®ç®¡ç†</h2>
                        <div className="p-6 bg-indigo-50 rounded-xl border border-indigo-100">
                            <h3 className="font-bold text-indigo-900 mb-2">æœ¬åœ°å¤‡ä»½ä¸æ¢å¤</h3>
                            <p className="text-sm text-indigo-700 mb-4">ç”Ÿæˆ .json æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œé‡è£…åº”ç”¨æ—¶å¯ç›´æ¥æ¢å¤ã€‚</p>
                            <div className="flex gap-4">
                                <button onClick={exportData} className="flex-1 py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm flex justify-center items-center"><Icon name="Download" className="mr-2"/>å¯¼å‡ºå¤‡ä»½</button>
                                <div className="relative flex-1">
                                    <button className="w-full h-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-sm flex justify-center items-center"><Icon name="Upload" className="mr-2"/>æ¢å¤å¤‡ä»½</button>
                                    <input type="file" onChange={handleFile} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                </div>
                            </div>
                        </div>
                        <div className="pt-4 text-center"><button onClick={()=>{if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) {localStorage.clear(); window.location.reload();}}} className="text-red-400 text-xs hover:text-red-600 underline">é‡ç½®åº”ç”¨</button></div>
                    </div>
                </div>
            );
        };

        const SettingsPanel = ({ config, setConfig, setView }) => {
            return (
                <div className="flex-1 overflow-y-auto bg-gray-50 p-6 flex justify-center">
                    <div className="w-full max-w-xl bg-white rounded-2xl shadow p-8 h-fit">
                        <h2 className="text-2xl font-bold mb-6">è®¾ç½®</h2>
                        <div className="mb-4">
                            <label className="block text-sm font-bold text-gray-700 mb-2">AI API Key</label>
                            <input value={config.apiKey} onChange={e => setConfig({...config, apiKey: e.target.value})} type="password" className="w-full border p-3 rounded-xl bg-gray-50"/>
                        </div>
                        <button onClick={()=>{ localStorage.setItem('kaoyan_config', JSON.stringify(config)); setView('home'); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">ä¿å­˜</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [words, setWords] = useState([]);
            const [sessionConfig, setSessionConfig] = useState({}); 
            const [config, setConfig] = useState({ type: 'openai', baseUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat', groupSize: 208 });
            const [chatSession, setChatSession] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('kaoyan_vocab_list');
                const savedCfg = localStorage.getItem('kaoyan_config');
                if (saved) setWords(JSON.parse(saved));
                if (savedCfg) setConfig(JSON.parse(savedCfg));
                document.getElementById('root').querySelector('div')?.remove();
            }, []);

            const handleBack = () => { if(view==='study') setView(sessionConfig.type==='group_study'?'group_list':'home'); else setView('home'); };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <Navbar view={view} setView={setView} />
                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        {view === 'home' && <Dashboard words={words} setView={setView} setSessionConfig={setSessionConfig} />}
                        {view === 'group_list' && <GroupList words={words} setWords={setWords} category={sessionConfig.category} setView={setView} setSessionConfig={setSessionConfig} config={config} />}
                        {view === 'study' && <StudySession words={words} setWords={setWords} sessionConfig={sessionConfig} onExit={handleBack} config={config} setChatSession={setChatSession} />}
                        {view === 'list' && <WordListMode words={words} setWords={setWords} setChatSession={setChatSession} />}
                        {view === 'import' && <ImportExport setWords={setWords} words={words} setView={setView} config={config} />}
                        {view === 'settings' && <SettingsPanel config={config} setConfig={setConfig} setView={setView} />}
                        {chatSession && (<div className="absolute inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in"><WordChat word={chatSession} onClose={() => setChatSession(null)} config={config} /></div>)}
                    </main>
                    <style>{`.animate-fade-in { animation: fade-in 0.2s ease-out; } @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }`}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
