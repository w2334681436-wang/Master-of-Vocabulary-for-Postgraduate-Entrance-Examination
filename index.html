<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€ƒç ”è¯æ±‡å¤§å¸ˆ</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        .scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        @media (min-width: 768px) { .card-face { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } }
        .card-face-back { transform: rotateY(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Markdown æ ·å¼ä¼˜åŒ– */
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body strong { color: inherit; font-weight: 700; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body code { background-color: rgba(0,0,0,0.05); padding: 0.1em 0.3em; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">èµ„æºåŠ è½½ä¸­...</p>
        </div>
        <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
    </div>

    <script>
        // é”™è¯¯æ•è·ï¼Œé˜²æ­¢ç™½å±
        window.onerror = function(msg, url, line, col, error) {
            var root = document.getElementById('root');
            root.innerHTML = '<div style="padding:20px;text-align:center;color:red;"><h3>å‘ç”Ÿé”™è¯¯</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Icons ---
        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Maximize: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
            Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            FolderInput: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2Z"/><path d="m10 13 2 2 4-4"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            MessageCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Palette: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const Svg = Icons[name] || Icons.Book;
            return <span className={`inline-block ${className}`} style={{ width: size, height: size }}><Svg /></span>;
        };

        const API_PRESETS = {
            "deepseek": { name: "DeepSeek (æ·±åº¦æ±‚ç´¢)", type: "openai", url: "https://api.deepseek.com" },
            "siliconflow": { name: "SiliconFlow (ç¡…åŸºæµåŠ¨)", type: "openai", url: "https://api.siliconflow.cn/v1" },
            "openai": { name: "OpenAI (å®˜æ–¹)", type: "openai", url: "https://api.openai.com/v1" },
            "moonshot": { name: "Moonshot (Kimi)", type: "openai", url: "https://api.moonshot.cn/v1" },
            "zhipu": { name: "æ™ºè°±AI (GLM)", type: "openai", url: "https://open.bigmodel.cn/api/paas/v4" },
            "aliyun": { name: "é˜¿é‡Œäº‘ (é€šä¹‰åƒé—®)", type: "openai", url: "https://dashscope.aliyuncs.com/compatible-mode/v1" },
            "yi": { name: "é›¶ä¸€ä¸‡ç‰© (Yi)", type: "openai", url: "https://api.lingyiwanwu.com/v1" },
            "google": { name: "Google (Gemini)", type: "google", url: "" },
            "custom": { name: "è‡ªå®šä¹‰ (OpenAIå…¼å®¹)", type: "openai", url: "" }
        };

       const playAudio = (text) => {
            // å¦‚æœæ–‡æœ¬åŒ…å«ç©ºæ ¼ä¸”é•¿åº¦å¤§äº30ï¼Œæˆ–è€…åŒ…å«æ ‡ç‚¹ï¼Œè§†ä¸ºå¥å­ï¼Œä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯­éŸ³
            if (text.includes(' ') || text.length > 20) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US'; // ç¾å¼å‘éŸ³
                    u.rate = 0.9; // è¯­é€Ÿç¨æ…¢ä¸€ç‚¹ç‚¹ï¼Œé€‚åˆç»ƒä¹ 
                    window.speechSynthesis.speak(u);
                }
            } else {
                // å•ä¸ªå•è¯ç»§ç»­ç”¨æœ‰é“æ¥å£ï¼Œå‘éŸ³æ›´è‡ªç„¶
                const audio = new Audio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`);
                audio.play().catch(e => {
                    // é™çº§å¤„ç†
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                });
            }
        };

        const calculateNextReview = (rating, currentInterval, easeFactor, currentReviewCount) => {
            let nextInterval, nextEaseFactor = easeFactor;
            const newReviewCount = (currentReviewCount || 0) + 1;
            if (rating === 1) { 
                return { interval: 0, easeFactor: Math.max(1.3, easeFactor - 0.2), isDueNow: true, reviewCount: newReviewCount };
            } else if (rating === 2) { 
                return { interval: 0.5, easeFactor: Math.max(1.3, easeFactor - 0.15), isDueNow: true, reviewCount: newReviewCount }; 
            } else { 
                if (currentInterval === 0) nextInterval = 1; 
                else if (currentInterval === 1) nextInterval = 3;
                else nextInterval = Math.round(currentInterval * easeFactor);
                return { interval: nextInterval, easeFactor: easeFactor + 0.1, isDueNow: false, reviewCount: newReviewCount };
            }
        };

        // --- Word Chat Component (AI è€å¸ˆ) ---
    // --- Word Chat Component (AI è€å¸ˆ) ---
        const WordChat = ({ word, onClose, config }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [thinkMode, setThinkMode] = useState("fast"); // fast, deep, or oral
            const [bubbleColor, setBubbleColor] = useState("bg-indigo-600");
            const [showColorPicker, setShowColorPicker] = useState(false);
            const messagesEndRef = useRef(null);

            const colors = [
                { name: "Indigo", class: "bg-indigo-600" },
                { name: "Pink", class: "bg-pink-500" },
                { name: "Green", class: "bg-emerald-500" },
                { name: "Blue", class: "bg-blue-500" },
                { name: "Orange", class: "bg-orange-500" },
                { name: "Black", class: "bg-gray-800" }
            ];

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => { scrollToBottom(); }, [messages]);

            // åˆå§‹é—®å€™
            useEffect(() => {
                const initialMsg = {
                    role: "assistant",
                    content: `Hi! æˆ‘æ˜¯ä½ çš„ä¸“å± AI ç§æ•™ã€‚\næˆ‘ä»¬ä»Šå¤©è¦æ­»ç£•çš„å•è¯æ˜¯ï¼š **${word}**ã€‚\n\nä½ å¯ä»¥åˆ‡æ¢ä¸Šæ–¹æ¨¡å¼ï¼š\nâš¡ **å¿«é€Ÿ**ï¼šç®€å•é€šä¿—è®²è§£\nğŸ“– **æ·±åº¦**ï¼šè€ƒç ”çœŸé¢˜è€ƒæ³•\nğŸ‘„ **å£è¯­**ï¼šçº¯è‹±å¯¹è¯ç»ƒå¬åŠ›`
                };
                setMessages([initialMsg]);
                // é»˜è®¤è§¦å‘å¿«é€Ÿè®²è§£
                handleSend(null, `è¯·ç”¨é€šä¿—æ˜“æ‡‚ã€ç”Ÿæ´»åŒ–çš„åœºæ™¯ï¼ˆåƒè®²æ•…äº‹ä¸€æ ·ï¼‰è®²è§£å•è¯ "${word}"ã€‚æ‹†åˆ†ä¸ºï¼š1.ä½œä¸ºåè¯/åŠ¨è¯çš„æ ¸å¿ƒå«ä¹‰ï¼›2.ç»™å‡ºä¸€ä¸ªå®¹æ˜“è®°ä½çš„åœºæ™¯ä¾‹å­ï¼›3.æ€»ç»“è®°å¿†ç‚¹ã€‚ä½¿ç”¨ Markdown æ ¼å¼ï¼Œé‡ç‚¹åŠ ç²—ã€‚`);
            }, []);

            const handleSend = async (e, manualContent) => {
                if (e) e.preventDefault();
                const content = manualContent || input.trim();
                if (!content || isLoading) return;

                if (!manualContent) {
                    setMessages(prev => [...prev, { role: "user", content }]);
                    setInput("");
                }
                setIsLoading(true);

                // ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯
                let systemPrompt = "";
                if (thinkMode === 'oral') {
                    systemPrompt = "You are a friendly American English tutor. Speak ONLY in English. Keep your sentences simple, clear, and encouraging. Correct the user's grammar gently if needed. Engage in a conversation using the target word.";
                } else if (thinkMode === 'deep') {
                    systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸¥è‚ƒçš„è€ƒç ”è‹±è¯­å‘½é¢˜ç»„ä¸“å®¶ã€‚è¯·ä»è¯æºè¯æ ¹ã€ç†Ÿè¯åƒ»ä¹‰ã€å†å¹´çœŸé¢˜è€ƒæ³•ã€æ˜“æ··è¯è¾¨æè¿™å››ä¸ªç»´åº¦è¿›è¡Œæ·±åº¦è§£æã€‚å¿…é¡»ä½¿ç”¨ Markdown æ ¼å¼ï¼Œå…³é”®ç‚¹åŠ ç²—ã€‚";
                } else {
                    // è¿™æ˜¯ä½ æœ€å–œæ¬¢çš„æ¨¡å¼
                    systemPrompt = "ä½ æ˜¯ä¸€ä½éå¸¸æ“…é•¿ç±»æ¯”çš„è‹±è¯­ç§æ•™ã€‚è¯·ç”¨æœ€é€šä¿—ã€ç”Ÿæ´»åŒ–ã€ç”šè‡³æœ‰ç‚¹å¹½é»˜çš„è¯­è¨€è§£é‡Šå•è¯ã€‚æ ¸å¿ƒç­–ç•¥ï¼š1.æŠŠæŠ½è±¡æ¦‚å¿µå…·è±¡åŒ–ï¼ˆæ¯”å¦‚æŠŠ representative æ¯”ä½œâ€œæ›¿èº«â€ï¼‰ã€‚2.å¤šç”¨ç”Ÿæ´»åœºæ™¯ä¸²è”ä¸åŒè¯æ€§ã€‚3.æœ€åç»™ä¸€å¥â€œç®€å•è®°â€å£è¯€ã€‚ä½¿ç”¨ Markdown æ ¼å¼ã€‚";
                }

                try {
                    const apiMessages = [
                        { role: "system", content: systemPrompt },
                        ...messages.filter(m => m.role !== 'error' && m.content !== '...'),
                        { role: "user", content }
                    ];

                    setMessages(prev => [...prev, { role: "assistant", content: "..." }]);

                    let baseUrl = config.baseUrl.replace(/\/$/, "");
                    if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel")) baseUrl += "/v1";

                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: apiMessages,
                            stream: true
                        })
                    });

                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");
                        
                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    fullText += delta;
                                    
                                    setMessages(prev => {
                                        const newMsgs = [...prev];
                                        newMsgs[newMsgs.length - 1] = { role: "assistant", content: fullText };
                                        return newMsgs;
                                    });
                                } catch (e) { }
                            }
                        }
                    }
                } catch (error) {
                    setMessages(prev => [...prev, { role: "error", content: "å‡ºé”™äº†: " + error.message }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[60] flex flex-col bg-white md:max-w-md md:mx-auto md:my-4 md:rounded-2xl md:shadow-2xl md:border md:border-gray-200 overflow-hidden animate-slide-up">
                    {/* Header */}
                    <div className="flex justify-between items-center p-4 border-b bg-white z-10 shadow-sm">
                        <div className="flex flex-col">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center">{word} <span className="ml-2 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded">AI ç§æ•™</span></h3>
                            {/* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */}
                            <div className="flex gap-2 mt-2">
                                <button onClick={() => setThinkMode('fast')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='fast' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>âš¡ å¿«é€Ÿç†è§£</button>
                                <button onClick={() => setThinkMode('deep')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='deep' ? 'bg-indigo-50 text-indigo-600 border-indigo-200 font-bold' : 'text-gray-500 border-transparent'}`}>ğŸ“– æ·±åº¦è€ƒç ”</button>
                                <button onClick={() => setThinkMode('oral')} className={`px-2 py-1 text-xs rounded-lg transition border ${thinkMode==='oral' ? 'bg-orange-50 text-orange-600 border-orange-200 font-bold' : 'text-gray-500 border-transparent'}`}>ğŸ‘„ å£è¯­å¯¹ç»ƒ</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={()=>setShowColorPicker(!showColorPicker)} className="p-2 rounded-full hover:bg-gray-100 text-gray-400 relative"><Icon name="Palette" size={20}/></button>
                            {showColorPicker && (
                                <div className="absolute right-14 top-16 bg-white shadow-xl border rounded-lg p-2 grid grid-cols-3 gap-2 w-32 z-50">
                                    {colors.map(c => (<div key={c.name} onClick={()=>setBubbleColor(c.class)} className={`w-6 h-6 rounded-full cursor-pointer border border-gray-100 ${c.class}`}></div>))}
                                </div>
                            )}
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 text-gray-400"><Icon name="X" size={24}/></button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-5 bg-gray-50 custom-scroll" onClick={()=>setShowColorPicker(false)}>
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`flex flex-col max-w-[90%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div className={`p-3.5 rounded-2xl text-sm md:text-base leading-relaxed shadow-sm relative group ${
                                        msg.role === 'user' 
                                        ? 'bg-white text-gray-800 border border-gray-100 rounded-tr-none' 
                                        : `${bubbleColor} text-white rounded-tl-none markdown-body`
                                    } ${msg.role === 'error' ? 'bg-red-50 text-red-600 border-red-200' : ''}`}>
                                        {msg.role === 'assistant' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}
                                        
                                        {/* æ’­æ”¾æŒ‰é’®ï¼šåªåœ¨ AI æ¶ˆæ¯ä¸”ä¸æ˜¯åŠ è½½ä¸­æ˜¾ç¤º */}
                                        {msg.role === 'assistant' && msg.content !== '...' && (
                                            <button 
                                                onClick={(e) => {e.stopPropagation(); playAudio(msg.content.replace(/[\*\#]/g, ''));}} 
                                                className="absolute -right-8 bottom-0 p-1.5 text-gray-400 hover:text-indigo-600 bg-white/50 rounded-full hover:bg-white transition shadow-sm"
                                                title="æ’­æ”¾è¯­éŸ³"
                                            >
                                                <Icon name="Volume2" size={16}/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="p-3 bg-white border-t flex items-end gap-2 safe-bottom">
                        <textarea 
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}}
                            placeholder={thinkMode === 'oral' ? "Reply in English..." : "ç»§ç»­è¿½é—®ï¼Œæ¯”å¦‚ï¼šç»™ä¸ªä¾‹å¥..."}
                            className="flex-1 max-h-32 p-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-100 outline-none resize-none text-sm"
                            rows="1"
                        ></textarea>
                        <button onClick={(e)=>handleSend(e)} disabled={isLoading || !input.trim()} className={`p-3 rounded-xl text-white shadow-md transition-all ${isLoading || !input.trim() ? 'bg-gray-300' : bubbleColor} active:scale-95`}>
                            {isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icon name="Send" size={20} />}
                        </button>
                    </div>
                </div>
            );
        };
        // --- Components ---

        const Navbar = ({ view, setView, goBack }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);
            const toggleFullScreen = () => {
                if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(console.log); setIsFullscreen(true); }
                else { if (document.exitFullscreen) { document.exitFullscreen(); setIsFullscreen(false); } }
            };
            useEffect(() => {
                const handleChange = () => setIsFullscreen(!!document.fullscreenElement);
                document.addEventListener('fullscreenchange', handleChange);
                return () => document.removeEventListener('fullscreenchange', handleChange);
            }, []);
            const showBack = view.startsWith('group_list') || view === 'study';
            
            return (
                <nav className="bg-indigo-600 text-white shadow-md sticky top-0 z-50 safe-top transition-all duration-300 flex-shrink-0">
                    <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div className="flex items-center space-x-3 font-bold text-lg cursor-pointer hover:opacity-90 transition" onClick={() => setView('home')}>
                            {showBack ? <button onClick={(e) => {e.stopPropagation(); goBack();}} className="p-1.5 hover:bg-indigo-500 rounded-full transition"><Icon name="ArrowLeft" size={24}/></button> : <Icon name="Book" size={24}/>}
                            <span className="tracking-wide">è€ƒç ”è¯æ±‡å¤§å¸ˆ</span>
                        </div>
                        <div className="flex space-x-1 sm:space-x-2 items-center">
                            <button onClick={toggleFullScreen} className="p-2 rounded-full hover:bg-indigo-500 transition hidden sm:block" title="å…¨å±">
                                {isFullscreen ? <Icon name="Minimize" /> : <Icon name="Maximize" />}
                            </button>
                            <div className="h-6 w-px bg-indigo-400 mx-2 hidden sm:block"></div>
                            <button onClick={() => setView('home')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'home' ? 'bg-indigo-800 shadow-inner' : ''}`} title="é¦–é¡µ"><Icon name="Brain" /></button>
                            <button onClick={() => setView('list')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'list' ? 'bg-indigo-800 shadow-inner' : ''}`} title="åˆ—è¡¨"><Icon name="List" /></button>
                            <button onClick={() => setView('import')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'import' ? 'bg-indigo-800 shadow-inner' : ''}`} title="å¯¼å…¥"><Icon name="Upload" /></button>
                            <button onClick={() => setView('settings')} className={`p-2 rounded-lg hover:bg-indigo-500 transition ${view === 'settings' ? 'bg-indigo-800 shadow-inner' : ''}`} title="è®¾ç½®"><Icon name="Settings" /></button>
                        </div>
                    </div>
                </nav>
            );
        };

      const WordListMode = ({ words, setWords, setChatSession }) => {
            const [search, setSearch] = useState("");
            const [sortMode, setSortMode] = useState('default');
            const [sortDesc, setSortDesc] = useState(false);
            const [showSortMenu, setShowSortMenu] = useState(false);
            const displayWords = useMemo(() => {
                let list = words.filter(w => w.word.toLowerCase().includes(search.toLowerCase()) || w.meanings.some(m => m.def.includes(search)));
                list.sort((a, b) => {
                    if (sortMode === 'alpha') return a.word.localeCompare(b.word);
                    else if (sortMode === 'reviews') return (a.stats?.reviewCount || 0) - (b.stats?.reviewCount || 0);
                    return 0;
                });
                if (sortDesc) list.reverse();
                return list;
            }, [words, search, sortMode, sortDesc]);
            const toggleSort = (mode) => { if (sortMode === mode) setSortDesc(!sortDesc); else { setSortMode(mode); setSortDesc(mode === 'reviews'); } setShowSortMenu(false); };
            const toggleMastery = (wordId, meaningIndex) => { const newWords = [...words]; const idx = newWords.findIndex(w => w.id === wordId); if (idx !== -1) { newWords[idx].meanings[meaningIndex].isMastered = !newWords[idx].meanings[meaningIndex].isMastered; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            
            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50">
                    <div className="max-w-6xl mx-auto pb-20">
                        <div className="sticky top-0 bg-gray-50 pt-2 pb-4 z-40 space-y-2 md:flex md:space-y-0 md:space-x-4 md:items-center">
                            <div className="relative flex-1">
                                <input type="text" placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰..." className="w-full pl-10 pr-4 py-3 rounded-xl shadow-sm border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition" value={search} onChange={e => setSearch(e.target.value)} />
                                <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="Search" /></div>
                            </div>
                            <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm border border-gray-200 text-sm relative md:w-auto">
                                <span className="text-gray-500 ml-2 whitespace-nowrap font-medium">å…± {displayWords.length} è¯</span>
                                <button onClick={() => setShowSortMenu(!showSortMenu)} className="ml-4 flex items-center space-x-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-medium whitespace-nowrap transition"><Icon name="Sort" size={16} /><span>æ’åº</span></button>
                                {showSortMenu && (<div className="absolute right-0 top-full mt-2 w-40 bg-white rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden ring-1 ring-black/5"><button onClick={() => toggleSort('default')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">é»˜è®¤</button><button onClick={() => toggleSort('alpha')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">å­—æ¯ A-Z</button><button onClick={() => toggleSort('reviews')} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition text-gray-700">å¤ä¹ æ¬¡æ•°</button></div>)}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {displayWords.map((word) => (
                                <div key={word.id} className="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition duration-200 border border-gray-100 hover:border-indigo-100 flex flex-col h-full relative group">
                                    {/* ä¿®å¤ç‚¹ï¼šè¿™é‡ŒæŠŠ items-baseline æ”¹ä¸ºäº† items-center */}
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-baseline space-x-2 overflow-hidden">
                                            <h3 className="text-lg font-bold text-gray-900 truncate">{word.word}</h3>
                                            <span className="text-sm font-mono text-gray-500 truncate">{word.phonetic}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {/* AI æŒ‰é’® */}
                                            <button onClick={(e)=>{e.stopPropagation(); setChatSession(word.word);}} className="p-1.5 bg-indigo-50 text-indigo-500 hover:text-white hover:bg-indigo-500 rounded-full transition shadow-sm" title="AI è¯¦è§£"><Icon name="MessageCircle" size={18}/></button>
                                            <div className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap font-medium">å¤ä¹  {word.stats?.reviewCount || 0}</div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {word.meanings.map((m, mIdx) => (
                                            <div key={mIdx} className="flex items-start group cursor-pointer p-1 -ml-1 rounded hover:bg-gray-50 transition" onClick={() => toggleMastery(word.id, mIdx)}>
                                                <div className={`mt-0.5 mr-2 flex-shrink-0 transition-colors ${m.isMastered ? 'text-green-500' : 'text-gray-300 group-hover:text-gray-400'}`}><Icon name="Check" size={16} /></div>
                                                <div className={`text-sm leading-snug break-words ${m.isMastered ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                                    <span className="font-semibold mr-1 text-gray-500 text-xs uppercase">{m.pos}</span>{m.def}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ words, setView, setSessionConfig }) => {
            const stats = useMemo(() => {
                const counts = { high: 0, medium: 0, low: 0, zero: 0, uncategorized: 0, review: 0 };
                const now = Date.now();
                words.forEach(w => {
                    const cat = w.category || 'uncategorized';
                    if (['high', 'medium', 'low', 'zero'].includes(cat)) counts[cat]++; else if (!counts[cat]) counts[cat] = 1; else counts[cat]++;
                    if (w.stats && w.stats.nextReview <= now && w.stats.interval !== 0) counts.review++;
                });
                return counts;
            }, [words]);
            const standardCats = ['high', 'medium', 'low', 'zero'];
            const customCats = Object.keys(stats).filter(k => !standardCats.includes(k) && k !== 'review' && k !== 'uncategorized');
            const openCategory = (category) => { setSessionConfig({ type: 'group_select', category }); setView('group_list'); };
            const startReview = () => { setSessionConfig({ type: 'review' }); setView('study'); };
            const Card = ({ title, count, color, onClick, isCustom }) => (
                <div onClick={onClick} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer transform transition hover:scale-[1.02] hover:shadow-md active:scale-95 relative overflow-hidden group h-32 flex flex-col justify-between`}>
                    <div className={`absolute top-0 left-0 w-1.5 h-full ${color} transition-all group-hover:w-2`}></div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-gray-800 text-lg truncate pl-2">{title}</h3>
                        <div className={`text-gray-200 group-hover:text-indigo-100 transition-colors ${isCustom ? 'opacity-70' : ''}`}>{isCustom ? <Icon name="Folder" size={28}/> : <Icon name="Book" size={28}/>}</div>
                    </div>
                    <div className="pl-2">
                        <span className="text-2xl font-bold text-gray-700">{count}</span>
                        <span className="text-xs text-gray-400 ml-1">è¯</span>
                    </div>
                </div>
            );
            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 bg-gray-50">
                    <div className="max-w-5xl mx-auto space-y-8 pb-10">
                        <div onClick={startReview} className="w-full bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl text-white shadow-xl shadow-indigo-200 cursor-pointer transform transition hover:-translate-y-1 hover:shadow-2xl active:scale-[0.99] relative overflow-hidden flex flex-col md:flex-row justify-between items-center group">
                            <div className="z-10 relative text-center md:text-left">
                                <h2 className="text-3xl font-bold mb-2 tracking-tight">æ™ºèƒ½å¤ä¹ è®¡åˆ’</h2>
                                <p className="text-indigo-100 text-lg opacity-90">ä»Šæ—¥å¾…å¤ä¹ : <span className="font-bold text-white bg-white/20 px-3 py-0.5 rounded-lg ml-1">{stats.review}</span> ä¸ªå•è¯</p>
                            </div>
                            <div className="mt-4 md:mt-0 bg-white/20 w-20 h-20 rounded-full flex items-center justify-center z-10 relative group-hover:scale-110 transition duration-300 backdrop-blur-sm border border-white/30">
                                <Icon name="Brain" size={40} className="text-white"/>
                            </div>
                            <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                            <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-indigo-900/20 rounded-full blur-2xl"></div>
                            {stats.review > 0 && <div className="absolute top-6 right-6 w-3 h-3 bg-red-400 rounded-full animate-ping"></div>}
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="List" size={20} className="mr-2 text-indigo-600"/>æ ¸å¿ƒè€ƒé¢‘</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                                <Card title="é«˜é¢‘è¯" count={stats.high || 0} color="bg-red-500" onClick={() => openCategory('high')} />
                                <Card title="ä¸­é¢‘è¯" count={stats.medium || 0} color="bg-orange-500" onClick={() => openCategory('medium')} />
                                <Card title="ä½é¢‘è¯" count={stats.low || 0} color="bg-yellow-500" onClick={() => openCategory('low')} />
                                <Card title="é›¶é¢‘è¯" count={stats.zero || 0} color="bg-green-500" onClick={() => openCategory('zero')} />
                                {stats.uncategorized > 0 && <Card title="æœªåˆ†ç±»" count={stats.uncategorized} color="bg-gray-400" onClick={() => openCategory('uncategorized')} />}
                            </div>
                        </div>

                        {customCats.length > 0 && (
                            <div>
                                <h3 className="font-bold text-gray-800 px-1 flex items-center text-lg mb-4"><Icon name="Folder" size={20} className="mr-2 text-indigo-600"/>æˆ‘çš„åˆ†ç»„</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 lg:gap-6">
                                    {customCats.map(cat => (<Card key={cat} title={cat} count={stats[cat]} color="bg-blue-500" onClick={() => openCategory(cat)} isCustom={true} />))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const GroupList = ({ words, setWords, category, setView, setSessionConfig, config }) => {
            const [moveModal, setMoveModal] = useState({ open: false, targetGroupWords: [] });
            const [editModal, setEditModal] = useState({ open: false, batchId: '', currentName: '', currentDesc: '' });
            const [customTarget, setCustomTarget] = useState('');
            const [groupMeta, setGroupMeta] = useState({});

            useEffect(() => {
                try {
                    const savedMeta = localStorage.getItem('kaoyan_group_meta');
                    if (savedMeta) setGroupMeta(JSON.parse(savedMeta));
                } catch (e) { console.error("åŠ è½½åˆ†ç»„ä¿¡æ¯å¤±è´¥", e); }
            }, []);

            const groups = useMemo(() => {
                const catWords = words.filter(w => (w.category || 'uncategorized') === category);
                const groupSize = config.groupSize || 208;
                const batches = {};
                catWords.forEach(w => { const batchId = w.importId || 'default'; if (!batches[batchId]) batches[batchId] = []; batches[batchId].push(w); });
                const result = [];
                const batchKeys = Object.keys(batches).sort((a, b) => { if (a === 'default') return -1; if (b === 'default') return 1; return parseInt(b.split('-')[1] || 0) - parseInt(a.split('-')[1] || 0); });
                let globalIndex = 1;
                batchKeys.forEach(batchId => {
                    const batchWords = batches[batchId]; const count = Math.ceil(batchWords.length / groupSize);
                    for(let i=0; i<count; i++) {
                        const start = i * groupSize; const end = Math.min((i+1) * groupSize, batchWords.length);
                        const groupWords = batchWords.slice(start, end);
                        const mastered = groupWords.filter(w => w.stats && w.stats.interval > 0).length;
                        
                        const meta = groupMeta[batchId] || {};
                        let batchName = meta.name;
                        
                        if (!batchName) {
                            if (batchId !== 'default') { 
                                const ts = parseInt(batchId.split('-')[1]); 
                                if (!isNaN(ts)) { 
                                    const date = new Date(ts); 
                                    batchName = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} å¯¼å…¥`; 
                                } else { 
                                    batchName = "æ–°æ‰¹æ¬¡"; 
                                } 
                            } else {
                                batchName = "é»˜è®¤è¯åº“";
                            }
                        }

                        result.push({ 
                            index: globalIndex++, 
                            batchId, 
                            batchIndex: i, 
                            batchName, 
                            desc: meta.desc || "", 
                            start: start + 1, 
                            end, 
                            total: groupWords.length, 
                            mastered, 
                            words: groupWords 
                        });
                    }
                });
                return result;
            }, [words, category, config.groupSize, groupMeta]);

            const displayTitle = ({ high: "é«˜é¢‘è¯", medium: "ä¸­é¢‘è¯", low: "ä½é¢‘è¯", zero: "é›¶é¢‘è¯", uncategorized: "æœªåˆ†ç±»" })[category] || category;
            const startGroup = (batchId, batchIndex) => { setSessionConfig({ type: 'group_study', category, batchId, batchIndex }); setView('study'); };
            
            const handleDeleteGroup = (e, groupWords) => {
                e.stopPropagation();
                if(confirm(`ç¡®å®šè¦åˆ é™¤è¯¥ç»„çš„ ${groupWords.length} ä¸ªå•è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                    const idsToDelete = groupWords.map(w => w.id);
                    const newWords = words.filter(w => !idsToDelete.includes(w.id));
                    setWords(newWords);
                    localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                }
            };

            const openMoveModal = (e, groupWords) => {
                e.stopPropagation();
                setMoveModal({ open: true, targetGroupWords: groupWords });
                setCustomTarget('');
            };

            const performMove = (targetCat) => {
                if(!targetCat) return;
                const idsToMove = moveModal.targetGroupWords.map(w => w.id);
                const newWords = words.map(w => idsToMove.includes(w.id) ? { ...w, category: targetCat } : w);
                setWords(newWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords));
                setMoveModal({ open: false, targetGroupWords: [] });
                alert("è½¬ç§»æˆåŠŸï¼");
            };

            const openEditModal = (e, batchId, currentName, currentDesc) => {
                e.stopPropagation();
                const isDefaultName = currentName.includes("å¯¼å…¥") || currentName === "é»˜è®¤è¯åº“" || currentName === "æ–°æ‰¹æ¬¡";
                setEditModal({ 
                    open: true, 
                    batchId, 
                    currentName: isDefaultName ? '' : currentName, 
                    currentDesc: currentDesc || ''
                });
            };

            const saveGroupInfo = () => {
                const newMeta = { 
                    ...groupMeta, 
                    [editModal.batchId]: { 
                        name: editModal.currentName.trim(), 
                        desc: editModal.currentDesc.trim() 
                    } 
                };
                setGroupMeta(newMeta);
                localStorage.setItem('kaoyan_group_meta', JSON.stringify(newMeta));
                setEditModal({ open: false, batchId: '', currentName: '', currentDesc: '' });
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50 relative">
                    <div className="max-w-5xl mx-auto pb-20">
                        <div className="flex items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800 truncate border-l-4 border-indigo-600 pl-3">{displayTitle}</h2>
                            <span className="ml-3 text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded-md">åˆ†ç»„ç®¡ç†</span>
                        </div>
                        {groups.length === 0 ? 
                            <div className="flex flex-col items-center justify-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100">
                                <div className="text-gray-300 mb-4"><Icon name="Book" size={48}/></div>
                                <div className="text-gray-500">è¯¥åˆ†ç±»ä¸‹æš‚æ— å•è¯</div>
                            </div> 
                        : 
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {groups.map(g => (
                                <div key={g.index} onClick={() => startGroup(g.batchId, g.batchIndex)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:border-indigo-300 hover:shadow-md transition duration-200 flex flex-col group relative overflow-hidden min-h-[160px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex-1 pr-2">
                                            <h3 className="font-bold text-gray-800 text-lg line-clamp-1" title={g.batchName}>{g.batchName}</h3>
                                            <div className="flex items-center mt-1 space-x-2">
                                                 <span className="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded border border-gray-200">Group {g.index}</span>
                                            </div>
                                        </div>
                                        <div className="flex space-x-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                            <button onClick={(e) => openEditModal(e, g.batchId, g.batchName, g.desc)} className="p-1.5 bg-gray-50 text-gray-600 rounded hover:bg-indigo-50 hover:text-indigo-600 transition" title="ç¼–è¾‘ä¿¡æ¯"><Icon name="Edit" size={16}/></button>
                                            <button onClick={(e) => openMoveModal(e, g.words)} className="p-1.5 bg-blue-50 text-blue-500 rounded hover:bg-blue-100 transition" title="è½¬ç§»åˆ†ç»„"><Icon name="Move" size={16}/></button>
                                            <button onClick={(e) => handleDeleteGroup(e, g.words)} className="p-1.5 bg-red-50 text-red-500 rounded hover:bg-red-100 transition" title="åˆ é™¤åˆ†ç»„"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-3 flex-1">
                                        {g.desc ? (
                                            <p className="text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100 line-clamp-2">{g.desc}</p>
                                        ) : (
                                            <p className="text-xs text-gray-300 italic py-2">æš‚æ— å¤‡æ³¨...</p>
                                        )}
                                    </div>

                                    <div className="mt-auto">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>è¿›åº¦</span>
                                            <span className="font-medium">{Math.round((g.mastered/g.total)*100)}%</span>
                                        </div>
                                        <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${(g.mastered/g.total)*100}%`}}></div>
                                        </div>
                                        <p className="text-xs text-gray-400 mt-2 text-right">{g.mastered} / {g.total} è¯</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        }
                    </div>

                    {moveModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setMoveModal({open:false, targetGroupWords:[]})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">è½¬ç§»è¯¥ç»„å•è¯åˆ°...</h3>
                                <div className="grid grid-cols-2 gap-3 mb-4">
                                    {['high', 'medium', 'low', 'zero'].map(cat => (
                                        <button key={cat} onClick={() => performMove(cat)} className="py-3 bg-gray-50 hover:bg-indigo-50 border border-gray-200 hover:border-indigo-200 rounded-xl font-bold text-gray-700 hover:text-indigo-700 transition uppercase">{cat}</button>
                                    ))}
                                </div>
                                <div className="border-t border-gray-100 pt-4 mt-2">
                                    <label className="text-xs font-bold text-gray-400 uppercase mb-2 block">è‡ªå®šä¹‰åˆ†ç»„</label>
                                    <div className="flex space-x-2">
                                        <input type="text" value={customTarget} onChange={e => setCustomTarget(e.target.value)} placeholder="è¾“å…¥åˆ†ç»„å..." className="flex-1 p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/>
                                        <button onClick={() => performMove(customTarget)} disabled={!customTarget.trim()} className="px-4 bg-indigo-600 text-white rounded-xl font-bold disabled:opacity-50">ç¡®å®š</button>
                                    </div>
                                </div>
                                <button onClick={() => setMoveModal({open:false, targetGroupWords:[]})} className="mt-6 w-full py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}

                    {editModal.open && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setEditModal({...editModal, open:false})}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-gray-800">ç¼–è¾‘åˆ†ç»„ä¿¡æ¯</h3>
                                <div className="mb-4">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">åˆ†ç»„åç§°</label>
                                    <input type="text" value={editModal.currentName} onChange={e => setEditModal({...editModal, currentName: e.target.value})} placeholder="ä¾‹å¦‚: 2010å¹´çœŸé¢˜é˜…è¯»A" className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" autoFocus />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">å¤‡æ³¨ / ç®€ä»‹</label>
                                    <textarea value={editModal.currentDesc} onChange={e => setEditModal({...editModal, currentDesc: e.target.value})} placeholder="ä¾‹å¦‚: è¿™éƒ¨åˆ†å•è¯æ¯”è¾ƒéš¾ï¼Œéœ€è¦å¤šå¤ä¹ å‡ æ¬¡..." className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none"></textarea>
                                </div>
                                <div className="flex space-x-3">
                                    <button onClick={() => setEditModal({...editModal, open:false})} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                                    <button onClick={saveGroupInfo} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StudySession = ({ words, setWords, sessionConfig, onExit, config, setChatSession }) => {
            const [queue, setQueue] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const now = Date.now();
                let q = [];
                const groupSize = config.groupSize || 208;
                if (sessionConfig.type === 'review') {
                    q = words.filter(w => w.stats && w.stats.nextReview <= now && w.stats.interval !== 0);
                    if(q.length === 0) q = words.filter(w => w.stats && w.stats.interval < 1 && w.stats.interval !== 0);
                    q = q.sort(() => Math.random() - 0.5).slice(0, 30);
                } else if (sessionConfig.type === 'group_study') {
                    const catWords = words.filter(w => (w.category || 'uncategorized') === sessionConfig.category);
                    const batchId = sessionConfig.batchId;
                    const batchWords = catWords.filter(w => (w.importId || 'default') === batchId);
                    const start = sessionConfig.batchIndex * groupSize;
                    const end = start + groupSize;
                    const targetGroup = batchWords.slice(start, end);
                    const newWords = targetGroup.filter(w => !w.stats || w.stats.interval === 0);
                    const reviewWords = targetGroup.filter(w => w.stats && w.stats.interval !== 0);
                    q = [...newWords, ...reviewWords];
                }
                setQueue(q);
            }, [sessionConfig]);

            useEffect(() => { if (queue.length > 0 && !isFinished && !isFlipped) { const word = queue[currentIdx]?.word; if (word) { const timer = setTimeout(() => playAudio(word), 300); return () => clearTimeout(timer); } } }, [currentIdx, queue, isFinished]);

            if (queue.length === 0 && !isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-green-100 p-6 rounded-full mb-6 text-green-600"><Icon name="Check" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-2">å½“å‰ä»»åŠ¡å®Œæˆ</h2><p className="text-gray-500 mb-8">ä¼‘æ¯ä¸€ä¸‹ï¼Œç¨åå†æ¥ï¼</p><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">è¿”å›é¦–é¡µ</button></div></div>;
            if (isFinished) return <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gray-50"><div className="bg-white p-10 rounded-3xl shadow-lg border border-gray-100 flex flex-col items-center max-w-sm w-full"><div className="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600"><Icon name="Sparkles" size={48}/></div><h2 className="text-2xl font-bold text-gray-800 mb-4">æœ¬è½®å­¦ä¹ ç»“æŸ ğŸ‰</h2><button onClick={onExit} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg font-bold transition transform active:scale-95">è¿”å›</button></div></div>;

            const currentCard = queue[currentIdx];
            const handleRating = (rating) => {
                const word = currentCard;
                const currentStats = word.stats || { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 };
                const result = calculateNextReview(rating, currentStats.interval, currentStats.easeFactor, currentStats.reviewCount);
                const newStats = { interval: result.interval, easeFactor: result.easeFactor, nextReview: Date.now() + (result.interval * 24 * 60 * 60 * 1000), reviewCount: result.reviewCount };
                const updatedWords = words.map(w => w.id === word.id ? { ...w, stats: newStats } : w);
                setWords(updatedWords);
                localStorage.setItem('kaoyan_vocab_list', JSON.stringify(updatedWords));
                if (result.isDueNow) setQueue(prev => [...prev, { ...word, stats: newStats, isRepeat: true }]);
                setIsFlipped(false); setTimeout(() => currentIdx + 1 >= queue.length ? setIsFinished(true) : setCurrentIdx(prev => prev + 1), 200);
            };
            const toggleMeaningMastery = (e, mIdx) => { e.stopPropagation(); const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], isMastered:!meanings[mIdx].isMastered, _forceShow:false}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); const newWords=[...words]; const idx=newWords.findIndex(w=>w.id===currentCard.id); if(idx!==-1){ newWords[idx]={...newWords[idx], meanings:meanings}; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); } };
            const toggleForceShow = (mIdx) => { const newQueue=[...queue]; const card={...newQueue[currentIdx]}; const meanings=[...card.meanings]; meanings[mIdx]={...meanings[mIdx], _forceShow:!meanings[mIdx]._forceShow}; card.meanings=meanings; newQueue[currentIdx]=card; setQueue(newQueue); };
            const generateSentence = async (e, meaningIndex) => {
                e.stopPropagation(); if (!config.apiKey) { alert("è¯·è®¾ç½® API Key"); return; } setIsGenerating(true);
                try {
                    const prompt = `English example sentence for "${currentCard.word}" meaning "${currentCard.meanings[meaningIndex].def}".`;
                    let newSentence = "";
                    if (config.type === 'google') { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({contents:[{parts:[{text:prompt}]}]}) }); const data = await res.json(); newSentence = data.candidates?.[0]?.content?.parts?.[0]?.text; }
                    else { let baseUrl = config.baseUrl.replace(/\/$/, ""); if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel") && !baseUrl.includes("lingyiwanwu") && !baseUrl.includes("siliconflow")) baseUrl += "/v1"; const res = await fetch(`${baseUrl}/chat/completions`, { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${config.apiKey}`}, body: JSON.stringify({model:config.model, messages:[{role:"user",content:prompt}]}) }); const data = await res.json(); newSentence = data.choices?.[0]?.message?.content; }
                    if(newSentence) { const s = newSentence.trim().replace(/^["']|["']$/g, ''); const newWords = [...words]; newWords.find(w => w.id === currentCard.id).meanings[meaningIndex].sentence = s; setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); const newQueue = [...queue]; newQueue[currentIdx].meanings[meaningIndex].sentence = s; setQueue(newQueue); }
                } catch(e){ alert(e.message); } finally { setIsGenerating(false); }
            };

            return (
                <div className="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
                    {/* é¡¶éƒ¨è¿›åº¦æ¡ */}
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gray-200 z-10">
                        <div className="h-full bg-indigo-600 transition-all duration-300 ease-out" style={{width: `${(currentIdx / queue.length) * 100}%`}}></div>
                    </div>
                    
                    {/* é€€å‡ºæŒ‰é’® - æ‚¬æµ®åœ¨å·¦ä¸Šè§’ */}
                    <button onClick={onExit} className="absolute top-4 left-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-600 hover:text-indigo-600 transition hover:bg-white" title="é€€å‡º"><Icon name="ArrowLeft" size={24}/></button>
                    
                    {/* AI Chat Button in Study Mode */}
                    <button onClick={(e)=>{e.stopPropagation(); setChatSession(currentCard.word);}} className="absolute top-4 right-4 z-20 p-2.5 bg-white/80 backdrop-blur rounded-full shadow-md text-indigo-500 hover:text-white hover:bg-indigo-500 transition" title="AI è¯¦è§£"><Icon name="MessageCircle" size={24}/></button>

                    {/* å¡ç‰‡å®¹å™¨ */}
                    <div className="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden">
                        <div className="relative scene w-full max-w-sm md:max-w-3xl aspect-[3/4] md:aspect-[4/3] max-h-[85vh]">
                            <div className={`card-object ${isFlipped ? 'is-flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                                {/* æ­£é¢ */}
                                <div className="card-face flex flex-col items-center justify-center p-8 md:p-12 text-center bg-gradient-to-br from-white to-gray-50 border border-white">
                                    <div className="flex-1 flex flex-col items-center justify-center w-full">
                                        <h1 className="text-5xl md:text-7xl lg:text-8xl font-black text-gray-800 mb-6 md:mb-10 tracking-tight">{currentCard.word}</h1>
                                        <div 
                                            className="flex items-center space-x-3 text-gray-500 bg-white border border-gray-200 shadow-sm px-5 py-2.5 rounded-full cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition transform hover:scale-105" 
                                            onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}}
                                        >
                                            <Icon name="Volume2" size={24} className="md:w-7 md:h-7"/>
                                            <span className="font-mono text-xl md:text-2xl">{currentCard.phonetic}</span>
                                        </div>
                                    </div>
                                    <div className="mt-auto text-gray-400 text-sm md:text-base animate-pulse font-medium">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹é‡Šä¹‰</div>
                                </div>

                                {/* èƒŒé¢ */}
                                <div className="card-face card-face-back p-0 bg-white">
                                    {/* é¡¶éƒ¨å•è¯æ  */}
                                    <div className="flex-shrink-0 bg-white/95 backdrop-blur border-b border-gray-100 p-4 md:p-6 flex justify-between items-center z-10 shadow-sm">
                                        <h2 className="text-2xl md:text-4xl font-bold text-indigo-900">{currentCard.word}</h2>
                                        <button onClick={(e)=>{e.stopPropagation();playAudio(currentCard.word);}} className="p-3 bg-indigo-50 rounded-full text-indigo-600 hover:bg-indigo-100 transition"><Icon name="Volume2" size={24}/></button>
                                    </div>
                                    
                                    {/* ä¸­é—´é‡Šä¹‰æ»šåŠ¨åŒº */}
                                    <div className="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-4 md:space-y-6">
                                        {currentCard.meanings.map((m, idx) => {
                                            const isHidden = m.isMastered && !m._forceShow;
                                            return (
                                                <div key={idx} className="relative p-5 md:p-6 bg-white rounded-2xl border border-gray-100 shadow-sm transition-all hover:shadow-md hover:border-indigo-100">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="text-xs md:text-sm font-bold bg-indigo-50 text-indigo-600 px-2.5 py-1 rounded-md uppercase tracking-wide">{m.pos}</span>
                                                        <button onClick={(e) => toggleMeaningMastery(e, idx)} className={`p-2 rounded-lg transition active:scale-95 ${m.isMastered ? 'text-gray-400 bg-gray-100' : 'text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50'}`}>{m.isMastered ? <Icon name="EyeOff" size={20} /> : <Icon name="Eye" size={20} />}</button>
                                                    </div>
                                                    <div className="mb-3 min-h-[1.5rem]">
                                                        {isHidden ? (
                                                            <div onClick={(e) => { e.stopPropagation(); toggleForceShow(idx); }} className="bg-gray-50 text-gray-400 text-sm py-4 px-4 rounded-xl cursor-pointer flex items-center justify-center select-none hover:bg-gray-100 transition border border-dashed border-gray-200">
                                                                <Icon name="EyeOff" size={16} className="mr-2"/> é‡Šä¹‰å·²éšè— (ç‚¹å‡»æŸ¥çœ‹)
                                                            </div>
                                                        ) : (
                                                            <div className="text-gray-800 font-medium text-lg md:text-2xl leading-relaxed">{m.def}</div>
                                                        )}
                                                    </div>
                                                    <div className="mt-4 pt-3 border-t border-gray-50">
                                                        {m.sentence ? 
                                                            <p className="text-sm md:text-lg text-gray-600 italic bg-gray-50 p-3 rounded-lg border-l-4 border-indigo-200">"{m.sentence}"</p> 
                                                            : 
                                                            <button onClick={(e) => generateSentence(e, idx)} className="group flex items-center gap-2 px-3 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition-all active:scale-95 w-fit">
                                                                <Icon name="Sparkles" size={16} />
                                                                <span className="text-xs md:text-sm font-bold whitespace-nowrap">AI ç”Ÿæˆä¾‹å¥</span>
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        <div className="h-20"></div> 
                                    </div>

                                    {/* åº•éƒ¨æŒ‰é’®æ  */}
                                    <div className="flex-shrink-0 absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 md:p-6 flex space-x-3 md:space-x-6 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.1)] z-20">
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(1);}} className="flex-1 btn-press bg-red-50 hover:bg-red-100 text-red-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-red-100"><span>ä¸è®¤è¯†</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(2);}} className="flex-1 btn-press bg-yellow-50 hover:bg-yellow-100 text-yellow-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-yellow-100"><span>ä¸ç†Ÿ</span></button>
                                        <button onClick={(e)=>{e.stopPropagation();handleRating(3);}} className="flex-1 btn-press bg-green-50 hover:bg-green-100 text-green-600 py-4 md:py-5 rounded-xl font-bold text-base md:text-lg flex flex-col items-center transition-colors border border-green-100"><span>è®¤è¯†</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

const ImportExport = ({ setWords, words, setView, config }) => {
            const [activeTab, setActiveTab] = useState('text');
            const [textInput, setTextInput] = useState('');
            const [importMode, setImportMode] = useState('frequency');
            const [importCategory, setImportCategory] = useState('high');
            const [customGroupName, setCustomGroupName] = useState('');
            const [isNewBatch, setIsNewBatch] = useState(false);
            const [importBatchName, setImportBatchName] = useState(''); 
            
            const [aiInput, setAiInput] = useState('');
            const [isFetching, setIsFetching] = useState(false);
            const [fetchProgress, setFetchProgress] = useState({ current: 0, total: 0, success: 0, fail: 0 });
            const [isSyncing, setIsSyncing] = useState(false); // åŒæ­¥çŠ¶æ€

            const getTargetCategory = () => { if (importMode === 'frequency') return importCategory; return customGroupName.trim() || `Import ${new Date().toLocaleDateString()}`; };
            
            const saveBatchMeta = (batchId) => {
                if (isNewBatch && importBatchName.trim()) {
                    try {
                        const metaStr = localStorage.getItem('kaoyan_group_meta');
                        const meta = metaStr ? JSON.parse(metaStr) : {};
                        meta[batchId] = { name: importBatchName.trim(), desc: "" };
                        localStorage.setItem('kaoyan_group_meta', JSON.stringify(meta));
                    } catch (e) { console.error(e); }
                }
            };

            // ... (è¿™é‡Œä¿ç•™ä¹‹å‰çš„ parseMultiPos å‡½æ•°) ...
            const parseMultiPos = (rawWord, fullText) => {
                let remains = fullText.substring(rawWord.length).trim();
                const parts = remains.split(/(?:^|\s+)([a-z]{1,5}\.)\s+/).filter(p => p.trim());
                const meanings = [];
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.match(/^[a-z]{1,5}\.$/)) {
                        const def = parts[i+1] || "";
                        meanings.push({ pos: part, def: def.trim(), sentence: "", isMastered: false });
                        i++;
                    } else {
                        if(i === 0) meanings.push({ pos: "mix.", def: part.trim(), sentence: "", isMastered: false });
                    }
                }
                return meanings;
            };

            const parseAndImport = () => { 
                if(!textInput.trim()) return;
                const targetCat = getTargetCategory(); const segments = textInput.split(/[;\n]+/);
                let addedCount = 0, mergedCount = 0; let currentWords = JSON.parse(JSON.stringify(words)); let lastWordId = null; 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default';
                saveBatchMeta(batchId);
                segments.forEach((seg, idx) => {
                    seg = seg.trim(); if (!seg) return;
                    const matchHead = seg.match(/^([a-zA-Z\-\s]+?)\s+/);
                    if (matchHead) {
                        const rawWord = matchHead[1].trim();
                        const parsedMeanings = parseMultiPos(rawWord, seg);
                        if (parsedMeanings.length > 0) {
                            const existingIdx = currentWords.findIndex(w => w.word.toLowerCase() === rawWord.toLowerCase());
                            if (!isNewBatch && existingIdx !== -1) { 
                                const existingWord = currentWords[existingIdx]; lastWordId = existingWord.id; 
                                parsedMeanings.forEach(nm => { if (!existingWord.meanings.some(om => om.pos === nm.pos && om.def === nm.def)) existingWord.meanings.push(nm); });
                                mergedCount++; 
                            } else { 
                                const newId = `auto-${Date.now()}-${idx}-${Math.random().toString(36).substr(2,5)}`; 
                                currentWords.push({ id: newId, word: rawWord, phonetic: "", category: targetCat, importId: batchId, meanings: parsedMeanings, stats: { interval: 0, easeFactor: 2.5, nextReview: 0, reviewCount: 0 } }); 
                                lastWordId = newId; addedCount++; 
                            }
                        }
                    }
                });
                if (addedCount > 0 || mergedCount > 0) { setWords(currentWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords)); alert(`å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${addedCount}, åˆå¹¶: ${mergedCount}`); setTextInput(''); setImportBatchName(''); } else alert("æ ¼å¼é”™è¯¯");
            };

            const repairData = () => {
                let fixedCount = 0;
                const newWords = words.map(w => {
                    let needsFix = false; let newMeanings = [];
                    w.meanings.forEach(m => {
                        const parts = m.def.split(/\s+([a-z]{1,4}\.)\s+/);
                        if (parts.length > 1) { needsFix = true; newMeanings.push({ ...m, def: parts[0].trim() }); for (let i = 1; i < parts.length; i += 2) if (parts[i+1]) newMeanings.push({ pos: parts[i], def: parts[i+1].trim(), sentence: "", isMastered: false }); } else newMeanings.push(m);
                    });
                    if (needsFix) { fixedCount++; return { ...w, meanings: newMeanings }; } return w;
                });
                if (fixedCount > 0) { setWords(newWords); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(newWords)); alert(`ğŸ‰ ä¿®å¤æˆåŠŸï¼æ•´ç†äº† ${fixedCount} ä¸ªå•è¯ã€‚`); } else alert("æš‚æœªå‘ç°æ ¼å¼é”™ä¹±çš„å•è¯ã€‚");
            };

            const fetchWordsFromAI = async () => {
                if (!config.apiKey) { alert("è¯·é…ç½® Key"); return; } if (!aiInput.trim()) return; const wordList = aiInput.split(/[\s,\n]+/).filter(w => w.trim().match(/^[a-zA-Z\-]+$/)); if(wordList.length===0) return;
                setIsFetching(true); setFetchProgress({ current: 0, total: wordList.length, success: 0, fail: 0 }); const targetCat = getTargetCategory(); 
                const batchId = isNewBatch ? `batch-${Date.now()}` : 'default'; saveBatchMeta(batchId);
                const BATCH_SIZE = 5; let currentWords = JSON.parse(JSON.stringify(words)); let successCount = 0; let failCount = 0;
                for (let i = 0; i < wordList.length; i += BATCH_SIZE) {
                    const batch = wordList.slice(i, i + BATCH_SIZE); const batchStr = batch.join(", "); const prompt = `è€ƒç ”å•è¯æŸ¥è¯¢JSON:[${batchStr}]`;
                    try {
                        let jsonStr=""; if(config.type==='google'){ const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})}); const data=await res.json(); jsonStr=data.candidates?.[0]?.content?.parts?.[0]?.text; } else { let baseUrl=config.baseUrl.replace(/\/$/,""); if(!baseUrl.includes("/v1")&&!baseUrl.includes("aliyuncs")&&!baseUrl.includes("bigmodel")&&!baseUrl.includes("lingyiwanwu")&&!baseUrl.includes("siliconflow"))baseUrl+="/v1"; const res=await fetch(`${baseUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${config.apiKey}`},body:JSON.stringify({model:config.model,messages:[{role:"user",content:prompt}]})}); const data=await res.json(); jsonStr=data.choices?.[0]?.message?.content; }
                        if(!jsonStr) throw new Error("Empty"); jsonStr=jsonStr.replace(/```json/g,'').replace(/```/g,'').trim(); const parsedBatch=JSON.parse(jsonStr);
                        if(Array.isArray(parsedBatch)){ parsedBatch.forEach(item=>{ const existIdx=currentWords.findIndex(w=>w.word.toLowerCase()===item.word.toLowerCase()); const meanings=item.meanings.map(m=>({...m,sentence:"",isMastered:false})); if(!isNewBatch && existIdx!==-1){ item.meanings.forEach(nm=>{ if(!currentWords[existIdx].meanings.some(om=>om.pos===nm.pos && om.def===nm.def)) currentWords[existIdx].meanings.push({...nm,sentence:"",isMastered:false}); }); }else{ currentWords.push({id:`ai-${Date.now()}-${Math.random()}`,word:item.word,phonetic:item.phonetic||"",category:targetCat,importId:batchId,meanings,stats:{interval:0,easeFactor:2.5,nextReview:0,reviewCount:0}}); } }); successCount+=batch.length; }
                    } catch(err){ failCount+=batch.length; }
                    setFetchProgress({ current: Math.min(i+BATCH_SIZE, wordList.length), total: wordList.length, success: successCount, fail: failCount }); setWords([...currentWords]); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(currentWords));
                } setIsFetching(false); alert("å®Œæˆ"); setImportBatchName('');
            };

            const handleFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const content = JSON.parse(ev.target.result); if (content.type === 'KAOYAN_FULL_BACKUP' && content.storage) { if(confirm(`æ¢å¤å¤‡ä»½å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ`)) { Object.keys(content.storage).forEach(key => { if(key.startsWith('kaoyan_')) localStorage.setItem(key, content.storage[key]); }); window.location.reload(); } return; } if (Array.isArray(content)) { if(confirm(`å¯¼å…¥æ—§ç‰ˆå•è¯è¡¨?`)) { setWords(content); localStorage.setItem('kaoyan_vocab_list', JSON.stringify(content)); alert("å®Œæˆ"); } return; } } catch(err) { alert("é”™è¯¯"); } }; reader.readAsText(file); };
            
            const exportFullData = () => { const storage = {}; for(let i=0; i<localStorage.length; i++) { const key = localStorage.key(i); if(key && key.startsWith('kaoyan_')) storage[key] = localStorage.getItem(key); } const backup = { type: 'KAOYAN_FULL_BACKUP', version: 1.0, timestamp: Date.now(), storage }; const blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); a.download = `è€ƒç ”è¯æ±‡_å¤‡ä»½_${date.getFullYear()}${date.getMonth()+1}${date.getDate()}.json`; a.click(); };

            // --- äº‘åŒæ­¥æ ¸å¿ƒé€»è¾‘ ---
            const syncToCloud = async () => {
                if (!config.jsonbinKey || !config.jsonbinId) { alert("è¯·å…ˆå»[è®¾ç½®]é¡µé¢é…ç½® JSONBin çš„ Key å’Œ ID"); return; }
                if (!confirm("âš ï¸ è­¦å‘Šï¼šä¸Šä¼ å°†è¦†ç›–äº‘ç«¯æ—§æ•°æ®ï¼\n\nç¡®å®šè¦å°†å½“å‰æ‰‹æœºä¸Šçš„æ‰€æœ‰æ•°æ®æ¨é€åˆ°äº‘ç«¯å—ï¼Ÿ")) return;
                
                setIsSyncing(true);
                try {
                    // 1. æ‰“åŒ…æœ¬åœ°æ•°æ®
                    const storage = {}; 
                    for(let i=0; i<localStorage.length; i++) { 
                        const key = localStorage.key(i); 
                        if(key && key.startsWith('kaoyan_')) storage[key] = localStorage.getItem(key); 
                    }
                    const backup = { type: 'KAOYAN_CLOUD_SYNC', timestamp: Date.now(), storage };

                    // 2. æ¨é€
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbinId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': config.jsonbinKey
                        },
                        body: JSON.stringify(backup)
                    });

                    if (!res.ok) throw new Error(`ä¸Šä¼ å¤±è´¥: ${res.status}`);
                    alert("âœ… ä¸Šä¼ æˆåŠŸï¼\n\nç°åœ¨ä½ å¯ä»¥åœ¨å¦ä¸€å°è®¾å¤‡ä¸Šç‚¹å‡»[ä¸‹è½½]äº†ã€‚");
                } catch (e) {
                    alert("åŒæ­¥é”™è¯¯: " + e.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            const syncFromCloud = async () => {
                if (!config.jsonbinKey || !config.jsonbinId) { alert("è¯·å…ˆå»[è®¾ç½®]é¡µé¢é…ç½® JSONBin çš„ Key å’Œ ID"); return; }
                if (!confirm("âš ï¸ è­¦å‘Šï¼šä¸‹è½½å°†è¦†ç›–æœ¬åœ°å½“å‰æ•°æ®ï¼\n\nç¡®å®šè¦ä»äº‘ç«¯æ‹‰å–æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;

                setIsSyncing(true);
                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbinId}/latest`, {
                        method: 'GET',
                        headers: { 'X-Master-Key': config.jsonbinKey }
                    });

                    if (!res.ok) throw new Error(`ä¸‹è½½å¤±è´¥: ${res.status}`);
                    const json = await res.json();
                    const data = json.record;

                    if (data && data.storage) {
                        // æ¢å¤æ•°æ®
                        Object.keys(data.storage).forEach(key => {
                            if(key.startsWith('kaoyan_')) localStorage.setItem(key, data.storage[key]);
                        });
                        const dateStr = new Date(data.timestamp).toLocaleString();
                        alert(`âœ… åŒæ­¥æˆåŠŸï¼\næ•°æ®ç‰ˆæœ¬: ${dateStr}\n\né¡µé¢å³å°†åˆ·æ–°...`);
                        window.location.reload();
                    } else {
                        alert("äº‘ç«¯æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
                    }
                } catch (e) {
                    alert("åŒæ­¥é”™è¯¯: " + e.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">æ•°æ®ä¸­å¿ƒ</h2>
                        <div className="flex mb-6 border-b border-gray-100">
                            <button onClick={() => setActiveTab('ai')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='ai'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>AI é€ŸæŸ¥</button>
                            <button onClick={() => setActiveTab('text')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='text'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>æ‰¹é‡ç²˜è´´</button>
                            <button onClick={() => setActiveTab('data')} className={`flex-1 pb-3 text-sm md:text-base font-bold transition-colors border-b-2 ${activeTab==='data'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>ç®¡ç†ä¸åŒæ­¥</button>
                        </div>
                        
                        {(activeTab === 'ai' || activeTab === 'text') && (
                            <div className="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <div className="flex space-x-6 mb-4">
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='frequency'} onChange={()=>setImportMode('frequency')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">å­˜å…¥è€ƒé¢‘</span></label>
                                    <label className="flex items-center cursor-pointer"><input type="radio" checked={importMode==='group'} onChange={()=>setImportMode('group')} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-medium">è‡ªå®šä¹‰åˆ†ç»„</span></label>
                                </div>
                                {importMode==='frequency' ? (<div className="grid grid-cols-4 gap-2 mb-4">{['high','medium','low','zero'].map(cat=>(<button key={cat} onClick={()=>setImportCategory(cat)} className={`py-2 text-sm rounded-lg border ${importCategory===cat?'bg-indigo-600 text-white':'bg-white text-gray-600'}`}>{cat}</button>))}</div>) : (<div className="mb-4"><input type="text" value={customGroupName} onChange={e=>setCustomGroupName(e.target.value)} placeholder="è¾“å…¥åˆ†ç»„åç§°" className="w-full p-3 border rounded-lg text-sm outline-none"/></div>)}
                                <label className="flex items-center pt-4 border-t border-gray-200 cursor-pointer"><input type="checkbox" checked={isNewBatch} onChange={e=>setIsNewBatch(e.target.checked)} className="w-4 h-4 text-indigo-600"/><span className="ml-2 text-sm font-bold text-gray-700">ç‹¬ç«‹ä¸ºæ–°æ‰¹æ¬¡</span></label>
                                {isNewBatch && (<div className="mt-4 animate-fade-in"><input type="text" value={importBatchName} onChange={e=>setImportBatchName(e.target.value)} placeholder="ä¾‹å¦‚: 2015çœŸé¢˜" className="w-full p-3 border border-indigo-200 bg-indigo-50 rounded-lg text-sm outline-none"/></div>)}
                            </div>
                        )}

                        {activeTab === 'ai' && (<div className="space-y-4"><textarea value={aiInput} onChange={e => setAiInput(e.target.value)} placeholder="è¾“å…¥å•è¯..." className="w-full h-40 p-4 border rounded-xl text-sm outline-none resize-none"></textarea>{isFetching ? <div className="text-center text-sm py-3 bg-indigo-50 text-indigo-600 rounded-xl animate-pulse">AI æŠ“å–ä¸­...</div> : <button onClick={fetchWordsFromAI} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Icon name="CloudDownload" size={20}/> å¼€å§‹</button>}</div>)}
                        {activeTab === 'text' && (<div className="space-y-4"><textarea value={textInput} onChange={e => setTextInput(e.target.value)} placeholder="æ ¼å¼ï¼šword n. é‡Šä¹‰ v. é‡Šä¹‰..." className="w-full h-48 p-4 border rounded-xl text-sm outline-none resize-none"></textarea><button onClick={parseAndImport} className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">å¼€å§‹å¯¼å…¥</button></div>)}
                        
                        {activeTab === 'data' && (
                            <div className="space-y-6 animate-fade-in">
                                {/* äº‘åŒæ­¥åŒºåŸŸ */}
                                <div className="p-6 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl text-white shadow-lg">
                                    <div className="flex items-center mb-4"><Icon name="CloudDownload" size={24} className="mr-2"/><h3 className="font-bold text-lg">äº‘ç«¯æ— ç¼åŒæ­¥</h3></div>
                                    <p className="text-indigo-100 text-xs mb-6 opacity-90">å°†å½“å‰è¿›åº¦åŒæ­¥åˆ°äº‘ç«¯ï¼Œæˆ–ä»äº‘ç«¯æ‹‰å–æœ€æ–°è¿›åº¦ã€‚è¯·ç¡®ä¿å·²åœ¨è®¾ç½®ä¸­é…ç½® JSONBinã€‚</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={syncToCloud} disabled={isSyncing} className="py-3 bg-white/20 hover:bg-white/30 border border-white/30 rounded-xl font-bold backdrop-blur-sm transition flex flex-col items-center justify-center">
                                            {isSyncing ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mb-1"></div> : <Icon name="Upload" size={20} className="mb-1"/>}
                                            <span className="text-xs">ä¸Šä¼ è‡³äº‘ç«¯</span>
                                        </button>
                                        <button onClick={syncFromCloud} disabled={isSyncing} className="py-3 bg-white text-indigo-600 hover:bg-gray-50 rounded-xl font-bold shadow-sm transition flex flex-col items-center justify-center">
                                            {isSyncing ? <div className="w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mb-1"></div> : <Icon name="Download" size={20} className="mb-1"/>}
                                            <span className="text-xs">ä»äº‘ç«¯ä¸‹è½½</span>
                                        </button>
                                    </div>
                                </div>

                                {/* ä¿®å¤å·¥å…· */}
                                <div className="p-5 bg-orange-50 border border-orange-100 rounded-2xl flex justify-between items-center">
                                    <div><h3 className="font-bold text-orange-900 text-sm mb-1">è¯æ€§æ ¼å¼ä¿®å¤</h3><p className="text-xs text-orange-700/70">è‡ªåŠ¨æ‹†åˆ† v. adj. ç­‰è¿åœ¨ä¸€èµ·çš„é‡Šä¹‰</p></div>
                                    <button onClick={repairData} className="px-4 py-2 bg-white text-orange-600 border border-orange-200 rounded-lg font-bold text-xs shadow-sm hover:bg-orange-100">ğŸ› ï¸ ä¿®å¤</button>
                                </div>

                                {/* æœ¬åœ°å¤‡ä»½ */}
                                <div className="grid grid-cols-2 gap-4 pt-2">
                                    <button onClick={exportFullData} className="py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-sm flex items-center justify-center"><Icon name="Download" size={16} className="mr-2"/> å¯¼å‡ºæ–‡ä»¶</button>
                                    <div className="relative">
                                        <button className="w-full h-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-sm flex items-center justify-center"><Icon name="Upload" size={16} className="mr-2"/> æ¢å¤æ–‡ä»¶</button>
                                        <input type="file" onChange={handleFile} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-100 text-center">
                                    <button onClick={() => {if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) { setWords([]); localStorage.clear(); window.location.reload(); }}} className="text-red-400 text-xs hover:text-red-600 underline">é‡ç½®åº”ç”¨ (æ¸…ç©ºæ•°æ®)</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

      const SettingsPanel = ({ config, setConfig, setView }) => {
            const [selectedPreset, setSelectedPreset] = useState('deepseek');
            const [modelList, setModelList] = useState([]);
            const [modelSearch, setModelSearch] = useState('');
            const [isFetchingModels, setIsFetchingModels] = useState(false);

            useEffect(() => {
                const matchedKey = Object.keys(API_PRESETS).find(key => {
                    const preset = API_PRESETS[key];
                    return preset.type === config.type && (preset.type === 'google' || config.baseUrl.includes(preset.url));
                });
                if (matchedKey) setSelectedPreset(matchedKey); else setSelectedPreset('custom');
            }, []);

            const handlePresetChange = (key) => {
                setSelectedPreset(key);
                const preset = API_PRESETS[key];
                setConfig(prev => ({ ...prev, type: preset.type, baseUrl: preset.url }));
                setModelList([]);
            };

            const fetchModels = async () => {
                if (!config.apiKey) { alert("è¯·å…ˆå¡«å†™ API Key"); return; }
                setIsFetchingModels(true);
                setModelList([]);
                try {
                    let fetchedModels = [];
                    if (config.type === 'google') {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${config.apiKey}`);
                        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                        const data = await res.json();
                        if (data.models) fetchedModels = data.models.map(m => m.name.replace(/^models\//, ''));
                    } else {
                        let baseUrl = config.baseUrl.replace(/\/$/, "");
                        if (!baseUrl.includes("/v1") && !baseUrl.includes("aliyuncs") && !baseUrl.includes("bigmodel") && !baseUrl.includes("lingyiwanwu") && !baseUrl.includes("siliconflow")) baseUrl += "/v1";
                        const res = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${config.apiKey}` } });
                        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                        const data = await res.json();
                        if (data.data && Array.isArray(data.data)) fetchedModels = data.data.map(m => m.id);
                    }
                    if (fetchedModels.length > 0) { setModelList(fetchedModels); alert(`æˆåŠŸè·å– ${fetchedModels.length} ä¸ªæ¨¡å‹ï¼`); } 
                    else alert("æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨");
                } catch (e) { alert(`è·å–å¤±è´¥: ${e.message}`); } 
                finally { setIsFetchingModels(false); }
            };

            const filteredModels = modelList.filter(m => m.toLowerCase().includes(modelSearch.toLowerCase()));

            return (
                <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 p-4 flex justify-center">
                    <div className="w-full max-w-xl bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit space-y-8">
                        
                        {/* 1. AI è®¾ç½®åŒºåŸŸ */}
                        <div className="space-y-6">
                            <h2 className="text-xl font-bold border-b border-gray-100 pb-2 text-gray-800 flex items-center"><Icon name="Brain" size={22} className="mr-2 text-indigo-600"/> AI è®¾ç½®</h2>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">æœåŠ¡å•†</label>
                                <div className="relative">
                                    <select value={selectedPreset} onChange={(e) => handlePresetChange(e.target.value)} className="w-full border border-gray-200 p-3 rounded-xl appearance-none bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                        {Object.entries(API_PRESETS).map(([key, val]) => (<option key={key} value={key}>{val.name}</option>))}
                                    </select>
                                    <div className="absolute right-3 top-3.5 text-gray-400 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg></div>
                                </div>
                            </div>

                            <div className={selectedPreset === 'google' ? 'hidden' : 'block'}>
                                <label className="block text-sm font-bold text-gray-700 mb-2">API Endpoint</label>
                                <input value={config.baseUrl} onChange={e => setConfig({...config, baseUrl: e.target.value})} className={`w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition ${selectedPreset !== 'custom' ? 'bg-gray-100 text-gray-500' : 'bg-gray-50'}`} disabled={selectedPreset !== 'custom'}/>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">API Key</label>
                                <input value={config.apiKey} onChange={e => setConfig({...config, apiKey: e.target.value})} type="password" placeholder="sk-..." className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono"/>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-bold text-gray-700">æ¨¡å‹åç§°</label>
                                    <button onClick={fetchModels} disabled={isFetchingModels || !config.apiKey} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-medium hover:bg-indigo-100 transition disabled:opacity-50">{isFetchingModels ? "è·å–ä¸­..." : "è·å–åˆ—è¡¨"}</button>
                                </div>
                                <input value={config.model} onChange={e => setConfig({...config, model: e.target.value})} placeholder="ä¾‹å¦‚: deepseek-chat" className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono"/>
                            </div>
                        </div>

                        {/* 2. äº‘åŒæ­¥è®¾ç½®åŒºåŸŸ (æ–°å¢) */}
                        <div className="space-y-6 pt-2">
                            <h2 className="text-xl font-bold border-b border-gray-100 pb-2 text-gray-800 flex items-center"><Icon name="CloudDownload" size={22} className="mr-2 text-indigo-600"/> äº‘åŒæ­¥è®¾ç½® (JSONBin)</h2>
                            <div className="bg-indigo-50 p-3 rounded-lg text-xs text-indigo-800 leading-relaxed">
                                è¿™æ˜¯ä¸€ä¸ªå…è´¹çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ³¨å†Œ JSONBin.io åå¡«å…¥ä¿¡æ¯ï¼Œå³å¯å®ç°å¤šç«¯åŒæ­¥ã€‚
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Master Key (X-Master-Key)</label>
                                <input value={config.jsonbinKey || ''} onChange={e => setConfig({...config, jsonbinKey: e.target.value})} type="password" placeholder="$2b$10..." className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono"/>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Bin ID</label>
                                <input value={config.jsonbinId || ''} onChange={e => setConfig({...config, jsonbinId: e.target.value})} placeholder="656..." className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono"/>
                            </div>
                        </div>

                        {/* 3. å…¶ä»–è®¾ç½® */}
                        <div className="space-y-6 pt-2">
                            <h2 className="text-xl font-bold border-b border-gray-100 pb-2 text-gray-800 flex items-center"><Icon name="Settings" size={22} className="mr-2 text-indigo-600"/> å…¶ä»–</h2>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">å•ç»„å•è¯é‡</label>
                                <input type="number" value={config.groupSize || 208} onChange={e => setConfig({...config, groupSize: parseInt(e.target.value)||208})} className="w-full border border-gray-200 p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition"/>
                            </div>
                        </div>

                        <button onClick={()=>{ localStorage.setItem('kaoyan_config', JSON.stringify(config)); setView('home'); }} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition transform active:scale-[0.98]">ä¿å­˜å¹¶è¿”å›</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [words, setWords] = useState([]);
            const [sessionConfig, setSessionConfig] = useState({}); 
            const [config, setConfig] = useState({ type: 'openai', baseUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat', groupSize: 208 });
            const [chatSession, setChatSession] = useState(null); // null or word string

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('kaoyan_vocab_list');
                    const savedCfg = localStorage.getItem('kaoyan_config');
                    if (saved) setWords(JSON.parse(saved));
                    if (savedCfg) setConfig(JSON.parse(savedCfg));
                } catch(e) { console.error("Data load fail", e); }
                // Remove spinner once React mounts
                const loader = document.getElementById('root').querySelector('div');
                if(loader && loader.style.border) loader.remove(); 
            }, []);

            const handleBack = () => {
                if (view === 'study') {
                    if (sessionConfig.type === 'group_study') setView('group_list');
                    else setView('home');
                } else if (view === 'group_list') {
                    setView('home');
                } else {
                    setView('home');
                }
            };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <Navbar view={view} setView={setView} goBack={handleBack} />
                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        {view === 'home' && <Dashboard words={words} setView={setView} setSessionConfig={setSessionConfig} />}
                        {view === 'group_list' && <GroupList words={words} setWords={setWords} category={sessionConfig.category} setView={setView} setSessionConfig={setSessionConfig} config={config} />}
                        {view === 'study' && <StudySession words={words} setWords={setWords} sessionConfig={sessionConfig} onExit={handleBack} config={config} setChatSession={setChatSession} />}
                        {view === 'list' && <WordListMode words={words} setWords={setWords} setChatSession={setChatSession} />}
                        {view === 'import' && <ImportExport setWords={setWords} words={words} setView={setView} config={config} />}
                        {view === 'settings' && <SettingsPanel config={config} setConfig={setConfig} setView={setView} />}
                        
                        {/* Chat Overlay */}
                        {chatSession && (
                            <div className="absolute inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in">
                                <WordChat 
                                    word={chatSession} 
                                    onClose={() => setChatSession(null)} 
                                    config={config} 
                                />
                            </div>
                        )}
                    </main>
                    <style>{`
                        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
                        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
                        .animate-fade-in { animation: fade-in 0.2s ease-out; }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
